<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; padding: 16px; }
    button { padding: 8px 16px; margin-right: 8px; }
    textarea { width: 100%; height: 200px; margin-top: 12px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ğŸ™ï¸ Record Meeting</h2>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
  

  <textarea id="textArea" placeholder="Transcript and summary will appear here..."></textarea>

  <script>

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const textArea = document.getElementById('textArea');

    let recorder;
    let chunks = [];

    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get("session");
    const autoStart = urlParams.get("start") === "true";

    console.log("ğŸ“ Extracted sessionId:", sessionId);

    startBtn.onclick = startRecording;
    stopBtn.onclick = stopRecording;

    if (autoStart) startRecording();

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        chunks = [];

        recorder.ondataavailable = (e) => chunks.push(e.data);

        recorder.onstop = async () => {
          console.log("ğŸ¯ Recording stopped");

          const blob = new Blob(chunks, { type: 'audio/webm' });
          if (blob.size === 0) {
            textArea.value = 'âŒ No audio recorded.';
            return;
          }

          textArea.value = 'ğŸ”„ Uploading and analyzing...';

          const form = new FormData();
          form.append('file', blob, 'audio.webm');

          try {
            const res = await fetch('https://fyp-2025-kath.vercel.app/api/analyze', {
              method: 'POST',
              body: form
            });

            const result = await res.json();
            console.log("âœ… Analysis result:", result);

            textArea.value = `ğŸ“ Transcript:\n${result.transcript}\n\nğŸ§  Summary:\n${result.summary}`;

            await fetch('https://fyp-2025-kath.vercel.app/api/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                session: sessionId,
                transcript: result.transcript,
                summary: result.summary
              })
            });

            console.log("ğŸ“¦ Saved to session:", sessionId);

          } catch (err) {
            console.error('âŒ Analysis or save failed:', err);
            textArea.value = 'âŒ Failed to analyze or save result.';
          }

          startBtn.disabled = false;
          stopBtn.disabled = true;
        };

        recorder.start();
        textArea.value = 'ğŸ™ï¸ Recording...';
        startBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (err) {
        console.error('âŒ Microphone access error:', err);
        textArea.value = 'âŒ Could not access microphone.';
      }
    }

    function stopRecording() {
      if (recorder && recorder.state === 'recording') {
        recorder.stop();
      } 
    }
  //   // âœ… å¤–éƒ¨æ§åˆ¶çš„ç›‘å¬å™¨ï¼ˆui.html å‘é€ postMessage æ§åˆ¶ï¼‰
  // window.addEventListener('message', (event) => {
  //   const { type } = event.data;
  //   if (type === 'start-recording') startRecording();
  //   if (type === 'stop-recording') stopRecording();  
  // });

  // // âœ… é€šçŸ¥æ’ä»¶ UIï¼šæˆ‘å·²ç»å‡†å¤‡å¥½äº†
  // window.onload = () => {
  //   window.opener?.postMessage({ type: 'ready-to-record' }, '*');
  //   console.log("ğŸ“¤ record.html sent ready-to-record");
  // };
  </script>
</body>
</html>

