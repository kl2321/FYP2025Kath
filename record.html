<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; padding: 16px; }
    button { padding: 8px 16px; margin-right: 8px; }
    textarea { width: 100%; height: 200px; margin-top: 12px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>🎙️ Record Meeting</h2>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
  

  <textarea id="textArea" placeholder="Transcript and summary will appear here..."></textarea>

  <script>

    let totalSeconds = 0;
    let sessionStartTime = null;

    const fullTranscriptHistory =[];


    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const textArea = document.getElementById('textArea');
    

    let recorder;
    let chunks = [];

    const transcriptChunks = [];
    let recordingCycleCount = 0;
    const MAX_CYCLE = 2; // 30s * 10 = 5min
    let isManuallyStopped = false;

    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get("session");
    const autoStart = urlParams.get("start") === "true";

    console.log("📎 Extracted sessionId:", sessionId);

    //startBtn.onclick = startRecording;
    //stopBtn.onclick = stopRecording;

    if (autoStart) {
      console.log("⚙️ Auto-start triggered");
      //isManuallyStopped = false;
      startBtn.onclick();
      // isManuallyStopped = false;
      // recordingCycleCount = 0;
      // transcriptChunks.length = 0;
      // sessionStartTime = Date.now();
      // startSegmentRecording();
    }

    startBtn.onclick = () => {
      //isManuallyStopped = false;
      // if (recordingCycleCount === 0) {
      //   isManuallyStopped = false;
      // };
      transcriptChunks.length = 0;
      sessionStartTime = Date.now();
      totalSeconds = 0;
      startSegmentRecording();
    };
    
    stopBtn.onclick = () => {
      isManuallyStopped = true;
      stopRecording();
    };

    //if (autoStart) startRecording();

   async function startSegmentRecording() {
    if (isManuallyStopped) {
      console.log("🛑 Manually stopped, summarizing...");
      //console.log("🎯 isManuallyStopped:", isManuallyStopped);
      await summarizeChunks();
      return;
    }

    if (recordingCycleCount >= MAX_CYCLE) {
      console.log("⏰ Reached minute limit. Summarizing and continuing...")
      await summarizeChunks();
      recordingCycleCount =0;
      transcriptChunks.length =0;
      if (!isManuallyStopped) {
        startSegmentRecording();
      }
      return;
    }
    await startRecording();
    setTimeout(() => {
      if (!isManuallyStopped) {
        stopRecording();
      }
    }, 30000); // 每段 30 秒
  }  
    
    
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        chunks = [];

        recorder.ondataavailable = (e) => chunks.push(e.data);

        recorder.onstop = async () => {
          console.log(" Recording stopped");
          console.log("🎯 isManuallyStopped:", isManuallyStopped);
          await handleSegmentAnalysis();
          if (isManuallyStopped || recordingCycleCount >= MAX_CYCLE) {
            await summarizeChunks();
          } else {
            startSegmentRecording();
          }
        };
        recorder.start();
        textArea.value = '🎙️ Recording...';
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
    console.error('❌ Microphone error:', err);
    textArea.value = '❌ Microphone access denied.';
  }
}


      function stopRecording() {
        //isManuallyStopped = true;

        if (recorder && recorder.state === 'recording') {
          recorder.stop();
        } else if (recordingCycleCount > 0) {
          summarizeChunks();
        }
      }

      async function handleSegmentAnalysis() {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        if (blob.size === 0) {
          textArea.value = '❌ No audio recorded.';
          return;
        }

        textArea.value = '🔄 Uploading and analyzing...';

        const form = new FormData();
        form.append('file', blob, 'audio.webm');

        try {
          const res = await fetch('https://fyp-2025-kath.vercel.app/api/analyze', {
            method: 'POST',
            body: form
          });

           const result = await res.json();
          console.log("✅ Analysis result:", result);

          transcriptChunks.push(result.transcript || '');
          recordingCycleCount++;

          const durationMin = Math.floor((Date.now() - sessionStartTime) / 60000);
          textArea.value = `⏱️ Total time: ${durationMin} min\n✅ Segment ${recordingCycleCount} done`;
        } catch (err) {
          console.error('❌ Analysis failed:', err);
          textArea.value = '❌ Failed to analyze this chunk.';
        }
      }

      async function summarizeChunks() {
        const currentCombined = transcriptChunks.join('\n');
        fullTranscriptHistory.push(currentCombined);
        const combined=fullTranscriptHistory.join('\n');
        const duration = Math.floor((Date.now() - sessionStartTime) / 60000);
        textArea.value = `🧠 Summarizing full content... (${duration} min)`;

        try {
          const res = await fetch('https://fyp-2025-kath.vercel.app/api/summarize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: combined })
          });
          const data = await res.json();
          console.log("🧠 Full transcript sent to summarizer:\n", combined);


          textArea.value = `⏱️ ${duration} min transcript:\n${combined}\n\n🧠 Summary:\n${data.summary}`;

          // window.opener?.postMessage({
          //   pluginMessage: {
          //     type:'analyze-transcript',
          //     transcript: combined,
          //     summary:data.summary
          //   }
          // }, '*');

          // 可选：保存整段到 Supabase
          await fetch('https://fyp-2025-kath.vercel.app/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session: sessionId,
              transcript: combined,
              summary: data.summary
            })
          });

          console.log("📦 Full result saved.");

          // begin the next 5mins loop
          if (!isManuallyStopped) {
            console.log("🔁 Restarting next 5-minute cycle...");
            recordingCycleCount = 0;
            transcriptChunks.length = 0;
            startSegmentRecording(); // ✅ 继续循环
          }
        } catch (err) {
          console.error("❌ Final summary error:", err);
          textArea.value = '❌ Final summary failed.';
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

    function pollStop(sessionId) {
      console.log("🔁 Starting pollStop for sessionId:", sessionId);
      const interval = setInterval(async () => {
        const url = `https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals?session_id=eq.${sessionId}&command=eq.stop`;

        try {
          const res = await fetch(url, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Content-Type': 'application/json'
            }
          });

          if (!res.ok) {
            const error = await res.text();
            console.error("❌ Supabase fetch failed:", error);
            return;
          }

          const data = await res.json();
          console.log("📡 poll result:", data);

          if (Array.isArray(data) && data.length > 0) {
            clearInterval(interval);
            console.log("🛑 Stop command received. Stopping recorder...");
            stopRecording();
          }
        } catch (err) {
          console.error("❌ Polling error:", err);
        }
      }, 1000);
    }
    if (sessionId) {
      pollStop(sessionId);
  }

  window.onload = () => {
    window.opener?.postMessage({ type: 'ready-to-record' }, '*');
    console.log("📤 record.html sent ready-to-record");
  };
    // ✅ 外部控制的监听器（ui.html 发送 postMessage 控制）
  window.addEventListener('message', (event) => {
    const { type } = event.data;
    if (type === 'start-recording') startBtn.click();
    if (type === 'stop-recording') stopBtn.click();  
  });

  // ✅ 通知插件 UI：我已经准备好了
  
  </script>
</body>
</html>

