<!-- <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Recorder</title>
</head>
<body>
  <h2>ğŸ¤ Recorder (Speech to Text)</h2>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop & Analyze</button>
  <textarea id="text" style="width:100%;height:150px;" placeholder="Transcript will appear here..."></textarea>

  <script>
    let recognition;
    let finalTranscript = '';

    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const textArea = document.getElementById('text');

    if (!('webkitSpeechRecognition' in window)) {
      alert('Your browser does not support speech recognition. Use Chrome.');
    } else {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        let interim = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const text = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += text;
          } else {
            interim += text;
          }
        }
        textArea.value = finalTranscript + interim;
      };

      startBtn.onclick = () => {
        finalTranscript = '';
        recognition.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };

      stopBtn.onclick = async () => {
        recognition.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;

        const transcript = textArea.value;

        try {
        const res = await fetch('https://fyp-2025-kath.vercel.app/api/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ transcript }), // âœ… æ­£ç¡®å‘é€ JSON æ ¼å¼
        });

        const result = await res.json();
        textArea.value = result.summary || JSON.stringify(result, null, 2);

        // âœ… è¿”å›ç»™æ’ä»¶ï¼ˆå¦‚æœæ˜¯åµŒå…¥ iframe ä¸­ï¼‰
        window.parent?.postMessage({ pluginMessage: result }, '*');
        } catch (err) {
        console.error('âŒ Error during fetch:', err);
        textArea.value = 'âŒ Failed to fetch summary: ' + err.message;
        }
        };

    }
  </script>
</body>
</html> -->


<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Recorder</title></head>
<body>
  <h2>ğŸ¤ Recorder</h2>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop & Analyze</button>
  <textarea id="text" style="width:100%;height:150px;"></textarea>

  <script>
    let recorder, chunks = [];

    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const textArea = document.getElementById('text');

    startBtn.onclick = async () => {
      chunks = []; // æ¸…ç©ºæ—§æ•°æ®
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);

      recorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      recorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      recorder.stop();

      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });

        if (blob.size === 0) {
          textArea.value = 'âŒ No audio recorded.';
          return;
        }

        const form = new FormData();
        form.append('file', blob, 'audio.webm'); // âœ… ä¿æŒå­—æ®µåä¸º 'file'

        try {
          const res = await fetch('/api/analyze', { method: 'POST', body: form });

          if (!res.ok) {
            const errorText = await res.text();
            console.error('âŒ Server error:', errorText);
            textArea.value = 'âŒ Server error: ' + errorText;
            return;
          }

          const json = await res.json();
          textArea.value = json.summary || json.transcript || JSON.stringify(json, null, 2);
          window.parent?.postMessage({ pluginMessage: json }, '*');
        } catch (err) {
          console.error('âŒ Network or fetch error:', err);
          textArea.value = 'âŒ Fetch error: ' + err.message;
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
      };
    };
  </script>
</body>
</html>


<!-- <!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Recorder</title></head>
<body>
  <h2>ğŸ¤ Recorder</h2>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop & Analyze</button>
  <textarea id="text" style="width:100%;height:150px;"></textarea>

  <script>
    let recorder, chunks = [];
    document.getElementById('start').onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.start();
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
    };

    document.getElementById('stop').onclick = () => {
      recorder.stop();
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const form = new FormData();
        form.append('file', blob, 'audio.webm');
        const res = await fetch('/api/analyze', { method: 'POST', body: form });
        if (!res.ok) {
          const text = await res.text(); // ç”¨ text çœ‹é”™è¯¯ç»†èŠ‚
          console.error('âŒ Server error:', text);
          document.getElementById('text').value = 'âŒ Server error: ' + text;
          return;}
        const json = await res.json();
        document.getElementById('text').value = JSON.stringify(json, null, 2);
        window.parent.postMessage({ pluginMessage: json }, '*');
        document.getElementById('start').disabled = false;
        document.getElementById('stop').disabled = true;
      };
    };
  </script>
</body>
</html> -->



<!-- <h2>ğŸ¤ External Recorder</h2>
<button id="start">Start Recording</button>
<button id="stop" disabled>Stop</button>
<textarea id="text" placeholder="Transcript will appear here..."></textarea>
<script>
  let recognition;
  let finalTranscript = '';

  if (!('webkitSpeechRecognition' in window)) {
    alert("Please use Google Chrome.");
  } else {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          finalTranscript += event.results[i][0].transcript;
        } else {
          interim += event.results[i][0].transcript;
        }
      }
      document.getElementById('text').value = finalTranscript + interim;
    };

    recognition.onerror = (e) => {
      console.error("Speech recognition error:", e);
      alert("Microphone access denied or blocked.");
    };
  }

  document.getElementById('start').onclick = () => {
    finalTranscript = '';
    recognition.start();
    document.getElementById('start').disabled = true;
    document.getElementById('stop').disabled = false;
  };

  document.getElementById('stop').onclick = () => {
    recognition.stop();
    document.getElementById('start').disabled = false;
    document.getElementById('stop').disabled = true;
    const text = document.getElementById('text').value;

    window.parent.postMessage({
      pluginMessage: {
        type: 'analyze-transcript',
        text: text
      }
    }, '*');

    alert("âœ… Sent transcript to plugin UI.");
  };
</script> -->



<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¤ Recorder</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
    }
    textarea {
      width: 100%;
      height: 150px;
    }
  </style>
</head>
<body>
  <h2>ğŸ¤ External Recorder</h2>
  <button id="start">Start Recording</button>
  <button id="stop" disabled>Stop</button>
  <textarea id="text" placeholder="Transcript will appear here..."></textarea>

  <script>
    let recognition;
    let finalTranscript = '';

    if (!('webkitSpeechRecognition' in window)) {
      alert("Please use Google Chrome to use this feature.");
    } else {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        let interim = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interim += event.results[i][0].transcript;
          }
        }
        document.getElementById('text').value = finalTranscript + interim;
      };

      recognition.onerror = (e) => {
        console.error("Speech recognition error:", e);
        alert("Microphone access denied or blocked.");
      };
    }

    document.getElementById('start').onclick = () => {
      finalTranscript = '';
      recognition.start();
      document.getElementById('start').disabled = true;
      alert("ğŸ“¤ start shdshh transcript to UI: " + text);
      document.getElementById('stop').disabled = false;
    };

    document.getElementById('stop').onclick = () => {
  // âœ… è·å–è½¬å½•æ–‡æœ¬
  const text = document.getElementById('text').value;

  // âœ… åœæ­¢å½•éŸ³ & æŒ‰é’®åˆ‡æ¢
  recognition.stop();
  document.getElementById('start').disabled = false;
  document.getElementById('stop').disabled = true;

  // âœ… æ‰“å°ç¡®è®¤
  console.log("ğŸ“¤ About to send transcript to parent iframe:", text);

  // âœ… ä½¿ç”¨ window.parent å‘é€ç»™çˆ¶çª—å£ï¼ˆui.htmlï¼‰
  window.parent.postMessage({
    pluginMessage: {
      type: 'analyze-transcript',
      text: text
    }
  }, '*');

  alert("âœ… Sent transcript to plugin UI.");
}; -->


