<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; padding: 16px; }
    button { padding: 8px 16px; margin-right: 8px; }
    textarea { width: 100%; height: 200px; margin-top: 12px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>🎙️ Record Meeting</h2>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
  

  <textarea id="textArea" placeholder="Transcript and summary will appear here..."></textarea>

  <script>

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const textArea = document.getElementById('textArea');

    let recorder;
    let chunks = [];

    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get("session");
    const autoStart = urlParams.get("start") === "true";

    console.log("📎 Extracted sessionId:", sessionId);

    startBtn.onclick = startRecording;
    stopBtn.onclick = stopRecording;

    if (autoStart) startRecording();

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        chunks = [];

        recorder.ondataavailable = (e) => chunks.push(e.data);

        recorder.onstop = async () => {
          console.log("🎯 Recording stopped");

          const blob = new Blob(chunks, { type: 'audio/webm' });
          if (blob.size === 0) {
            textArea.value = '❌ No audio recorded.';
            return;
          }

          textArea.value = '🔄 Uploading and analyzing...';

          const form = new FormData();
          form.append('file', blob, 'audio.webm');

          try {
            const res = await fetch('https://fyp-2025-kath.vercel.app/api/analyze', {
              method: 'POST',
              body: form
            });

            const result = await res.json();
            console.log("✅ Analysis result:", result);

            textArea.value = `📝 Transcript:\n${result.transcript}\n\n🧠 Summary:\n${result.summary}`;

            await fetch('https://fyp-2025-kath.vercel.app/api/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                session: sessionId,
                transcript: result.transcript,
                summary: result.summary
              })
            });

            console.log("📦 Saved to session:", sessionId);

          } catch (err) {
            console.error('❌ Analysis or save failed:', err);
            textArea.value = '❌ Failed to analyze or save result.';
          }

          startBtn.disabled = false;
          stopBtn.disabled = true;
        };

        recorder.start();
        textArea.value = '🎙️ Recording...';
        startBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (err) {
        console.error('❌ Microphone access error:', err);
        textArea.value = '❌ Could not access microphone.';
      }
    }

    function stopRecording() {
      if (recorder && recorder.state === 'recording') {
        recorder.stop();
      } 
    }
  //   // ✅ 外部控制的监听器（ui.html 发送 postMessage 控制）
  // window.addEventListener('message', (event) => {
  //   const { type } = event.data;
  //   if (type === 'start-recording') startRecording();
  //   if (type === 'stop-recording') stopRecording();  
  // });

  // // ✅ 通知插件 UI：我已经准备好了
  // window.onload = () => {
  //   window.opener?.postMessage({ type: 'ready-to-record' }, '*');
  //   console.log("📤 record.html sent ready-to-record");
  // };
  </script>
</body>
</html>

