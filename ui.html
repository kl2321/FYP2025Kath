<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Meeting Assistant</title>
  <style>
    /* [保持原有的所有CSS样式不变] */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #333;
      padding: 0;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Progress Indicator */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      background: #f7f7f7;
      border-bottom: 1px solid #e5e5e5;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .progress-step::after {
      content: '';
      position: absolute;
      top: 15px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e5e5e5;
      z-index: 0;
    }

    .progress-step:last-child::after {
      display: none;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e5e5e5;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .progress-step.active .step-circle {
      background: #5E5CE6;
      color: white;
    }

    .progress-step.completed .step-circle {
      background: #30D158;
      color: white;
    }

    .step-label {
      margin-top: 8px;
      font-size: 11px;
      color: #666;
      font-weight: 500;
    }

    .progress-step.active .step-label {
      color: #5E5CE6;
      font-weight: 600;
    }

    /* Page Container */
    .page-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    .page-container .page#page4 {
  padding: 12px;  /* 更紧凑的内边距 */
}

    .page {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }

    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d1d1;
      border-radius: 6px;
      font-size: 13px;
      transition: all 0.2s;
      background: white;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #5E5CE6;
      box-shadow: 0 0 0 3px rgba(94, 92, 230, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    /* Radio/Checkbox Groups */
    .radio-group,
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radio-item,
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .radio-item:hover,
    .checkbox-item:hover {
      background: #f7f7f7;
      border-color: #5E5CE6;
    }

    .radio-item input[type="radio"],
    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
    }

    .radio-item.selected,
    .checkbox-item.selected {
      background: #F0F0FF;
      border-color: #5E5CE6;
    }

    /* File Upload Area */
    .upload-area {
      border: 2px dashed #d1d1d1;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }

    .upload-area:hover {
      border-color: #5E5CE6;
      background: #F0F0FF;
    }

    .upload-area.dragover {
      border-color: #5E5CE6;
      background: #F0F0FF;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 48px;
      color: #999;
      margin-bottom: 10px;
    }

    .upload-text {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .upload-hint {
      color: #999;
      font-size: 12px;
    }

    .file-list {
      margin-top: 16px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f7f7f7;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-name {
      font-size: 13px;
      color: #333;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-remove {
      color: #999;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .file-remove:hover {
      background: #e5e5e5;
      color: #ff3b30;
    }

    /* Recording Interface */
    .recording-interface {
      text-align: center;
      padding: 40px 20px;
    }

    

    .record-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%);
      border: none;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .record-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 30px rgba(255, 59, 48, 0.4);
    }

    .record-button.recording {
      background: linear-gradient(135deg, #666 0%, #999 100%);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3); }
      50% { box-shadow: 0 4px 40px rgba(255, 59, 48, 0.6); }
      100% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3); }
    }

    .recording-time {
      margin-top: 20px;
      font-size: 24px;
      font-weight: 300;
      color: #333;
      font-variant-numeric: tabular-nums;
    }

    .recording-status {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    /* Navigation Buttons */
    .navigation {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      border-top: 1px solid #e5e5e5;
      background: #fafafa;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-secondary {
      background: white;
      color: #666;
      border: 1px solid #d1d1d1;
    }

    .btn-secondary:hover {
      background: #f7f7f7;
      border-color: #999;
    }

    .btn-primary {
      background: #5E5CE6;
      color: white;
    }

    .btn-primary:hover {
      background: #4B49D8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(94, 92, 230, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Success/Info Messages */
    .info-message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-message.success {
      background: #E8F5E9;
      color: #2E7D32;
      border: 1px solid #A5D6A7;
    }

    .info-message.info {
      background: #E3F2FD;
      color: #1565C0;
      border: 1px solid #90CAF9;
    }

    .info-message.warning {
      background: #FFF3E0;
      color: #EF6C00;
      border: 1px solid #FFB74D;
    }

    .option-card {
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
}

.option-card h4 {
  margin-top: 0;
  color: #333;
}

/* Summary Page Styles - 优化版 */
.stats-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;  /* 从16px减少到12px */
  margin-bottom: 16px;  /* 从24px减少到16px */
}

.stat-card {
  background: #f8f9fa;
  border-radius: 10px;  /* 稍微减小圆角 */
  padding: 16px;  /* 从20px减少到16px */
  text-align: center;
  transition: transform 0.2s;
  border: 1px solid #e5e5e5;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.stat-number {
  font-size: 36px;  /* 从48px减少到36px */
  font-weight: bold;
  color: #5E5CE6;
  margin: 8px 0;  /* 从10px减少到8px */
  line-height: 1;
}

.stat-label {
  font-size: 12px;  /* 从14px减少到12px */
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.3px;  /* 稍微减小字间距 */
  line-height: 1.2;
}

.stat-icon {
  font-size: 28px;  /* 从32px减少到28px */
  margin-bottom: 6px;  /* 从8px减少到6px */
}

/* Page 4特定的容器样式 */
#page4 {
  padding: 16px;  /* 添加整体页面内边距 */
}

#page4 h2 {
  margin-bottom: 16px;  /* 减小标题下方间距 */
  font-size: 20px;  /* 稍微减小标题大小 */
}

.reminder-box {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
  border-left: 4px solid #ffc107;
  border-radius: 8px;
  padding: 12px 16px;  /* 减少padding */
  margin: 16px 0;  /* 减少margin */
  display: flex;
  align-items: center;
  gap: 12px;  /* 减少gap */
}

.reminder-icon {
  font-size: 24px;  /* 从32px减少到24px */
}

.reminder-content h3 {
  margin: 0 0 2px 0;  /* 减少底部margin */
  color: #856404;
  font-size: 14px;  /* 从16px减少到14px */
}

.reminder-content p {
  margin: 0;
  color: #856404;
  font-size: 12px;  /* 从14px减少到12px */
}

.progress-timer {
  margin-top: 20px;  /* 从32px减少到20px */
  padding: 0 16px;  /* 从20px减少到16px */
}

.timer-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;  /* 从8px减少到6px */
  font-size: 13px;  /* 从14px减少到13px */
  color: #666;
}

.timer-bar {
  height: 6px;  /* 从8px减少到6px */
  background: #e5e5e5;
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.summary-sections {
  margin-top: 20px;  /* 从32px减少到20px */
}

.summary-section {
  background: white;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  padding: 16px;  /* 从20px减少到16px */
  margin-bottom: 12px;  /* 从16px减少到12px */
}

.summary-section h3 {
  margin: 0 0 8px 0;  /* 减少底部margin */
  color: #333;
  font-size: 14px;  /* 从16px减少到14px */
  display: flex;
  align-items: center;
  gap: 6px;
}

.summary-content {
  color: #666;
  font-size: 13px;  /* 从14px减少到13px */
  line-height: 1.5;  /* 稍微减小行高 */
}

.action-buttons {
  display: flex;
  gap: 10px;  /* 从12px减少到10px */
  justify-content: center;
  margin-top: 20px;  /* 从32px减少到20px */
  padding-bottom: 16px;  /* 添加底部padding */
}

.recording-status-box {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  border-left: 4px solid #4caf50;
  border-radius: 8px;
  padding: 12px 16px;
  margin: 16px 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 14px;
  color: #2e7d32;
}

.recording-dot {
  width: 12px;
  height: 12px;
  background: #f44336;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.status-info {
  font-size: 12px;
  color: #2e7d32;
}

.status-info strong {
  font-weight: 600;
}

/* 针对Figma插件的特殊优化 */
@media (max-height: 600px) {
  .stat-number {
    font-size: 32px;
  }
  .stat-icon {
    font-size: 24px;
  }
  .stats-container {
    gap: 8px;
  }
}


  </style>
</head>
<body>
  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Basic Info</div>
    </div>
    <div class="progress-step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Meeting Setup</div>
    </div>
    <div class="progress-step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Recording</div>
    </div>
    <div class="progress-step" data-step="4">
      <div class="step-circle">4</div>
      <div class="step-label">Summary</div>
    </div>
  </div>

  <!-- Page Container -->
  <div class="page-container">
    <!-- Page 1: Basic Information -->
    <div class="page active" id="page1">
      <h2 style="margin-bottom: 24px;">Meeting Configuration</h2>
      
      <div class="form-group">
        <label>Your Role *</label>
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" id="student" name="role" value="student" checked>
            <label for="student" style="margin: 0;">Student</label>
          </div>
          <div class="radio-item">
            <input type="radio" id="tutor" name="role" value="tutor/instructor">
            <label for="tutor" style="margin: 0;">Tutor/Instructor</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="module">Course Module *</label>
        <select id="module" required>
          <option value="">Select a module...</option>
          <option value="DE4 ERO">DE4 ERO</option>
          <option value="IDE2 TTL">IDE2 TTL</option>
          <option value="DE3 Futures ">DE3 Futures</option>
          <option value="DE3 I&E">DE3 I&E</option>
          <option value="xxx">xxx</option>
        </select>
      </div>


      <div class="form-group">
        <label for="team-name">Group Name/Number (optional)</label>
        <input type="text" id="team-name" placeholder="Enter your group name/number">
        <small style="color: #999; font-size: 11px; margin-top: 4px; display: block;">
        </small>
      </div>

      <div class="form-group">
        <label for="project-status">Project Status *</label>
        <input type="text" id="project-status" placeholder="Enter project week number (e.g. Week 1, Week 2)">
        <small style="color: #999; font-size: 11px; margin-top: 4px; display: block;">
          Helps to improve analysis and tailored suggestions.
        </small>
      </div>

      <div class="form-group">
        <label for="meeting-type">Meeting Type *</label>
        <select id="meeting-type" required>
          <option value="">Select meeting type...</option>
          <option value="brainstorming">Brainstorming Session</option>
          <option value="project-planning">Project Planning</option>
          <!-- <option value="progress-update">Progress Update</option> -->
          <option value="problem-solving">Problem Solving</option>
          <!-- <option value="retrospective">Retrospective</option> -->
        </select>
      </div>

      

      <div class="form-group">
        <label for="team-members">Team Members (optional)</label>
        <input type="text" id="team-members" placeholder="Enter names separated by commas">
        <small style="color: #999; font-size: 11px; margin-top: 4px; display: block;">
          This helps with speaker identification
        </small>
      </div>

      <div class="form-group">
        <label for="meeting-goals">Meeting Goals (optional)</label>
        <textarea id="meeting-goals" placeholder="What do you hope to achieve in this meeting?"></textarea>
      </div>
    </div>

    <!-- Page 2: File Upload & Settings -->
    <div class="page" id="page2">
      <h2 style="margin-bottom: 24px;">Upload Supporting Materials</h2>
      
      <div class="info-message info">
        <span>💡</span>
        <span>Upload any relevant documents to provide context for better AI analysis</span>
      </div>

      <div class="form-group">
        <label>Supporting Documents (optional)</label>
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">📁</div>
          <div class="upload-text">Click to upload or drag and drop</div>
          <div class="upload-hint">PDF, DOC, DOCX, TXT, Images (Max 10MB)</div>
          <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;">
        </div>
        <div class="file-list" id="fileList"></div>
      </div>

      <!-- NEW: Previous Meeting Minutes Section -->
  <div class="form-group">
    <label for="previous-summary">Previous Meeting Summary *</label>
    <textarea 
      id="previous-summary" 
      placeholder="Paste your previous meeting minutes here for context and continuity (required)..."
      style="min-height: 120px; font-family: inherit; line-height: 1.5;"
      required
    ></textarea>
    <small style="color: #999; font-size: 11px; margin-top: 4px; display: block;">
      <strong>Required:</strong> Including previous minutes helps AI provide better follow-up analysis and track progress
    </small>
  </div>

   <div class="form-group">
    <label>Analysis Preferences</label>
    <div class="checkbox-group">
      <!-- Existing checkboxes remain unchanged -->
      <div class="checkbox-item">
        <input type="checkbox" id="key-decisions" checked>
        <label for="key-decisions" style="margin: 0;">Extract Key Decisions</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="action-items" checked>
        <label for="action-items" style="margin: 0;">Identify Action Items</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="speaker-analysis">
        <label for="speaker-analysis" style="margin: 0;">Analyze Speaker Contributions</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="progress-tracking">
        <label for="progress-tracking" style="margin: 0;">Track the Project Progress</label>
      </div>


      
        </div>
      </div>
    </div>

    <!-- Page 3: Recording -->
<div class="page" id="page3">
  <h2 style="margin-bottom: 24px;">Start Recording</h2>

  <div id="recording-interface"></div>
    
    <!-- 添加录音间隔设置 -->
    <div style="margin-top: 30px;">
      <label for="cycleInput">Summary interval (minutes):</label>
      <input id="cycleInput" type="number" value="5" min="1" max="30" 
             style="width: 80px; padding: 8px; margin-left: 10px;">
    </div>
    
    <div style="margin-top: 40px;">
      <div class="info-message info" style="text-align: left;">
        <span>ℹ️</span>
        <div>
          <strong>Recording Instructions:</strong><br>
          • A new window will open for recording<br>
          • Allow microphone access when prompted<br>  
          • Recording will auto-save every 5 minutes<br>
          • You can stop recording from this page
        </div>
      </div>
    </div>
  </div>
  
  <!-- 添加停止按钮（初始隐藏） -->
  <div style="text-align: center; margin-top: 20px;">
    <button class="btn btn-secondary" id="stopRecordingBtn" style="display: none;">
      Stop Recording
    </button>
  </div>
</div>

<!-- 添加查看摘要按钮 -->
<!-- <div style="text-align: center; margin-top: 20px;">
  <button class="btn btn-primary" id="viewSummaryBtn" onclick="goToSummaryPage()" style="display: none;">
    View Summary Demo
  </button>

<div style="text-align: center; margin-top: 20px;">
    <button class="btn btn-primary" onclick="testRealtimeAnalysis()" 
            style="background: #ff9800; border-color: #ff9800;">
      🧪 Test Realtime Analysis (Dev Only)
    </button>
  </div> -->
<!-- Navigation Buttons -->
  <div class="navigation">
    <button class="btn btn-secondary" id="prevBtn" onclick="changePage(-1)">Previous</button>
    <button class="btn btn-primary" id="nextBtn" onclick="changePage(1)">Next</button>
  </div>
  <!-- 紧接着添加 script -->
<script>
function testRealtimeAnalysis() {
  console.log('🧪 Testing from inline script...');
  
  // 如果 callRealtimeSummarize 不可用，尝试直接调用 API
  if (typeof callRealtimeSummarize === 'undefined') {
    console.log('⚠️ Using direct API call for testing');
    
    fetch('https://fyp-2025-kath.vercel.app/api/summarize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: "Speaker A: We decided to use PostgreSQL.",
        avoid: "",
        session_id: null,
        form_data: {
          role: "student",
          module: "DE4 ERO",
          meetingType: "technical-review",
          projectWeek: "Week 5"
        }
      })
    })
    .then(r => r.json())
    .then(d => {
      console.log('✅ API Response:', d);
      alert('Test successful! Check console for details.');
    })
    .catch(e => {
      console.error('❌ Test failed:', e);
      alert('Test failed! Check console.');
    });
  } else {
    // 使用已定义的函数
    callRealtimeSummarize("Test transcript", "");
  }
}
</script>

</div>

<!-- Page 4: Summary -->

<!-- Page 4: Real-time Progress Monitor -->
<div class="page" id="page4">
  <h2 style="margin-bottom: 24px;">🎙️ Recording Progress</h2>
  
  <!-- 统计卡片 - 只保留4个 -->
  <div class="stats-container">
    <!-- 决策数量 -->
    <div class="stat-card">
      <div class="stat-icon">🎯</div>
      <div class="stat-number" id="decisionsCount">0</div>
      <div class="stat-label">Decisions</div>
    </div>
    
    <!-- 说话人数量 -->
    <div class="stat-card">
      <div class="stat-icon">👥</div>
      <div class="stat-number" id="speakersCount">0</div>
      <div class="stat-label">Speakers</div>
    </div>
    
    <!-- 会议时长 -->
    <div class="stat-card">
      <div class="stat-icon">⏱️</div>
      <div class="stat-number" id="durationDisplay">00:00</div>
      <div class="stat-label">Duration</div>
    </div>
    
    <!-- 下一次分析 -->
    <div class="stat-card">
      <div class="stat-icon">⏭️</div>
      <div class="stat-number" id="nextSegmentTime">--:--</div>
      <div class="stat-label">Next Segment</div>
    </div>
  </div>
  
  <!-- 提醒框 -->
  <div class="reminder-box">
    <div class="reminder-icon">⏰</div>
    <div class="reminder-content">
      <h3>Next Analysis Segment</h3>
      <p id="segmentReminderText">Recording in progress. Next AI analysis in <strong id="segmentCountdown">--</strong></p>
    </div>
  </div>
  
  <!-- 录音状态 -->
  <div class="recording-status-box">
    <div class="status-indicator">
      <div class="recording-dot"></div>
      <span id="recordingStatusText">Recording...</span>
    </div>
    <div class="status-info">
      <p id="recordingInfoText">Meeting started at <strong id="startTimeDisplay">--:--</strong></p>
    </div>
  </div>
  
  <!-- 最新决策 -->
  <div class="summary-sections">
    <div class="summary-section">
      <h3>🎯 Latest Decisions</h3>
      <div class="summary-content" id="latestDecisions">
        <em style="color: #999;">No decisions recorded yet. AI will analyze the discussion periodically.</em>
      </div>
    </div>
  </div>
  
  <!-- 按钮 -->
  <div class="action-buttons">
    <button class="btn btn-secondary" onclick="goBackToRecording()">← Back to Recording</button>
    <button class="btn btn-primary" onclick="refreshProgress()">🔄 Refresh</button>
  </div>

    <!-- Navigation Buttons -->
  <div class="navigation">
    <button class="btn btn-secondary" id="prevBtn" onclick="changePage(-1)">Previous</button>
    <button class="btn btn-primary" id="nextBtn" onclick="changePage(1)">Next</button>
  </div>
</div>
   
  <script>
    // // ===== MODIFIED STORAGE SOLUTION FOR FIGMA PLUGIN =====
    // // Use in-memory storage and communicate with plugin for persistence
    
    // State Management (in-memory)
    let currentPage = 1;
    const totalPages = 4;
    let formData = {
      role: 'student',
      module: '',
      meetingType: '',
      teamMembers: [],
      meetingGoals: '',
      files: [],
      preferences: {
        keyDecisions: true,
        actionItems: true,
        speakerAnalysis: false,
        progressTracking: false
      },
      additionalContext: '',
      pdfText: '',
      pdfFileName: ''
    };

    // // Recording state
     let isRecording = false;
    // let recordingStartTime = null;
    // let recordingInterval = null;
    // let mediaRecorder = null;
    // let audioChunks = [];

    // ===== STORAGE FUNCTIONS (Modified for Figma) =====
    
    // Save data to plugin storage via postMessage
    function saveToPluginStorage(key, value) {
      parent.postMessage({
        pluginMessage: {
          type: 'save-storage',
          key: key,
          value: value
        }
      }, '*');
    }

    // Request data from plugin storage
    function loadFromPluginStorage(key) {
      parent.postMessage({
        pluginMessage: {
          type: 'load-storage',
          key: key
        }
      }, '*');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updatePageDisplay();
      setupEventListeners();
      // Request saved data from plugin
      loadFromPluginStorage('meetingFormData');
    });

    // Listen for messages from plugin
    window.onmessage = (event) => {
      const message = event.data.pluginMessage;
      if (!message) return;

      switch (message.type) {
        case 'storage-loaded':
          if (message.key === 'meetingFormData' && message.value) {
            formData = message.value;
            restoreFormFields();
          }
          break;
        case 'processing-complete':
          displaySummaryResults(message.results);
          break;
        case 'processing-error':
          showMessage(message.error, 'warning');
          break;
      }
    };

    // 手动跳转到Summary页面（用于测试）
window.goToSummaryPage = function() {
  currentPage = 4;
  updatePageDisplay();
  displaySummaryResults(null); // 显示demo数据
}

// 在页面加载完成后，为测试添加一个按钮
document.addEventListener('DOMContentLoaded', () => {
  // ... 原有代码 ...
  
  // 添加测试按钮（可选）
  setTimeout(() => {
    const viewSummaryBtn = document.getElementById('viewSummaryBtn');
    if (viewSummaryBtn && currentPage === 3) {
      viewSummaryBtn.style.display = 'inline-block';
    }
  }, 1000);
});

    // Page Navigation
    function changePage(direction) {
      // Save current page data
      savePageData();

      // Validate before moving forward
      if (direction > 0 && !validateCurrentPage()) {
        showMessage('Please fill in all required fields', 'warning');
        return;
      }

      // Change page
      currentPage += direction;
      if (currentPage < 1) currentPage = 1;
      if (currentPage > totalPages) currentPage = totalPages;

      // Special handling for recording page
      if (currentPage === 3) {
        prepareRecordingPage();
      }

      // Update display
      updatePageDisplay();
      
      // Animate transition
      animatePageTransition();
    }

    function updatePageDisplay() {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });

      // Show current page
      document.getElementById(`page${currentPage}`).classList.add('active');

      // Update progress bar
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        if (index < currentPage - 1) {
          step.classList.add('completed');
          step.classList.remove('active');
        } else if (index === currentPage - 1) {
          step.classList.add('active');
          step.classList.remove('completed');
        } else {
          step.classList.remove('active', 'completed');
        }
      });

      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      prevBtn.style.display = currentPage === 1 ? 'none' : 'block';
      
      if (currentPage === 3) {
        nextBtn.textContent = 'Finish Recording';
        nextBtn.style.display = isRecording ? 'block' : 'none';
      } else if (currentPage === 4) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.textContent = 'Next';
        nextBtn.style.display = 'block';
      }
    }

    function animatePageTransition() {
      const activePage = document.querySelector('.page.active');
      activePage.style.animation = 'none';
      setTimeout(() => {
        activePage.style.animation = 'fadeIn 0.3s ease';
      }, 10);
    }

    // Event Listeners Setup
    function setupEventListeners() {
      // File upload
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
          handleFiles(e.target.files);
        });
      }

      // Radio buttons visual feedback
      document.querySelectorAll('.radio-item').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.radio-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          item.querySelector('input[type="radio"]').checked = true;
        });
      });

      // Checkbox visual feedback
      document.querySelectorAll('.checkbox-item').forEach(item => {
        item.addEventListener('click', () => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          item.classList.toggle('selected', checkbox.checked);
        });
      });

      // Recording button
      const recordButton = document.getElementById('recordButton');
      if (recordButton) {
        recordButton.addEventListener('click', toggleRecording);
      }

      const stopBtn = document.getElementById('stopRecordingBtn');

       const stopRecordingBtn = document.getElementById('stopRecordingBtn');
  if (stopRecordingBtn) {
    stopRecordingBtn.addEventListener('click', () => {
      console.log('Stop button clicked');
      stopExternalRecording();  // 调用停止函数
    });
  }

    }

    // File Handling
    // File Handling
async function handleFiles(files) {
  const fileList = document.getElementById('fileList');
  
  for (const file of Array.from(files)) {
    // Validate file
    if (file.size > 10 * 1024 * 1024) {
      showMessage(`File ${file.name} is too large (max 10MB)`, 'warning');
      continue;
    }

    // 如果是PDF文件，进行特殊处理
    if (file.type === 'application/pdf') {
      console.log('📄 Processing PDF file:', file.name);
      
      // 保存文件名
      formData.pdfFileName = file.name;
      
      // 使用服务器端PDF处理
      try {
        showMessage('Processing PDF...', 'info');
        
        const pdfFormData = new FormData();
        pdfFormData.append('file', file);
        
        const response = await fetch(`${API_CONFIG.BASE_URL}/api/ingest_pdf`, {
          method: 'POST',
          body: pdfFormData
        });
        
        const result = await response.json();
        
        if (result?.text && result.text.length > 0) {
          formData.pdfText = result.text;
  formData.pdfFileName = file.name;  // 确保文件名也被保存
  
  // 添加这些调试日志
  console.log('✅ PDF处理完成:');
  console.log('  - 文件名:', formData.pdfFileName);
  console.log('  - 文本长度:', formData.pdfText.length);
  console.log('  - 前100字符:', formData.pdfText.substring(0, 100));
          showMessage(`PDF processed: ${(result.text.length/1000).toFixed(1)}k characters`, 'success');
        } else {
          showMessage('Could not extract text from PDF', 'warning');
        }
      } catch (err) {
        console.error('PDF processing error:', err);
        showMessage('Failed to process PDF', 'warning');
      }
    }

    // Store file metadata
    formData.files.push({
      name: file.name,
      size: file.size,
      type: file.type
    });

    // Display file
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <span class="file-name">${file.name}</span>
      <span class="file-remove" onclick="removeFile('${file.name}')">✕</span>
    `;
    fileList.appendChild(fileItem);

    // Send file info to plugin
    parent.postMessage({
      pluginMessage: {
        type: 'file-upload',
        fileName: file.name,
        fileType: file.type,
        fileSize: file.size
      }
    }, '*');
  }
}

// Make removeFile globally accessible
window.removeFile = function(fileName) {
  console.log('Removing file:', fileName);
  formData.files = formData.files.filter(f => f.name !== fileName);
  updateFileList();
  
  // 如果是PDF文件，清除PDF文本
  if (fileName === formData.pdfFileName) {
    formData.pdfText = '';
    formData.pdfFileName = '';
    console.log('Cleared PDF text cache');
  }
}

// Update file list display
function updateFileList() {
  const fileList = document.getElementById('fileList');
  if (!fileList) {
    console.warn('fileList element not found');
    return;
  }
  
  fileList.innerHTML = '';
  
  if (!formData.files || formData.files.length === 0) {
    console.log('No files to display');
    return;
  }
  
  formData.files.forEach(file => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <span class="file-name">${file.name}</span>
      <span class="file-remove" onclick="removeFile('${file.name}')">✕</span>
    `;
    fileList.appendChild(fileItem);
  });
  
  console.log(`Updated file list with ${formData.files.length} files`);
}
 

    // Recording Functions
    async function toggleRecording() {
      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    }

    async function startRecording() {
      try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          // Create audio blob
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          
          // Process recording
          await processRecording(audioBlob);
        };

        // Start recording
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();

        // Update UI
        document.getElementById('recordButton').classList.add('recording');
        document.getElementById('recordButtonText').textContent = 'Stop Recording';
        document.getElementById('recordingStatus').textContent = 'Recording in progress...';
        document.getElementById('nextBtn').style.display = 'block';

        // Start timer
        recordingInterval = setInterval(updateRecordingTime, 1000);

      } catch (error) {
        console.error('Error starting recording:', error);
        showMessage('Failed to access microphone. Please check permissions.', 'warning');
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        
        // Stop all tracks
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        isRecording = false;
        clearInterval(recordingInterval);

        // Update UI
        document.getElementById('recordButton').classList.remove('recording');
        document.getElementById('recordButtonText').textContent = 'Processing...';
        document.getElementById('recordingStatus').textContent = 'Processing your recording...';
        document.getElementById('recordButton').disabled = true;
      }
    }

    // function updateRecordingTime() {
    //   const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    //   const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    //   const seconds = (elapsed % 60).toString().padStart(2, '0');
    //   document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
    // }

    // async function processRecording(audioBlob) {
    //   // Move to summary page
    //   currentPage = 4;
    //   updatePageDisplay();

    //   // Convert blob to base64 for Figma plugin communication
    //   const reader = new FileReader();
    //   reader.onloadend = () => {
    //     parent.postMessage({
    //       pluginMessage: {
    //         type: 'process-recording',
    //         formData: formData,
    //         audioData: reader.result
    //       }
    //     }, '*');
    //   };
    //   reader.readAsDataURL(audioBlob);
    // }

    // Form Validation
    function validateCurrentPage() {
      if (currentPage === 1) {
        const module = document.getElementById('module').value;
        const meetingType = document.getElementById('meeting-type').value;
        
        if (!module || !meetingType) {
          return false;
        }
      }
      return true;
    }

    // Add validation in the savePageData function or before sending config
function validateProjectWeek(value) {
  if (!value) return '';
  
  // Ensure proper format: "Week X" or "Week X-Y"
  const trimmed = value.trim();
  
  // If user enters "RCA week 5" or similar, convert to "Week 5"
  if (trimmed.toLowerCase().includes('week')) {
    const match = trimmed.match(/week\s*(\d+(?:-\d+)?)/i);
    if (match) {
      return `Week ${match[1]}`;
    }
  }
  
  // If user just enters a number, format it properly
  if (/^\d+(?:-\d+)?$/.test(trimmed)) {
    return `Week ${trimmed}`;
  }
  
  return trimmed;
}


    // Data Persistence
    function savePageData() {
      if (currentPage === 1) {
        formData.role = document.querySelector('input[name="role"]:checked').value;
        formData.module = document.getElementById('module').value;
        formData.meetingType = document.getElementById('meeting-type').value;
        console.log('💾 保存Page1数据:', {
        module: formData.module,
        meetingType: formData.meetingType,
        role: formData.role
        
      });
         const teamNameInput = document.getElementById('team-name');
    if (teamNameInput) {
      const teamInfo = teamNameInput.value.trim();
      // 尝试分离 groupName 和 groupNumber
      if (teamInfo.match(/[A-Z]\d+/)) {
        formData.groupNumber = teamInfo.match(/[A-Z]\d+/)[0];
        formData.groupName = teamInfo.replace(/[A-Z]\d+/, '').trim();
      } else {
        formData.groupName = teamInfo;
      }
    }
    const projectStatus = document.getElementById('project-status');
    if (projectStatus) {
       formData.projectWeek = validateProjectWeek(projectStatus.value);
    }
        formData.teamMembers = document.getElementById('team-members').value.split(',').map(s => s.trim()).filter(Boolean);
        formData.meetingGoals = document.getElementById('meeting-goals').value;
      } else if (currentPage === 2) {
        formData.preferences.keyDecisions = document.getElementById('key-decisions').checked;
        formData.preferences.actionItems = document.getElementById('action-items').checked;
        formData.preferences.speakerAnalysis = document.getElementById('speaker-analysis').checked;
        formData.preferences.progressTracking = document.getElementById('progress-tracking').checked;

        const previousSummary = document.getElementById('previous-summary');
  if (previousSummary) {
    formData.previousSummary = previousSummary.value;
  }
      }

      // Save to plugin storage
      saveToPluginStorage('meetingFormData', formData);
    }

    // 新增：调用实时分析的函数
async function callRealtimeSummarize(transcript, previousSummary = '') {
  console.log('🎯 Calling realtime summarize API...');

  if (!formData.module || !formData.meetingType) {
    console.warn('⚠️ formData缺失必要字段');
    
    // 尝试从localStorage恢复
    const savedData = localStorage.getItem('meetingFormData');
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        formData = { ...formData, ...parsed };
      } catch (e) {
        console.error('Failed to parse saved data');
      }
    }
    
    // 如果还是没有，使用默认值
    if (!formData.module) formData.module = 'DE4 ERO';
    if (!formData.meetingType) formData.meetingType = 'brainstorming';
    formData.module = formData.module || 'DE4 ERO';
    formData.meetingType = formData.meetingType || 'brainstorming';
  }
  
  // 收集表单数据
  const formDataForAPI = {
    role: formData.role || 'student',
    module: formData.module || 'DE4 ERO',
    meetingType: formData.meetingType || 'brainstorming',
    projectWeek: formData.projectWeek || '',
    groupName: formData.groupName || '',
    groupNumber: formData.groupNumber || '',
    meetingGoals: formData.meetingGoals || '',
    teamMembers: formData.teamMembers || []
  };
  
  try {
    const response = await fetch(`${API_CONFIG.BASE_URL}/api/summarize`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        text: transcript,
        avoid: previousSummary,
        session_id: recordingSessionId,
        form_data: formDataForAPI
      })
    });
    
    const result = await response.json();
    
    if (result.decisions && result.decisions.length > 0) {
      console.log('✅ Found', result.decisions.length, 'decisions');
      // 显示决策
      displayRealtimeDecisions(result.decisions);
    }
    
    return result;
  } catch (error) {
    console.error('❌ Realtime analysis error:', error);
    return null;
  }
}

// 显示实时决策
function displayRealtimeDecisions(decisions) {

   console.log('📊 Updating decisions:', decisions.length);
  
  // ✨ 新增：计算说话人数量
  const speakers = new Set();
  decisions.forEach(d => {
    if (d.speaker) speakers.add(d.speaker);
    if (d.owner) speakers.add(d.owner);
  });
  const speakersCount = speakers.size || 0;
  
  // ✨ 新增：更新 Page 4 数据
  updateProgressStats(decisions.length, speakersCount);
  updateLatestDecisions(decisions);
  
  // 更新决策计数
  const decisionsCount = document.getElementById('decisionsCount');
  if (decisionsCount) {
    decisionsCount.textContent = decisions.length;
  }
  
  // 更新决策列表
  const keyDecisions = document.getElementById('keyDecisions');
  if (keyDecisions) {
    keyDecisions.innerHTML = decisions.map((d, i) => 
      `• Decision ${d.decision_number}: ${d.decision}<br>
       &nbsp;&nbsp;Explicit: ${d.explicit_knowledge.length} points<br>
       &nbsp;&nbsp;Tacit: ${d.tacit_knowledge.length} points`
    ).join('<br><br>');
  }

   window.__sentDecisionCount = window.__sentDecisionCount || 0;

  // 这次相对上次“新增”的部分
  const newlyAdded = decisions.slice(window.__sentDecisionCount);

  // 逐条发送到插件（code.ts 里用 update-realtime -> addDecision 渲染）
  newlyAdded.forEach(d => {
    const decisionText = d.decision || d.text || '';
    const owner = d.speaker || d.owner || 'Unknown';

    parent.postMessage({
      pluginMessage: {
        type: 'add-decision',
        data: {
         //type: 'decision',
          text: decisionText,
          number: d.decision_number,
          //owner
        }
      }
    }, '*');
  });

  // 更新累计已发送计数
  window.__sentDecisionCount = decisions.length;
}

    function restoreFormFields() {
      // Page 1 fields
      if (document.getElementById('module')) {
        document.getElementById('module').value = formData.module || '';
        document.getElementById('meeting-type').value = formData.meetingType || '';
        document.getElementById('team-members').value = formData.teamMembers.join(', ');
        document.getElementById('meeting-goals').value = formData.meetingGoals || '';
        
        // Radio buttons
        document.querySelector(`input[name="role"][value="${formData.role}"]`).checked = true;
      }

      // Page 2 fields
      if (document.getElementById('key-decisions')) {
        document.getElementById('key-decisions').checked = formData.preferences.keyDecisions;
        document.getElementById('action-items').checked = formData.preferences.actionItems;
        document.getElementById('speaker-analysis').checked = formData.preferences.speakerAnalysis;
        document.getElementById('progress-tracking').checked = formData.preferences.progressTracking;
      }

      // Update file list
      if (document.getElementById('fileList')) {
      updateFileList();
    }
  }

   function prepareRecordingPage() {
  // 获取recording-interface元素（新的容器）
  const recordingInterface = document.getElementById('recording-interface');
  
  if (!recordingInterface) {
    console.warn('recording-interface element not found');
    // 如果新元素不存在，尝试使用旧的结构
    const readyMessage = document.getElementById('readyMessage');
    if (readyMessage) {
      // 使用旧的方式
      let messageContent = `
        <span>✅</span>
        <div>
          <strong>Ready to record!</strong><br>
          Module: ${formData.module.replace('-', ' ')}<br>
          Meeting Type: ${formData.meetingType.replace('-', ' ')}<br>`;
      
      if (formData.files.length > 0) {
        messageContent += `${formData.files.length} supporting file(s) uploaded<br>`;
      }
      
      if (formData.pdfText && formData.pdfText.length > 0) {
        messageContent += `📄 PDF loaded: ${(formData.pdfText.length/1000).toFixed(1)}k characters<br>`;
      }
      
      messageContent += `</div>`;
      readyMessage.innerHTML = messageContent;
    }
    return;
  }
  
  // 使用新的界面（暂时显示简单信息）
  recordingInterface.innerHTML = `
    <div class="info-message success">
      <span>✅</span>
      <div>
        <strong>Ready to record!</strong><br>
        Module: ${formData.module || 'Not set'}<br>
        Meeting Type: ${formData.meetingType || 'Not set'}<br>
        ${formData.files.length > 0 ? formData.files.length + ' file(s) uploaded<br>' : ''}
        ${formData.pdfText ? '📄 PDF loaded: ' + (formData.pdfText.length/1000).toFixed(1) + 'k characters' : ''}
      </div>
    </div>
    
    <div class="recording-interface">
      <button class="record-button" id="recordButton">
        <span id="recordButtonText">Open Recorder</span>
      </button>
      
      <div class="recording-status" id="recordingStatus">Ready to record</div>
      
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
      <button class="btn btn-secondary" id="stopRecordingBtn" style="display: none;">
        Stop Recording
      </button>
    </div>
  `;
  
  // 重新绑定事件
  const recordButton = document.getElementById('recordButton');
  if (recordButton) {
    recordButton.addEventListener('click', toggleRecording);
  }
  
  const stopBtn = document.getElementById('stopRecordingBtn');
  if (stopBtn) {
    stopBtn.addEventListener('click', stopExternalRecording);
  }
}

    // // Summary Display
    // function displaySummaryResults(results) {
    //   const page4 = document.getElementById('page4');
    //   page4.innerHTML = `
    //     <h2 style="margin-bottom: 24px;">Meeting Summary</h2>
    //     <div style="background: #f7f7f7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    //       <h3 style="margin-bottom: 8px;">Overview</h3>
    //       <p>${results.overview || 'Processing...'}</p>
    //     </div>
    //     <div style="margin-top: 24px; text-align: center;">
    //       <button class="btn btn-primary" onclick="insertToFigma()">Insert to Figma</button>
    //     </div>
    //   `;
    // }

    // Summary Display with animations
function displaySummaryResults(results) {
  // Update statistics (demo values)
  updateStatistics();
  
  // Start timer animation
  startTimerAnimation();
  
  // If we have real results, update the content
  if (results) {
    if (results.overview || results.summary) {
      document.getElementById('meetingOverview').innerHTML = results.overview || results.summary;
    }
    if (results.decisions && results.decisions.length > 0) {
      document.getElementById('keyDecisions').innerHTML = results.decisions.map(d => `• ${d}`).join('<br>');
      document.getElementById('decisionsCount').textContent = results.decisions.length;
    }
    if (results.actionItems && results.actionItems.length > 0) {
      document.getElementById('actionItems').innerHTML = results.actionItems.map(a => `• ${a}`).join('<br>');
      document.getElementById('actionsCount').textContent = results.actionItems.length;
    }
  }
}

// Add demo functions for statistics animation
function updateStatistics() {
  // Animate number counting
  animateNumber('cardsCount', 0, 7, 1000);
  animateNumber('decisionsCount', 0, 3, 1200);
  animateNumber('speakersCount', 0, 4, 1400);
  animateNumber('actionsCount', 0, 5, 1600);
}

function animateNumber(elementId, start, end, duration) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const increment = (end - start) / (duration / 50);
  let current = start;
  
  const timer = setInterval(() => {
    current += increment;
    if (current >= end) {
      current = end;
      clearInterval(timer);
    }
    element.textContent = Math.floor(current);
  }, 50);
}

function startTimerAnimation() {
  let seconds = 148; // 2:28 in seconds
  
  const updateTimer = setInterval(() => {
    seconds--;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    const timerElement = document.getElementById('timerText');
    if (timerElement) {
      timerElement.textContent = `in ${minutes}:${secs.toString().padStart(2, '0')}`;
    }
    
    if (seconds <= 0) {
      clearInterval(updateTimer);
      if (timerElement) {
        timerElement.textContent = 'Processing...';
      }
    }
  }, 1000);
}

// Add export function
window.exportSummary = function() {
  showMessage('Export feature coming soon!', 'info');
}
// 全局变量
let recordingStartTime = null;
let durationUpdateInterval = null;
let nextSegmentCountdownInterval = null;
let latestDecisionsData = [];

// 1️⃣ 初始化进度监控
window.initializeProgressMonitoring = function() {
  console.log('🎯 Starting progress monitoring');
  
  recordingStartTime = Date.now();
  const intervalMin = formData.intervalMin || 5;
  
  // 显示开始时间
  const startTimeDisplay = document.getElementById('startTimeDisplay');
  if (startTimeDisplay) {
    startTimeDisplay.textContent = new Date().toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }
  
  // 启动定时器
  startDurationTimer();
  startNextSegmentCountdown(intervalMin);
  updateProgressStats(0, 0);
}

// 2️⃣ 时长定时器（每秒更新）
function startDurationTimer() {
  if (durationUpdateInterval) clearInterval(durationUpdateInterval);
  
  durationUpdateInterval = setInterval(() => {
    if (!recordingStartTime) return;
    
    const elapsed = Date.now() - recordingStartTime;
    const minutes = Math.floor(elapsed / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    
    const durationDisplay = document.getElementById('durationDisplay');
    if (durationDisplay) {
      durationDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
  }, 1000);
}

// 3️⃣ 倒计时定时器（每秒更新）
function startNextSegmentCountdown(intervalMin) {
  if (nextSegmentCountdownInterval) clearInterval(nextSegmentCountdownInterval);
  
  const intervalMs = intervalMin * 60000;
  let nextSegmentTime = Date.now() + intervalMs;
  
  nextSegmentCountdownInterval = setInterval(() => {
    const remaining = nextSegmentTime - Date.now();
    
    if (remaining <= 0) {
      nextSegmentTime = Date.now() + intervalMs;
      const reminderText = document.getElementById('segmentReminderText');
      if (reminderText) {
        reminderText.innerHTML = 'New segment analyzed! Click <strong>Refresh</strong> to update.';
        setTimeout(() => {
          reminderText.innerHTML = `Recording in progress. Next AI analysis in <strong id="segmentCountdown">--</strong>`;
        }, 3000);
      }
    }
    
    updateSegmentCountdown(Math.floor(remaining / 1000));
  }, 1000);
}

// 4️⃣ 更新倒计时显示
function updateSegmentCountdown(totalSeconds) {
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  
  const nextSegmentTime = document.getElementById('nextSegmentTime');
  if (nextSegmentTime) {
    nextSegmentTime.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }
  
  const segmentCountdown = document.getElementById('segmentCountdown');
  if (segmentCountdown) {
    segmentCountdown.textContent = `${minutes}m ${seconds}s`;
  }
}

// 5️⃣ 更新统计数据
window.updateProgressStats = function(decisionsCount, speakersCount) {
  const decisionsCountEl = document.getElementById('decisionsCount');
  const speakersCountEl = document.getElementById('speakersCount');
  
  if (decisionsCountEl) decisionsCountEl.textContent = decisionsCount;
  if (speakersCountEl) speakersCountEl.textContent = speakersCount;
}

// 6️⃣ 更新最新决策
window.updateLatestDecisions = function(decisions) {
  latestDecisionsData = decisions;
  
  const latestDecisionsEl = document.getElementById('latestDecisions');
  if (!latestDecisionsEl) return;
  
  if (!decisions || decisions.length === 0) {
    latestDecisionsEl.innerHTML = '<em style="color: #999;">No decisions recorded yet. AI will analyze the discussion periodically.</em>';
    return;
  }
  
  const latest = decisions.slice(-3);
  latestDecisionsEl.innerHTML = latest.map((d, index) => {
    const decisionText = typeof d === 'string' ? d : (d.decision || d.text || '');
    const decisionNumber = typeof d === 'object' ? d.decision_number : (decisions.length - 2 + index);
    return `<div style="margin-bottom: 8px;">
      <strong style="color: #5E5CE6;">Decision ${decisionNumber}:</strong> ${decisionText}
    </div>`;
  }).join('');
}

// 7️⃣ 刷新按钮
window.refreshProgress = function() {
  console.log('🔄 Refreshing');
  if (latestDecisionsData && latestDecisionsData.length > 0) {
    updateLatestDecisions(latestDecisionsData);
  }
  showMessage('✅ Progress refreshed!', 'success');
}

// 8️⃣ 返回录音页面
window.goBackToRecording = function() {
  changePage(-1);
}

// 9️⃣ 停止监控
window.stopProgressMonitoring = function() {
  console.log('⏹️ Stopping monitoring');
  
  if (durationUpdateInterval) {
    clearInterval(durationUpdateInterval);
    durationUpdateInterval = null;
  }
  
  if (nextSegmentCountdownInterval) {
    clearInterval(nextSegmentCountdownInterval);
    nextSegmentCountdownInterval = null;
  }
  
  recordingStartTime = null;
}
    // Figma Integration
   window.insertToFigma = function() {
  // 收集页面上的数据
  const summaryText = `
Meeting Overview:
${document.getElementById('meetingOverview')?.textContent || 'No overview'}

Key Decisions:
${document.getElementById('keyDecisions')?.textContent || 'No decisions'}

Action Items:
${document.getElementById('actionItems')?.textContent || 'No actions'}
  `;
  
  console.log("Inserting to Figma:", summaryText);
  
  parent.postMessage({
    pluginMessage: {
      type: 'insert-summary',
      data: {
        summaryText: summaryText,
        formData: formData
      }
    }
  }, '*');
  
  // 通知用户
  showMessage('Summary inserted to Figma!', 'success');
}

    // Utility Functions
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `info-message ${type}`;
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.left = '50%';
      messageDiv.style.transform = 'translateX(-50%)';
      messageDiv.style.zIndex = '1000';
      messageDiv.innerHTML = `<span>${message}</span>`;
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    // Make changePage globally accessible
    window.changePage = changePage;

    // ===== 配置管理 =====
// 移除硬编码的BASE_URL，改为环境变量或动态配置
// 修改 changePage 函数
function changePage(direction) {
  // 如果在录音页面且正在录音，先停止
  if (currentPage === 3 && direction > 0 && isExternalRecording) {
    stopExternalRecording();
    return;
  }
  
  // 保存当前页面数据
  savePageData();
  
  // 验证
  if (direction > 0 && !validateCurrentPage()) {
    showMessage('Please fill in all required fields', 'warning');
    return;
  }
  
  // 切换页面
  currentPage += direction;
  if (currentPage < 1) currentPage = 1;
  if (currentPage > totalPages) currentPage = totalPages;
  
  // 准备录音页面
  if (currentPage === 3) {
    console.log('进入录音页，当前formData:', formData);
    prepareRecordingPage();
  }
  
  updatePageDisplay();
  animatePageTransition();
}
const API_CONFIG = {
  // 从环境获取或使用默认值
  BASE_URL: window.API_BASE_URL || 'https://fyp-2025-kath.vercel.app',
  endpoints: {
    controlSignals: '/api/stop',
    sessions: '/api/get',
    savePdf: '/api/save_pdf',
    stopRecording: '/api/stop',
    ingestPdf: '/api/ingest_pdf'
  },
  // 轮询配置
  polling: {
    interval: 2000,
    maxRetries: 3,
    timeout: 30000
  }
};

// ===== 录音相关全局变量（保持不变）=====
let recordingWindow = null;
let recordingSessionId = null;
let isExternalRecording = false;
let pollInterval = null;
let pollRetryCount = 0;

// ===== 统一的API调用函数（新增）=====
async function apiCall(endpoint, options = {}) {
  const url = endpoint.startsWith('http') 
    ? endpoint 
    : `${API_CONFIG.BASE_URL}${endpoint}`;
  
  const defaultOptions = {
    headers: {
      'Content-Type': 'application/json',
      ...options.headers
    },
    ...options
  };
  
  try {
    const response = await fetch(url, defaultOptions);
    
    if (!response.ok) {
      throw new Error(`API call failed: ${response.status} ${response.statusText}`);
    }
    
    return response;
  } catch (error) {
    console.error(`API call error for ${endpoint}:`, error);
    
    // 增加重试逻辑
    if (options.retry !== false && pollRetryCount < API_CONFIG.polling.maxRetries) {
      pollRetryCount++;
      console.log(`Retrying API call (${pollRetryCount}/${API_CONFIG.polling.maxRetries})...`);
      await new Promise(resolve => setTimeout(resolve, 1000));
      return apiCall(endpoint, { ...options, retry: false });
    }
    
    throw error;
  }
}

// ===== 修改 toggleRecording 函数（保持不变）=====
async function openExternalRecorder() {
  console.log('🚀 准备录音会话');

  if (!formData.module || !formData.meetingType) {
    console.warn('⚠️ 表单数据不完整，尝试重新获取...');
    savePageData();  // 尝试保存当前数据
    
    // 如果还是没有，提供默认值
    if (!formData.module) formData.module = 'DE4 ERO';
    if (!formData.meetingType) formData.meetingType = 'brainstorming';
  }
  
  console.log('📋 录音配置:', {
    module: formData.module,
    meetingType: formData.meetingType,
    role: formData.role
  });
  
  
  // 生成session ID
  recordingSessionId = Date.now().toString();
  
  // 获取设置（保留intervalMin名称）
  const cycleInput = document.getElementById('cycleInput');
  const intervalMin = cycleInput ? parseInt(cycleInput.value || '10', 10) : 10;

  const params = new URLSearchParams({
    // 原有参数
    session: recordingSessionId,
    intervalMin: intervalMin.toString(),
    
    // 新增：表单配置数据
    module: formData.module || 'DE4 ERO',
    meetingType: formData.meetingType || 'brainstorming',
    role: formData.role || 'student',
    projectWeek: formData.projectWeek || '',
    groupName: formData.groupName || '',
    groupNumber: formData.groupNumber || '',
    meetingGoals: encodeURIComponent(formData.meetingGoals || ''),
    // 团队成员用竖线分隔，避免逗号造成的解析问题
    teamMembers: (formData.teamMembers || []).join('|')
  });

  // 打开录音窗口，URL 现在包含所有需要的数据
  const recorderUrl = `${API_CONFIG.BASE_URL}/record.html?${params.toString()}`;
  console.log('📡 打开录音窗口，URL:', recorderUrl);
  window.open(recorderUrl, 'recorder', 'width=400,height=400');

  parent.postMessage({
  pluginMessage: {
    type: 'start-meeting',
    data: {
      sessionId: recordingSessionId,
      intervalMin: intervalMin,
      module: formData.module,
      meetingType: formData.meetingType,
      role: formData.role,
      projectWeek: formData.projectWeek,
      teamMembers: formData.teamMembers || []
    }
  }
}, '*');
  
  
  // 先保存所有配置到服务器
  const setupSuccess = await setupRecordingSession(intervalMin);
  
  if (!setupSuccess) {
    showMessage('Failed to setup recording session', 'warning');
    return;
  }
  
  // 显示用户友好的界面，让用户主动打开录音页面
  showRecordingInstructions(intervalMin);
}

async function setupRecordingSession(intervalMin) {
  try {
    console.log('📡 保存会话设置...');
    
    // 1. 保存配置
    await apiCall(API_CONFIG.endpoints.controlSignals, {
      method: 'POST',
      body: JSON.stringify({
        session_id: recordingSessionId,
        command: 'set_cycle',
        value: intervalMin
      })
    });
    console.log(`✅ 间隔设置已保存: 每${intervalMin}分钟自动总结`);
    
    // 2. 如果有PDF，保存它
    if (formData.pdfText && formData.pdfText.trim().length > 0) {
      console.log('📄 保存PDF内容...');
      const pdfSaved = await savePdfToServer(recordingSessionId, formData.pdfText);
      if (pdfSaved) {
        console.log('✅ PDF已保存');
      } else {
        console.warn('⚠️ PDF保存失败，但继续');
      }
    }
    // 额外显示计算信息
    const segmentsNeeded = Math.ceil(intervalMin / 5);
    console.log(`📊 配置详情: ${segmentsNeeded}个5分钟录音段后触发总结`);
    
    
    return true;
  } catch (err) {
    console.error('Setup failed:', err);
    return false;
  }
}

function showRecordingInstructions(intervalMin) {
  // 计算需要几个5分钟的segments
  const segmentsNeeded = Math.ceil(intervalMin / 5);
  const actualInterval = segmentsNeeded * 5;
  
  // 传递intervalMin参数到record.html
  const recordingURL = `${API_CONFIG.BASE_URL}/record.html?session=${recordingSessionId}&intervalMin=${intervalMin}&start=true`;
  
  // 更新录音页面UI
  const recordingInterface = document.getElementById('recording-interface');
  if (recordingInterface) {
    recordingInterface.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div class="info-message success" style="margin-bottom: 20px;">
          <span>✅</span>
          <span>Recording session ready! Choose how to open:</span>
        </div>
        
        <div style="background: #f7f7f7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p><strong>Session ID:</strong> ${recordingSessionId}</p>
          <p><strong>Processing:</strong> Every 5 minutes</p>
          <p><strong>Auto-summarize:</strong> Every ${actualInterval} minutes (${segmentsNeeded} segments)</p>
          ${intervalMin !== actualInterval ? `<p><small>Adjusted from ${intervalMin} to ${actualInterval} minutes</small></p>` : ''}
          ${formData.pdfText ? '<p>✅ PDF document uploaded</p>' : ''}
        </div>
        
        <!-- Option 1: Copy Link -->
        <button class="btn btn-primary" onclick="copyRecordingLink('${recordingURL}')" style="margin: 10px;">
          📋 Copy Recording Link
        </button>
        
        <!-- Option 2: Try to Open -->
        <button class="btn btn-secondary" onclick="attemptOpenRecorder('${recordingURL}')" style="margin: 10px;">
          🔗 Open Recording Page
        </button>
        
        <div style="margin-top: 30px;">
          <button class="btn btn-secondary" onclick="checkRecordingStatus()">
            Check Status
          </button>
          <button class="btn btn-secondary" onclick="stopExternalRecording()" style="margin-left: 10px;">
            Stop Recording
          </button>
        </div>
      </div>
    `;
  }
  
  // 开始轮询
  startPolling(recordingSessionId);
  
  // 更新状态
  isExternalRecording = true;
  isRecording = true;
  updateRecordingUI(true);
   formData.intervalMin = intervalMin;
  initializeProgressMonitoring();
}
async function stopExternalRecording() {
  console.log('🛑 Stopping external recording...');
  
  // 1. 发送停止信号到服务器
  if (recordingSessionId) {
    try {
      await apiCall(API_CONFIG.endpoints.stopRecording, {
        method: 'POST',
        body: JSON.stringify({
          session_id: recordingSessionId,
          command: 'stop'
        })
      });
      console.log('✅ Stop signal sent');
    } catch (err) {
      console.error('Error sending stop signal:', err);
    }
  }
  
  // 2. 关闭录音窗口
  if (recordingWindow && !recordingWindow.closed) {
    recordingWindow.close();
  }
  
  // 3. 停止轮询
  if (pollInterval) {
    clearInterval(pollInterval);
    pollInterval = null;
  }
  
  // 4. 更新状态
  isExternalRecording = false;
  isRecording = false;
   stopProgressMonitoring();
  
  // 5. 更新UI - 显示处理中
  updateRecordingUI(false, true);
  showMessage('Recording stopped. Processing results...', 'info');
  

  // 6. 获取最终结果并跳转到第四页
setTimeout(async () => {
  try {
    const res = await apiCall(`${API_CONFIG.endpoints.sessions}?session=${recordingSessionId}`);
    const data = await res.json();
    
    if (data && data.summary) {
      // 保存结果
      formData.results = {
        transcript: data.transcript || '',
        summary: data.summary || '',
        decisions: data.decision || [],
        explicit: data.explicit || [],
        tacit: data.tacit || [],
        reasoning: data.reasoning || '',
        suggestions: data.suggestions || []
      };
      
      displaySummaryResults(formData.results);
    } else {
      // 即使没有数据也显示demo页面
      displaySummaryResults(null);
    }
    
    // 无论如何都跳转到第四页
    currentPage = 4;
    updatePageDisplay();
    
  } catch (err) {
    console.error('Error fetching final results:', err);
    // 出错时也显示demo页面
    currentPage = 4;
    updatePageDisplay();
    displaySummaryResults(null);
  }
  
  // 重置UI
  resetRecordingUI();
}, 2000);
  // // 6. 获取最终结果
  // setTimeout(async () => {
  //   try {
  //     const res = await apiCall(`${API_CONFIG.endpoints.sessions}?session=${recordingSessionId}`);
  //     const data = await res.json();
      
  //     if (data && data.summary) {
  //       // 保存结果
  //       formData.results = {
  //         transcript: data.transcript || '',
  //         summary: data.summary || '',
  //         decisions: data.decision || [],
  //         explicit: data.explicit || [],
  //         tacit: data.tacit || [],
  //         reasoning: data.reasoning || '',
  //         suggestions: data.suggestions || []
  //       };
        
  //       // 显示结果页
  //       currentPage = 4;
  //       updatePageDisplay();
  //       displaySummaryResults(formData.results);
  //     }
  //   } catch (err) {
  //     console.error('Error fetching final results:', err);
  //   }
    
  //   // 重置UI
  //   resetRecordingUI();
  // }, 2000);
}


// ===== 新增：显示弹窗被拦截的消息和替代方案 =====
function showPopupBlockedMessage() {
  const messageHTML = `
    <div id="popupBlockedMessage" style="
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #ff9800;
      border-radius: 8px;
      padding: 20px;
      z-index: 10000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-width: 400px;
    ">
      <h3 style="margin-top: 0; color: #ff9800;">⚠️ Popup Blocked</h3>
      <p>Your browser blocked the recording window. Please choose an option:</p>
      
      <div style="margin: 15px 0;">
        <button onclick="allowPopupAndRetry()" style="
          background: #4CAF50;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 10px;
        ">
          Allow Popups & Retry
        </button>
        
        <button onclick="openInNewTab()" style="
          background: #2196F3;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
        ">
          Open in New Tab
        </button>
      </div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
        <p style="margin: 0; font-size: 14px; color: #666;">
          <strong>To enable popups:</strong><br>
          1. Click the popup blocker icon in your browser's address bar<br>
          2. Select "Always allow popups from this site"<br>
          3. Click the recording button again
        </p>
      </div>
      
      <button onclick="closePopupMessage()" style="
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #999;
      ">×</button>
    </div>
  `;
  
  // 添加到页面
  const div = document.createElement('div');
  div.innerHTML = messageHTML;
  document.body.appendChild(div);
}

// ===== 辅助函数：重试打开弹窗 =====
window.allowPopupAndRetry = function() {
  closePopupMessage();
  
  // 提示用户先允许弹窗
  alert('Please allow popups for this site in your browser settings, then click OK to retry.');
  
  // 重试打开
  setTimeout(() => {
    openExternalRecorder();
  }, 100);
};

// ===== 辅助函数：在新标签页打开 =====
window.openInNewTab = function() {
  closePopupMessage();
  
  // 生成session ID
  recordingSessionId = Date.now().toString();
  
  // 在新标签页打开
  const recordUrl = `${API_CONFIG.BASE_URL}/record.html?session=${recordingSessionId}&start=true`;
  const newTab = window.open(recordUrl, '_blank');
  
  if (newTab) {
    // 更新UI状态
    updateRecordingUI(true);
    isExternalRecording = true;
    isRecording = true;
    
    // 开始轮询
    startPolling(recordingSessionId);
    
    // 设置记录窗口引用
    recordingWindow = newTab;
    checkRecordingWindowStatus();
    
    // 保存设置
    saveRecordingSettings(recordingSessionId);
  }
};

// ===== 辅助函数：关闭弹窗消息 =====
window.closePopupMessage = function() {
  const message = document.getElementById('popupBlockedMessage');
  if (message) {
    message.parentElement.remove();
  }
};

// ===== 辅助函数：保存录音设置 =====
async function saveRecordingSettings(sessionId) {
  const cycleInput = document.getElementById('cycleInput');
  const intervalMin = cycleInput ? parseInt(cycleInput.value || '5', 10) : 5;
  
  try {
    await apiCall(API_CONFIG.endpoints.controlSignals, {
      method: 'POST',
      body: JSON.stringify({
        session_id: sessionId,
        command: 'set_cycle',
        value: intervalMin
      })
    });
    
    if (formData.pdfText) {
      await savePdfToServer(sessionId, formData.pdfText);
    }
  } catch (err) {
    console.error('Error saving settings:', err);
  }
}

// ===== 新增：监控录音窗口状态 =====
function checkRecordingWindowStatus() {
  const checkInterval = setInterval(() => {
    if (recordingWindow && recordingWindow.closed) {
      // 窗口被用户关闭
      console.log('Recording window was closed by user');
      clearInterval(checkInterval);
      
      if (isExternalRecording) {
        // 如果还在录音中，停止录音
        stopExternalRecording();
      }
    }
    
    if (!isExternalRecording) {
      // 录音已停止，停止检查
      clearInterval(checkInterval);
    }
  }, 1000);
}

// ===== 替代方案：使用内嵌iframe（如果允许）=====
function openRecorderInIframe() {
  const iframeHTML = `
    <div id="recorderIframeContainer" style="
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      background: white;
      border: 2px solid #333;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    ">
      <div style="
        background: #333;
        color: white;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <span>Recording Window</span>
        <button onclick="closeRecorderIframe()" style="
          background: #ff4444;
          color: white;
          border: none;
          padding: 5px 15px;
          border-radius: 4px;
          cursor: pointer;
        ">Close</button>
      </div>
      <iframe 
        id="recorderIframe"
        src="${API_CONFIG.BASE_URL}/record.html?session=${recordingSessionId}&start=true"
        style="width: 100%; height: calc(100% - 40px); border: none;">
      </iframe>
    </div>
  `;
  
  const div = document.createElement('div');
  div.innerHTML = iframeHTML;
  document.body.appendChild(div);
}

window.closeRecorderIframe = function() {
  const container = document.getElementById('recorderIframeContainer');
  if (container) {
    container.remove();
    if (isExternalRecording) {
      stopExternalRecording();
    }
  }
};
// function startPolling(sessionId) {
//   let lastShownSummary = '';
//   let pollTimeoutId = null;
  
//   // 设置超时
//   pollTimeoutId = setTimeout(() => {
//     if (pollInterval) {
//       clearInterval(pollInterval);
//       console.warn('Polling timeout reached');
//       showError('Recording timeout. Please check your connection and try again.');
//     }
//   }, API_CONFIG.polling.timeout);
  
//   pollInterval = setInterval(async () => {
//     try {
//       const res = await apiCall(`${API_CONFIG.endpoints.sessions}?session=${sessionId}`);
//       const data = await res.json();
      
//       if (data && data.summary && data.summary !== lastShownSummary) {
//         lastShownSummary = data.summary;
        
//         // 清除超时
//         if (pollTimeoutId) {
//           clearTimeout(pollTimeoutId);
//         }
        
//         // 存储结果（增加数据验证）
//         formData.results = {
//           transcript: data.transcript || '',
//           summary: data.summary || '',
//           decisions: Array.isArray(data.decision) ? data.decision : [],
//           explicit: Array.isArray(data.explicit) ? data.explicit : [],
//           tacit: Array.isArray(data.tacit) ? data.tacit : [],
//           reasoning: data.reasoning || '',
//           suggestions: Array.isArray(data.suggestions) ? data.suggestions : []
//         };
        
//         // 保存到本地存储
//         await saveToPluginStorage('lastMeetingResults', formData.results);
        
//         // 如果录音已停止，显示结果
//         if (!isExternalRecording) {
//           clearInterval(pollInterval);
//           displaySummaryResults(formData.results);
          
//           // 发送给Figma插件
//           sendResultsToFigma(data);
//         }
//       }
//     } catch (err) {
//       console.error('Polling error:', err);
//       // 不立即停止轮询，可能是临时网络问题
//     }
//   }, API_CONFIG.polling.interval);
// }
function startPolling(sessionId) {
  // 初始化状态变量
  let lastTranscript = '';          // 上次处理的transcript
  let lastDecisions = [];           // 累积的决策列表
  let pollTimeoutId = null;         // 超时计时器ID
  let pollCount = 0;                // 轮询次数计数
  
  console.log('🔄 开始轮询，Session ID:', sessionId);
  
  // 设置超时处理（30秒后停止轮询）
  pollTimeoutId = setTimeout(() => {
    if (pollInterval) {
      clearInterval(pollInterval);
      console.warn('⚠️ 轮询超时');
      showMessage('Recording timeout. Please check your connection.', 'warning');
    }
  }, API_CONFIG.polling.timeout || 30000);
  
  // 开始定期轮询
  pollInterval = setInterval(async () => {
    pollCount++;
    console.log(`📡 轮询 #${pollCount} - Session: ${sessionId}`);
    
    try {
      // 1. 从服务器获取当前transcript
      const res = await fetch(`${API_CONFIG.BASE_URL}/api/get?session=${sessionId}`);
      
      if (!res.ok) {
        console.error('❌ 轮询请求失败:', res.status);
        return;
      }
      
      const data = await res.json();
      
      // 2. 检查是否有新的transcript内容
      if (data && data.transcript) {
        // 检查transcript是否有更新
        const currentTranscript = data.transcript;
        const hasNewContent = currentTranscript.length > lastTranscript.length;
        
        if (hasNewContent) {
          console.log('📝 发现新内容，长度:', currentTranscript.length);
          
          // 清除超时（说明还在活动）
          if (pollTimeoutId) {
            clearTimeout(pollTimeoutId);
            // 重新设置超时
            pollTimeoutId = setTimeout(() => {
              clearInterval(pollInterval);
              console.warn('⚠️ 轮询超时');
            }, 30000);
          }
          
          // 3. 提取新增的部分
          const newSegment = currentTranscript.substring(lastTranscript.length);
          console.log('🆕 新增内容长度:', newSegment.length);
          
          // 4. 调用实时分析（如果新内容足够长）
          if (newSegment.length > 50) {  // 至少50个字符才分析
            console.log('🎯 调用实时分析...');
            
            // 准备避免重复的内容
            const avoidContent = lastDecisions.length > 0 
              ? JSON.stringify(lastDecisions) 
              : '';
            
            // 调用实时分析API
            const analysisResult = await callRealtimeSummarize(
              newSegment,  // 只分析新增部分
              avoidContent // 传递之前的决策以避免重复
            );
            
            // 5. 处理分析结果
            if (analysisResult && analysisResult.decisions) {
              const newDecisions = analysisResult.decisions;
              
              if (newDecisions.length > 0) {
                console.log(`✅ 发现 ${newDecisions.length} 个新决策`);
                
                // 重新编号决策
                newDecisions.forEach((decision, index) => {
                  decision.decision_number = lastDecisions.length + index + 1;
                });
                
                // 累积决策
                lastDecisions = [...lastDecisions, ...newDecisions];
                
                // 更新UI
                displayRealtimeDecisions(lastDecisions);
                
                // 保存到formData
                formData.results = {
                  ...formData.results,
                  decisions: lastDecisions,
                  transcript: currentTranscript,
                  analysisTime: new Date().toISOString()
                };
                
                // 保存到本地存储
                saveToPluginStorage('lastMeetingResults', formData.results);
                
                // 显示通知
                showMessage(`Found ${newDecisions.length} new decision(s)`, 'success');
              }
            }
          }
          
          // 更新lastTranscript
          lastTranscript = currentTranscript;
        }
      }
      
      // 6. 检查是否应该执行总结（基于间隔设置）
      const cycleInput = document.getElementById('cycleInput');
      const intervalMin = parseInt(cycleInput?.value || '5');
      const shouldSummarize = pollCount % (intervalMin * 12) === 0;  // 每分钟轮询12次（5秒一次）
      
      if (shouldSummarize && data.transcript) {
        console.log('📊 触发周期性总结...');
        
        // 这里可以调用更全面的分析
        // 但通常实时分析就足够了
      }
      
      // 7. 如果录音已停止
      if (data.recording_stopped || !isExternalRecording) {
        console.log('🛑 检测到录音停止');
        clearInterval(pollInterval);
        clearTimeout(pollTimeoutId);
        
        // 最终处理
        if (lastDecisions.length > 0) {
          displaySummaryResults(formData.results);
        }
        
        // 发送结果给Figma插件
        if (data) {
          sendResultsToFigma({
            ...data,
            decisions: lastDecisions
          });
        }
      }
      
    } catch (err) {
      console.error('❌ 轮询错误:', err);
      
      // 错误重试机制
      pollRetryCount = (pollRetryCount || 0) + 1;
      
      if (pollRetryCount >= API_CONFIG.polling.maxRetries) {
        console.error('❌ 达到最大重试次数，停止轮询');
        clearInterval(pollInterval);
        clearTimeout(pollTimeoutId);
        showMessage('Connection lost. Please check your network.', 'error');
      }
    }
    
  }, API_CONFIG.polling.interval || 5000);  // 每5秒轮询一次
  
  // 返回清理函数
  return () => {
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }
    if (pollTimeoutId) {
      clearTimeout(pollTimeoutId);
      pollTimeoutId = null;
    }
  };
}

// ===== 辅助函数：停止轮询 =====
function stopPolling() {
  if (pollInterval) {
    clearInterval(pollInterval);
    pollInterval = null;
    console.log('🛑 轮询已停止');
  }
}
// ===== 优化的PDF保存函数 =====

async function savePdfToServer(sessionId, pdfText) {
  console.log('📚 === 开始 savePdfToServer 函数 ===');
  
  // 输入验证
  if (!sessionId) {
    console.error('❌ 没有session ID');
    return false;
  }
  
  if (!pdfText || pdfText.trim().length === 0) {
    console.error('❌ PDF文本为空');
    return false;
  }
  
  // 限制大小
  const maxLength = 500000;
  let textToSave = pdfText;
  if (pdfText.length > maxLength) {
    console.warn(`⚠️ PDF太大 (${pdfText.length}字符), 截断到${maxLength}字符`);
    textToSave = pdfText.substring(0, maxLength);
  }
  
  // 显示详细信息
  console.log('📋 PDF保存参数:');
  console.log('  - API端点:', `${API_CONFIG.BASE_URL}${API_CONFIG.endpoints.savePdf}`);
  console.log('  - Session ID:', sessionId);
  console.log('  - 原始文本长度:', pdfText.length);
  console.log('  - 保存文本长度:', textToSave.length);
  console.log('  - 文件名:', formData.pdfFileName || 'context.pdf');
  console.log('  - 模块:', formData.module || 'unknown');
  console.log('  - 会议类型:', formData.meetingType || 'unknown');
  
  try {
    // 构建请求体
    const requestBody = {
      session_id: sessionId,
      pdf_text: textToSave,
      filename: formData.pdfFileName || 'context.pdf',
      metadata: {
        uploadTime: new Date().toISOString(),
        textLength: textToSave.length,
        module: formData.module || 'unknown',
        meetingType: formData.meetingType || 'unknown'
      }
    };
    
    console.log('📤 发送POST请求到:', `${API_CONFIG.BASE_URL}${API_CONFIG.endpoints.savePdf}`);
    console.log('📤 请求体大小:', JSON.stringify(requestBody).length, '字符');
    
    // 发送请求
    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.endpoints.savePdf}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    console.log('📥 响应状态码:', response.status);
    console.log('📥 响应状态文本:', response.statusText);
    console.log('📥 响应头:', {
      'content-type': response.headers.get('content-type'),
      'content-length': response.headers.get('content-length')
    });
    
    // 获取响应文本
    const responseText = await response.text();
    console.log('📥 原始响应内容:', responseText);
    console.log('📥 响应长度:', responseText.length, '字符');
    
    // 检查HTTP状态
    if (!response.ok) {
      console.error('❌ 服务器返回错误状态:', response.status);
      console.error('❌ 错误详情:', responseText);
      
      // 尝试解析错误信息
      try {
        const errorData = JSON.parse(responseText);
        console.error('❌ 错误对象:', errorData);
      } catch (e) {
        console.error('❌ 错误响应不是JSON格式');
      }
      
      return false;
    }
    
    // 尝试解析JSON响应
    let result = null;
    try {
      result = JSON.parse(responseText);
      console.log('✅ 成功解析JSON响应:', result);
      
      // 检查响应中的成功标志
      if (result.ok || result.success || result.status === 'success') {
        console.log('✅ PDF成功保存到Supabase!');
        console.log('  - 保存时间:', new Date().toISOString());
        console.log('  - Session:', sessionId);
        return true;
      } else {
        console.warn('⚠️ 响应中没有明确的成功标志');
        console.log('  - 响应对象:', result);
      }
      
    } catch (parseError) {
      console.warn('⚠️ 响应不是有效的JSON:', parseError.message);
      
      // 如果状态码是200-299，即使不是JSON也认为成功
      if (response.status >= 200 && response.status < 300) {
        console.log('✅ 基于HTTP状态码判断PDF已保存');
        console.log('  - 状态码:', response.status);
        console.log('  - 响应内容:', responseText.substring(0, 100));
        return true;
      }
    }
    
    // 默认返回false
    console.warn('⚠️ 无法确认PDF是否保存成功');
    return false;
    
  } catch (error) {
    console.error('❌ PDF保存过程发生异常:', error);
    console.error('  - 错误类型:', error.name);
    console.error('  - 错误消息:', error.message);
    console.error('  - 错误堆栈:', error.stack);
    
    // 网络错误特殊处理
    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
      console.error('❌ 网络连接错误，请检查:');
      console.error('  1. API服务器是否运行');
      console.error('  2. 网络连接是否正常');
      console.error('  3. CORS设置是否正确');
    }
    
    return false;
    
  } finally {
    console.log('📚 === 结束 savePdfToServer 函数 ===');
  }
}

// ===== 新增辅助函数 =====
function updateRecordingUI(isRecording, isProcessing = false) {
  const recordButton = document.getElementById('recordButton');
  const recordButtonText = document.getElementById('recordButtonText');
  const recordingStatus = document.getElementById('recordingStatus');
  const stopRecordingBtn = document.getElementById('stopRecordingBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (isRecording) {
    recordButton?.classList.add('recording');
    if (recordButtonText) recordButtonText.textContent = 'Recording in Progress';
    if (recordingStatus) recordingStatus.textContent = 'Recording in external window - DO NOT CLOSE';
    if (stopRecordingBtn) stopRecordingBtn.style.display = 'block';
    if (nextBtn) nextBtn.style.display = 'none';
  } else if (isProcessing) {
    recordButton?.classList.remove('recording');
    if (recordButtonText) recordButtonText.textContent = 'Processing...';
    if (recordingStatus) recordingStatus.textContent = 'Processing your recording...';
    if (recordButton) recordButton.disabled = true;
    if (stopRecordingBtn) stopRecordingBtn.style.display = 'none';
  } else {
    resetRecordingUI();
  }
}

function resetRecordingUI() {
  const recordButton = document.getElementById('recordButton');
  const recordButtonText = document.getElementById('recordButtonText');
  const recordingStatus = document.getElementById('recordingStatus');
  const stopRecordingBtn = document.getElementById('stopRecordingBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  recordButton?.classList.remove('recording');
  if (recordButtonText) recordButtonText.textContent = 'Start Recording';
  if (recordingStatus) recordingStatus.textContent = '';
  if (recordButton) recordButton.disabled = false;
  if (stopRecordingBtn) stopRecordingBtn.style.display = 'none';
  if (nextBtn) nextBtn.style.display = 'block';
}

function sendResultsToFigma(data) {
  parent.postMessage({
    pluginMessage: {
      type: 'analyze-transcript',
      transcript: data.transcript,
      summary: data.summary,
      decision: data.decision,
      explicit: data.explicit,
      tacit: data.tacit,
      reasoning: data.reasoning,
      suggestions: data.suggestions
    }
  }, '*');
}

function showError(message) {
  // 显示错误消息的函数
  console.error(message);
  const errorDiv = document.getElementById('errorMessage');
  if (errorDiv) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }
}

// ===== 修改原有函数的兼容性包装 =====
async function startRecording() {
  await openExternalRecorder();
}

function stopRecording() {
  if (isExternalRecording) {
    stopExternalRecording();
  }
}

// ===== 初始化时检查环境 =====
(function initializeAPIConfig() {
  // 检查是否在开发环境
  if (window.location.hostname === 'localhost') {
    API_CONFIG.BASE_URL = 'http://localhost:3000';
    console.log('Using local development server');
  }
  
  // 检查是否有自定义配置
  if (window.customAPIConfig) {
    Object.assign(API_CONFIG, window.customAPIConfig);
  }
})();

// 复制链接函数
window.copyRecordingLink = async function(url) {
  try {
    await navigator.clipboard.writeText(url);
    showMessage('Link copied! Paste it in your browser.', 'success');
  } catch (err) {
    // 备用方法
    const textArea = document.createElement('textarea');
    textArea.value = url;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showMessage('Link copied!', 'success');
  }
}

// 尝试打开录音页面
window.attemptOpenRecorder = function(url) {
  console.log('用户点击打开录音页面');
  
  const newWindow = window.open(url, '_blank');
  
  if (!newWindow || newWindow.closed) {
    showMessage('Popup blocked. Please use "Copy Link" instead.', 'warning');
    // 自动复制链接
    copyRecordingLink(url);
  } else {
    showMessage('Recording page opened!', 'success');
    recordingWindow = newWindow;
    checkRecordingWindowStatus();
  }
}

// 检查录音状态
window.checkRecordingStatus = async function() {
  try {
    const res = await fetch(`${API_CONFIG.BASE_URL}/api/get?session=${recordingSessionId}`);
    const data = await res.json();
    
    if (data && data.transcript) {
      showMessage('Recording in progress...', 'info');
    } else {
      showMessage('No recording detected yet', 'warning');
    }
  } catch (err) {
    showMessage('Could not check status', 'warning');
  }
}

  </script>
</body>
</html>

