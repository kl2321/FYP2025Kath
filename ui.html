<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; margin-top: 12px; height: 200px; overflow-y: auto; }
    button { padding: 8px 16px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <div id="result">⏳ Waiting for result...</div>

  <script>
  const openBtn = document.getElementById('openBtn');
  const resultBox = document.getElementById('result');
  let recorderWindow = null;
  let ready = false;

  // 👆 点击打开 recorder.html
  openBtn.onclick = () => {
    recorderWindow = window.open(
      'https://fyp-2025-kath.vercel.app/record.html',
      '_blank',
      'width=500,height=400'
    );
    console.log("✅ Recorder window opened");
  };

  // 👂 监听所有来自 record.html 的消息
  window.addEventListener('message', (event) => {
    const msg = event.data;

    // ✅ Recorder 页面准备好了
    if (msg?.type === 'ready-to-record') {
      console.log('✅ Recorder ready, sending start signal...');
      ready = true;
      recorderWindow?.postMessage({ type: 'start-recording' }, '*');
    }

    // ✅ 收到分析结果
    if (msg?.pluginMessage?.type === 'analyze-transcript') {
      const { transcript, summary } = msg.pluginMessage;
      console.log('📥 Received transcript & summary');
      resultBox.textContent = `📝 Transcript:\n${transcript}\n\n🧠 Summary:\n${summary}`;

      // 转发给 code.ts 插件主线程
      parent.postMessage({
        pluginMessage: {
          type: 'analyze-transcript',
          transcript,
          summary
        }
      }, '*');
    }
  });
</script>
 
</body>
</html> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; margin-top: 12px; height: 200px; overflow-y: auto; }
    button { padding: 8px 16px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <div id="result">⏳ Waiting for result...</div>

  <script>
    const openBtn = document.getElementById('openBtn');
    const resultBox = document.getElementById('result');

    openBtn.onclick = () => {
      // 通过 URL 参数触发 record.html 自动开始录音
      window.open(
        'https://fyp-2025-kath.vercel.app/record.html?start=true',
        'recordWindow',
        'width=500,height=400'
      );
      console.log("✅ Recorder window opened with ?start=true");
    };

    // 监听 record.html 返回的分析结果
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      if (msg?.type === 'analyze-transcript') {
        const { transcript, summary } = msg;
        console.log("📥 Received transcript & summary");

        resultBox.textContent = `📝 Transcript:\n${transcript}\n\n🧠 Summary:\n${summary}`;

        // 发送给 code.ts 插入 Figma 画布
        parent.postMessage({
          pluginMessage: {
            type: 'analyze-transcript',
            transcript,
            summary
          }
        }, '*');
      }
    });
  </script>
</body>
</html> -->


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 300px; overflow-y: auto; margin-top: 12px; }
    button { padding: 8px 16px; font-weight: bold; margin-right: 8px; }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>
  <div id="result">⏳ Waiting for result...</div>

  <script>
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultBox = document.getElementById('result');

    openBtn.onclick = () => {
      const sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      poll(sessionId);
    };

    stopBtn.onclick = () => {
      if (recorderWindow) {
        recorderWindow.postMessage({ type: 'stop-recording' }, '*');
        console.log("🛑 Sent stop-recording to recorder window");
      }
    };

    function poll(sessionId) {
      const interval = setInterval(async () => {
        try {
          const res = await fetch(`https://inyqglzldyhuvenrfyli.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlueXFnbHpsZHlodXZlbnJmeWxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5Njg4ODAsImV4cCI6MjA2MzU0NDg4MH0.5jyzoEVJf7eBNk3Y4cUTd-pQPNTjz2B9yFlo7t36auc',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlueXFnbHpsZHlodXZlbnJmeWxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5Njg4ODAsImV4cCI6MjA2MzU0NDg4MH0.5jyzoEVJf7eBNk3Y4cUTd-pQPNTjz2B9yFlo7t36auc',
              'Content-Type': 'application/json'
            }
          });

          const data = await res.json();
          console.log("📥 Got from Supabase:", data);

          if (Array.isArray(data) && data.length > 0 && data[0].summary) {
            clearInterval(interval);

            const item = data[0];
            resultBox.textContent = `📝 Transcript:\n${item.transcript}\n\n🧠 Summary:\n${item.summary}`;

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary
              }
            }, '*');
          }
        } catch (err) {
          console.error("❌ Supabase polling failed:", err);
        }
      }, 1000);
    }

      

    function sendTest() {
      console.log("📤 Sending TEST message...");
      parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
    }
  </script>
</body>
</html>




<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 200px; overflow-y: auto; }
    button { padding: 8px 16px; font-weight: bold; }
    
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <div id="result">⏳ Waiting for result...</div>
  <button onclick="sendTest()">Send Test Message</button>

  <script>
  //   function sendTest() {
  //   console.log("📤 Sending TEST message...");
  //   parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
  // }
    
    const openBtn = document.getElementById('openBtn');
    const resultBox = document.getElementById('result');

    openBtn.onclick = () => {
      const sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      poll(sessionId);
    };

    function poll(sessionId) {
      const interval = setInterval(async () => {
        const res = await fetch(`https://fyp-2025-kath.vercel.app/api/get?session=${sessionId}`);
        const data = await res.json();
        if (data.summary) {
          clearInterval(interval);
          console.log("📥 Got result:", data);

          resultBox.textContent = `📝 Transcript:\n${data.transcript}\n\n🧠 Summary:\n${data.summary}`;

          console.log("📤 Sending pluginMessage...", { transcript, summary });

          // 通知插件主线程插入文字
          parent.postMessage({
            pluginMessage: {
              type: 'analyze-transcript',
              transcript: data.transcript,
              summary: data.summary
            }
          }, '*');
        }
      }, 1000);
    }
  </script>
</body>
</html> -->
