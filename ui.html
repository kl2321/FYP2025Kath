<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; margin-top: 12px; height: 200px; overflow-y: auto; }
    button { padding: 8px 16px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <div id="result">⏳ Waiting for result...</div>

  <script>
    const openBtn = document.getElementById('openBtn');
    const resultBox = document.getElementById('result');
    let recorderWindow = null;
    // 点击打开新窗口
    openBtn.onclick = () => {
      recorderWindow = window.open('https://fyp-2025-kath.vercel.app/record.html', '_blank', 'width=500,height=400');
      console.log("window opened");
    };

    // 等窗口打开后，发消息给它
  const trySendMessage = () => {
    if (recorderWindow) {
      recorderWindow.postMessage({ type: 'start-recording' }, '*');
    } else {
      console.warn("⚠️ Recorder window not ready yet.");
    }
  };

  // 尝试多次发送，避免窗口未加载完接收不到
  const interval = setInterval(() => {
    trySendMessage();
  }, 300);

  setTimeout(() => clearInterval(interval), 2000); // 最多发送 2 秒



    // 接收来自 record.html 的分析结果
    window.addEventListener('message', (event) => {
      console.log("record received");
      const msg = event.data.pluginMessage;
      if (msg?.type === 'analyze-transcript') {
        const { transcript, summary } = msg;
        resultBox.textContent = `📝 Transcript:\n${transcript}\n\n🧠 Summary:\n${summary}`;

        // 发送给 Figma 插件 code.ts 插入画布
        parent.postMessage({
          pluginMessage: {
            type: 'analyze-transcript',
            transcript: msg.transcript,
            summary: msg.summary
          }
        }, '*');
      }
    });
  </script>
</body>
</html>
