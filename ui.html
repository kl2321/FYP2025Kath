<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Meeting Assistant</title>
  <style>
    /* [保持原有的所有CSS样式不变] */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #333;
      padding: 0;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Progress Indicator */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      background: #f7f7f7;
      border-bottom: 1px solid #e5e5e5;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .progress-step::after {
      content: '';
      position: absolute;
      top: 15px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e5e5e5;
      z-index: 0;
    }

    .progress-step:last-child::after {
      display: none;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e5e5e5;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .progress-step.active .step-circle {
      background: #5E5CE6;
      color: white;
    }

    .progress-step.completed .step-circle {
      background: #30D158;
      color: white;
    }

    .step-label {
      margin-top: 8px;
      font-size: 11px;
      color: #666;
      font-weight: 500;
    }

    .progress-step.active .step-label {
      color: #5E5CE6;
      font-weight: 600;
    }

    /* Page Container */
    .page-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }

    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d1d1;
      border-radius: 6px;
      font-size: 13px;
      transition: all 0.2s;
      background: white;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #5E5CE6;
      box-shadow: 0 0 0 3px rgba(94, 92, 230, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    /* Radio/Checkbox Groups */
    .radio-group,
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radio-item,
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .radio-item:hover,
    .checkbox-item:hover {
      background: #f7f7f7;
      border-color: #5E5CE6;
    }

    .radio-item input[type="radio"],
    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
    }

    .radio-item.selected,
    .checkbox-item.selected {
      background: #F0F0FF;
      border-color: #5E5CE6;
    }

    /* File Upload Area */
    .upload-area {
      border: 2px dashed #d1d1d1;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }

    .upload-area:hover {
      border-color: #5E5CE6;
      background: #F0F0FF;
    }

    .upload-area.dragover {
      border-color: #5E5CE6;
      background: #F0F0FF;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 48px;
      color: #999;
      margin-bottom: 10px;
    }

    .upload-text {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .upload-hint {
      color: #999;
      font-size: 12px;
    }

    .file-list {
      margin-top: 16px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f7f7f7;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-name {
      font-size: 13px;
      color: #333;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-remove {
      color: #999;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .file-remove:hover {
      background: #e5e5e5;
      color: #ff3b30;
    }

    /* Recording Interface */
    .recording-interface {
      text-align: center;
      padding: 40px 20px;
    }

    .record-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%);
      border: none;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .record-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 30px rgba(255, 59, 48, 0.4);
    }

    .record-button.recording {
      background: linear-gradient(135deg, #666 0%, #999 100%);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3); }
      50% { box-shadow: 0 4px 40px rgba(255, 59, 48, 0.6); }
      100% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3); }
    }

    .recording-time {
      margin-top: 20px;
      font-size: 24px;
      font-weight: 300;
      color: #333;
      font-variant-numeric: tabular-nums;
    }

    .recording-status {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    /* Navigation Buttons */
    .navigation {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      border-top: 1px solid #e5e5e5;
      background: #fafafa;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-secondary {
      background: white;
      color: #666;
      border: 1px solid #d1d1d1;
    }

    .btn-secondary:hover {
      background: #f7f7f7;
      border-color: #999;
    }

    .btn-primary {
      background: #5E5CE6;
      color: white;
    }

    .btn-primary:hover {
      background: #4B49D8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(94, 92, 230, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Success/Info Messages */
    .info-message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-message.success {
      background: #E8F5E9;
      color: #2E7D32;
      border: 1px solid #A5D6A7;
    }

    .info-message.info {
      background: #E3F2FD;
      color: #1565C0;
      border: 1px solid #90CAF9;
    }

    .info-message.warning {
      background: #FFF3E0;
      color: #EF6C00;
      border: 1px solid #FFB74D;
    }

    .option-card {
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
}

.option-card h4 {
  margin-top: 0;
  color: #333;
}
  </style>
</head>
<body>
  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Basic Info</div>
    </div>
    <div class="progress-step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Meeting Setup</div>
    </div>
    <div class="progress-step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Recording</div>
    </div>
    <div class="progress-step" data-step="4">
      <div class="step-circle">4</div>
      <div class="step-label">Summary</div>
    </div>
  </div>

  <!-- Page Container -->
  <div class="page-container">
    <!-- Page 1: Basic Information -->
    <div class="page active" id="page1">
      <h2 style="margin-bottom: 24px;">Meeting Configuration</h2>
      
      <div class="form-group">
        <label>Your Role *</label>
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" id="student" name="role" value="student" checked>
            <label for="student" style="margin: 0;">Student</label>
          </div>
          <div class="radio-item">
            <input type="radio" id="tutor" name="role" value="tutor">
            <label for="tutor" style="margin: 0;">Tutor/Instructor</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="module">Course Module *</label>
        <select id="module" required>
          <option value="">Select a module...</option>
          <option value="DE4 ERO">DE4 ERO</option>
          <option value="IDE2 TTL">IDE2 TTL</option>
          <option value="DE3 Futures ">DE3 Futures</option>
          <option value="DE3 I&E">DE3 I&E</option>
          <option value="xxx">xxx</option>
        </select>
      </div>

      <div class="form-group">
        <label for="meeting-type">Meeting Type *</label>
        <select id="meeting-type" required>
          <option value="">Select meeting type...</option>
          <option value="brainstorming">Brainstorming Session</option>
          <option value="decision-making">Decision Making</option>
          <option value="progress-update">Progress Update</option>
          <option value="problem-solving">Problem Solving</option>
          <option value="retrospective">Retrospective</option>
        </select>
      </div>

      <div class="form-group">
        <label for="team-members">Team Members (optional)</label>
        <input type="text" id="team-members" placeholder="Enter names separated by commas">
        <small style="color: #999; font-size: 11px; margin-top: 4px; display: block;">
          This helps with speaker identification
        </small>
      </div>

      <div class="form-group">
        <label for="meeting-goals">Meeting Goals (optional)</label>
        <textarea id="meeting-goals" placeholder="What do you hope to achieve in this meeting?"></textarea>
      </div>
    </div>

    <!-- Page 2: File Upload & Settings -->
    <div class="page" id="page2">
      <h2 style="margin-bottom: 24px;">Upload Supporting Materials</h2>
      
      <div class="info-message info">
        <span>💡</span>
        <span>Upload any relevant documents to provide context for better AI analysis</span>
      </div>

      <div class="form-group">
        <label>Supporting Documents (optional)</label>
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">📁</div>
          <div class="upload-text">Click to upload or drag and drop</div>
          <div class="upload-hint">PDF, DOC, DOCX, TXT, Images (Max 10MB)</div>
          <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;">
        </div>
        <div class="file-list" id="fileList"></div>
      </div>

      <div class="form-group">
        <label>Analysis Preferences</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="key-decisions" checked>
            <label for="key-decisions" style="margin: 0;">Extract Key Decisions</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="action-items" checked>
            <label for="action-items" style="margin: 0;">Identify Action Items</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="speaker-analysis">
            <label for="speaker-analysis" style="margin: 0;">Analyze Speaker Contributions</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="sentiment-analysis">
            <label for="sentiment-analysis" style="margin: 0;">Include Sentiment Analysis</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 3: Recording -->
<div class="page" id="page3">
  <h2 style="margin-bottom: 24px;">Start Recording</h2>

  <div id="recording-interface"></div>
    
    <!-- 添加录音间隔设置 -->
    <div style="margin-top: 30px;">
      <label for="cycleInput">Summary interval (minutes):</label>
      <input id="cycleInput" type="number" value="5" min="1" max="30" 
             style="width: 80px; padding: 8px; margin-left: 10px;">
    </div>
    
    <div style="margin-top: 40px;">
      <div class="info-message info" style="text-align: left;">
        <span>ℹ️</span>
        <div>
          <strong>Recording Instructions:</strong><br>
          • A new window will open for recording<br>
          • Allow microphone access when prompted<br>  
          • Recording will auto-save every 5 minutes<br>
          • You can stop recording from this page
        </div>
      </div>
    </div>
  </div>
  
  <!-- 添加停止按钮（初始隐藏） -->
  <div style="text-align: center; margin-top: 20px;">
    <button class="btn btn-secondary" id="stopRecordingBtn" style="display: none;">
      Stop Recording
    </button>
  </div>
</div>

  <!-- Navigation -->
  <div class="navigation">
    <button class="btn btn-secondary" id="prevBtn" onclick="changePage(-1)">Previous</button>
    <button class="btn btn-primary" id="nextBtn" onclick="changePage(1)">Next</button>
  </div>

  <script>
    // // ===== MODIFIED STORAGE SOLUTION FOR FIGMA PLUGIN =====
    // // Use in-memory storage and communicate with plugin for persistence
    
    // State Management (in-memory)
    let currentPage = 1;
    const totalPages = 4;
    let formData = {
      role: 'student',
      module: '',
      meetingType: '',
      teamMembers: [],
      meetingGoals: '',
      files: [],
      preferences: {
        keyDecisions: true,
        actionItems: true,
        speakerAnalysis: false,
        sentimentAnalysis: false
      },
      additionalContext: '',
      pdfText: '',
      pdfFileName: ''
    };

    // // Recording state
     let isRecording = false;
    // let recordingStartTime = null;
    // let recordingInterval = null;
    // let mediaRecorder = null;
    // let audioChunks = [];

    // ===== STORAGE FUNCTIONS (Modified for Figma) =====
    
    // Save data to plugin storage via postMessage
    function saveToPluginStorage(key, value) {
      parent.postMessage({
        pluginMessage: {
          type: 'save-storage',
          key: key,
          value: value
        }
      }, '*');
    }

    // Request data from plugin storage
    function loadFromPluginStorage(key) {
      parent.postMessage({
        pluginMessage: {
          type: 'load-storage',
          key: key
        }
      }, '*');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updatePageDisplay();
      setupEventListeners();
      // Request saved data from plugin
      loadFromPluginStorage('meetingFormData');
    });

    // Listen for messages from plugin
    window.onmessage = (event) => {
      const message = event.data.pluginMessage;
      if (!message) return;

      switch (message.type) {
        case 'storage-loaded':
          if (message.key === 'meetingFormData' && message.value) {
            formData = message.value;
            restoreFormFields();
          }
          break;
        case 'processing-complete':
          displaySummaryResults(message.results);
          break;
        case 'processing-error':
          showMessage(message.error, 'warning');
          break;
      }
    };

    // Page Navigation
    function changePage(direction) {
      // Save current page data
      savePageData();

      // Validate before moving forward
      if (direction > 0 && !validateCurrentPage()) {
        showMessage('Please fill in all required fields', 'warning');
        return;
      }

      // Change page
      currentPage += direction;
      if (currentPage < 1) currentPage = 1;
      if (currentPage > totalPages) currentPage = totalPages;

      // Special handling for recording page
      if (currentPage === 3) {
        prepareRecordingPage();
      }

      // Update display
      updatePageDisplay();
      
      // Animate transition
      animatePageTransition();
    }

    function updatePageDisplay() {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });

      // Show current page
      document.getElementById(`page${currentPage}`).classList.add('active');

      // Update progress bar
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        if (index < currentPage - 1) {
          step.classList.add('completed');
          step.classList.remove('active');
        } else if (index === currentPage - 1) {
          step.classList.add('active');
          step.classList.remove('completed');
        } else {
          step.classList.remove('active', 'completed');
        }
      });

      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      prevBtn.style.display = currentPage === 1 ? 'none' : 'block';
      
      if (currentPage === 3) {
        nextBtn.textContent = 'Finish Recording';
        nextBtn.style.display = isRecording ? 'block' : 'none';
      } else if (currentPage === 4) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.textContent = 'Next';
        nextBtn.style.display = 'block';
      }
    }

    function animatePageTransition() {
      const activePage = document.querySelector('.page.active');
      activePage.style.animation = 'none';
      setTimeout(() => {
        activePage.style.animation = 'fadeIn 0.3s ease';
      }, 10);
    }

    // Event Listeners Setup
    function setupEventListeners() {
      // File upload
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
          handleFiles(e.target.files);
        });
      }

      // Radio buttons visual feedback
      document.querySelectorAll('.radio-item').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.radio-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          item.querySelector('input[type="radio"]').checked = true;
        });
      });

      // Checkbox visual feedback
      document.querySelectorAll('.checkbox-item').forEach(item => {
        item.addEventListener('click', () => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          item.classList.toggle('selected', checkbox.checked);
        });
      });

      // Recording button
      const recordButton = document.getElementById('recordButton');
      if (recordButton) {
        recordButton.addEventListener('click', toggleRecording);
      }

      const stopBtn = document.getElementById('stopRecordingBtn');

       const stopRecordingBtn = document.getElementById('stopRecordingBtn');
  if (stopRecordingBtn) {
    stopRecordingBtn.addEventListener('click', () => {
      console.log('Stop button clicked');
      stopExternalRecording();  // 调用停止函数
    });
  }

    }

    // File Handling
    // File Handling
async function handleFiles(files) {
  const fileList = document.getElementById('fileList');
  
  for (const file of Array.from(files)) {
    // Validate file
    if (file.size > 10 * 1024 * 1024) {
      showMessage(`File ${file.name} is too large (max 10MB)`, 'warning');
      continue;
    }

    // 如果是PDF文件，进行特殊处理
    if (file.type === 'application/pdf') {
      console.log('📄 Processing PDF file:', file.name);
      
      // 保存文件名
      formData.pdfFileName = file.name;
      
      // 使用服务器端PDF处理
      try {
        showMessage('Processing PDF...', 'info');
        
        const pdfFormData = new FormData();
        pdfFormData.append('file', file);
        
        const response = await fetch(`${API_CONFIG.BASE_URL}/api/ingest_pdf`, {
          method: 'POST',
          body: pdfFormData
        });
        
        const result = await response.json();
        
        if (result?.text && result.text.length > 0) {
          formData.pdfText = result.text;
  formData.pdfFileName = file.name;  // 确保文件名也被保存
  
  // 添加这些调试日志
  console.log('✅ PDF处理完成:');
  console.log('  - 文件名:', formData.pdfFileName);
  console.log('  - 文本长度:', formData.pdfText.length);
  console.log('  - 前100字符:', formData.pdfText.substring(0, 100));
          showMessage(`PDF processed: ${(result.text.length/1000).toFixed(1)}k characters`, 'success');
        } else {
          showMessage('Could not extract text from PDF', 'warning');
        }
      } catch (err) {
        console.error('PDF processing error:', err);
        showMessage('Failed to process PDF', 'warning');
      }
    }

    // Store file metadata
    formData.files.push({
      name: file.name,
      size: file.size,
      type: file.type
    });

    // Display file
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <span class="file-name">${file.name}</span>
      <span class="file-remove" onclick="removeFile('${file.name}')">✕</span>
    `;
    fileList.appendChild(fileItem);

    // Send file info to plugin
    parent.postMessage({
      pluginMessage: {
        type: 'file-upload',
        fileName: file.name,
        fileType: file.type,
        fileSize: file.size
      }
    }, '*');
  }
}

// Make removeFile globally accessible
window.removeFile = function(fileName) {
  console.log('Removing file:', fileName);
  formData.files = formData.files.filter(f => f.name !== fileName);
  updateFileList();
  
  // 如果是PDF文件，清除PDF文本
  if (fileName === formData.pdfFileName) {
    formData.pdfText = '';
    formData.pdfFileName = '';
    console.log('Cleared PDF text cache');
  }
}

// Update file list display
function updateFileList() {
  const fileList = document.getElementById('fileList');
  if (!fileList) {
    console.warn('fileList element not found');
    return;
  }
  
  fileList.innerHTML = '';
  
  if (!formData.files || formData.files.length === 0) {
    console.log('No files to display');
    return;
  }
  
  formData.files.forEach(file => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <span class="file-name">${file.name}</span>
      <span class="file-remove" onclick="removeFile('${file.name}')">✕</span>
    `;
    fileList.appendChild(fileItem);
  });
  
  console.log(`Updated file list with ${formData.files.length} files`);
}
 

    // Recording Functions
    async function toggleRecording() {
      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    }

    async function startRecording() {
      try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          // Create audio blob
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          
          // Process recording
          await processRecording(audioBlob);
        };

        // Start recording
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();

        // Update UI
        document.getElementById('recordButton').classList.add('recording');
        document.getElementById('recordButtonText').textContent = 'Stop Recording';
        document.getElementById('recordingStatus').textContent = 'Recording in progress...';
        document.getElementById('nextBtn').style.display = 'block';

        // Start timer
        recordingInterval = setInterval(updateRecordingTime, 1000);

      } catch (error) {
        console.error('Error starting recording:', error);
        showMessage('Failed to access microphone. Please check permissions.', 'warning');
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        
        // Stop all tracks
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        isRecording = false;
        clearInterval(recordingInterval);

        // Update UI
        document.getElementById('recordButton').classList.remove('recording');
        document.getElementById('recordButtonText').textContent = 'Processing...';
        document.getElementById('recordingStatus').textContent = 'Processing your recording...';
        document.getElementById('recordButton').disabled = true;
      }
    }

    // function updateRecordingTime() {
    //   const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    //   const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    //   const seconds = (elapsed % 60).toString().padStart(2, '0');
    //   document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
    // }

    // async function processRecording(audioBlob) {
    //   // Move to summary page
    //   currentPage = 4;
    //   updatePageDisplay();

    //   // Convert blob to base64 for Figma plugin communication
    //   const reader = new FileReader();
    //   reader.onloadend = () => {
    //     parent.postMessage({
    //       pluginMessage: {
    //         type: 'process-recording',
    //         formData: formData,
    //         audioData: reader.result
    //       }
    //     }, '*');
    //   };
    //   reader.readAsDataURL(audioBlob);
    // }

    // Form Validation
    function validateCurrentPage() {
      if (currentPage === 1) {
        const module = document.getElementById('module').value;
        const meetingType = document.getElementById('meeting-type').value;
        
        if (!module || !meetingType) {
          return false;
        }
      }
      return true;
    }

    // Data Persistence
    function savePageData() {
      if (currentPage === 1) {
        formData.role = document.querySelector('input[name="role"]:checked').value;
        formData.module = document.getElementById('module').value;
        formData.meetingType = document.getElementById('meeting-type').value;
        formData.teamMembers = document.getElementById('team-members').value.split(',').map(s => s.trim()).filter(Boolean);
        formData.meetingGoals = document.getElementById('meeting-goals').value;
      } else if (currentPage === 2) {
        formData.preferences.keyDecisions = document.getElementById('key-decisions').checked;
        formData.preferences.actionItems = document.getElementById('action-items').checked;
        formData.preferences.speakerAnalysis = document.getElementById('speaker-analysis').checked;
        formData.preferences.sentimentAnalysis = document.getElementById('sentiment-analysis').checked;
      }

      // Save to plugin storage
      saveToPluginStorage('meetingFormData', formData);
    }

    function restoreFormFields() {
      // Page 1 fields
      if (document.getElementById('module')) {
        document.getElementById('module').value = formData.module || '';
        document.getElementById('meeting-type').value = formData.meetingType || '';
        document.getElementById('team-members').value = formData.teamMembers.join(', ');
        document.getElementById('meeting-goals').value = formData.meetingGoals || '';
        
        // Radio buttons
        document.querySelector(`input[name="role"][value="${formData.role}"]`).checked = true;
      }

      // Page 2 fields
      if (document.getElementById('key-decisions')) {
        document.getElementById('key-decisions').checked = formData.preferences.keyDecisions;
        document.getElementById('action-items').checked = formData.preferences.actionItems;
        document.getElementById('speaker-analysis').checked = formData.preferences.speakerAnalysis;
        document.getElementById('sentiment-analysis').checked = formData.preferences.sentimentAnalysis;
      }

      // Update file list
      if (document.getElementById('fileList')) {
      updateFileList();
    }
  }

    function prepareRecordingPage() {
  // Display configuration summary
  const readyMessage = document.getElementById('readyMessage');
  
  // 构建消息内容
  let messageContent = `
    <span>✅</span>
    <div>
      <strong>Ready to record!</strong><br>
      Module: ${formData.module.replace('-', ' ')}<br>
      Meeting Type: ${formData.meetingType.replace('-', ' ')}<br>`;
  
  // 添加文件信息
  if (formData.files.length > 0) {
    messageContent += `${formData.files.length} supporting file(s) uploaded<br>`;
  }
  
  // 添加PDF信息
  if (formData.pdfText && formData.pdfText.length > 0) {
    messageContent += `📄 PDF loaded: ${(formData.pdfText.length/1000).toFixed(1)}k characters<br>`;
  }
  
  messageContent += `</div>`;
  
  readyMessage.innerHTML = messageContent;
}

    // Summary Display
    function displaySummaryResults(results) {
      const page4 = document.getElementById('page4');
      page4.innerHTML = `
        <h2 style="margin-bottom: 24px;">Meeting Summary</h2>
        <div style="background: #f7f7f7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <h3 style="margin-bottom: 8px;">Overview</h3>
          <p>${results.overview || 'Processing...'}</p>
        </div>
        <div style="margin-top: 24px; text-align: center;">
          <button class="btn btn-primary" onclick="insertToFigma()">Insert to Figma</button>
        </div>
      `;
    }

    // Figma Integration
    window.insertToFigma = function() {
      parent.postMessage({
        pluginMessage: {
          type: 'insert-summary',
          data: formData
        }
      }, '*');
    }

    // Utility Functions
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `info-message ${type}`;
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.left = '50%';
      messageDiv.style.transform = 'translateX(-50%)';
      messageDiv.style.zIndex = '1000';
      messageDiv.innerHTML = `<span>${message}</span>`;
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    // Make changePage globally accessible
    window.changePage = changePage;

    // ===== 配置管理 =====
// 移除硬编码的BASE_URL，改为环境变量或动态配置
// 修改 changePage 函数
function changePage(direction) {
  // 如果在录音页面且正在录音，先停止
  if (currentPage === 3 && direction > 0 && isExternalRecording) {
    stopExternalRecording();
    return;
  }
  
  // 保存当前页面数据
  savePageData();
  
  // 验证
  if (direction > 0 && !validateCurrentPage()) {
    showMessage('Please fill in all required fields', 'warning');
    return;
  }
  
  // 切换页面
  currentPage += direction;
  if (currentPage < 1) currentPage = 1;
  if (currentPage > totalPages) currentPage = totalPages;
  
  // 准备录音页面
  if (currentPage === 3) {
    prepareRecordingPage();
  }
  
  updatePageDisplay();
  animatePageTransition();
}
const API_CONFIG = {
  // 从环境获取或使用默认值
  BASE_URL: window.API_BASE_URL || 'https://fyp-2025-kath.vercel.app',
  endpoints: {
    controlSignals: '/api/stop',
    sessions: '/api/get',
    savePdf: '/api/save_pdf',
    stopRecording: '/api/stop',
    ingestPdf: '/api/ingest_pdf'
  },
  // 轮询配置
  polling: {
    interval: 2000,
    maxRetries: 3,
    timeout: 30000
  }
};

// ===== 录音相关全局变量（保持不变）=====
let recordingWindow = null;
let recordingSessionId = null;
let isExternalRecording = false;
let pollInterval = null;
let pollRetryCount = 0;

// ===== 统一的API调用函数（新增）=====
async function apiCall(endpoint, options = {}) {
  const url = endpoint.startsWith('http') 
    ? endpoint 
    : `${API_CONFIG.BASE_URL}${endpoint}`;
  
  const defaultOptions = {
    headers: {
      'Content-Type': 'application/json',
      ...options.headers
    },
    ...options
  };
  
  try {
    const response = await fetch(url, defaultOptions);
    
    if (!response.ok) {
      throw new Error(`API call failed: ${response.status} ${response.statusText}`);
    }
    
    return response;
  } catch (error) {
    console.error(`API call error for ${endpoint}:`, error);
    
    // 增加重试逻辑
    if (options.retry !== false && pollRetryCount < API_CONFIG.polling.maxRetries) {
      pollRetryCount++;
      console.log(`Retrying API call (${pollRetryCount}/${API_CONFIG.polling.maxRetries})...`);
      await new Promise(resolve => setTimeout(resolve, 1000));
      return apiCall(endpoint, { ...options, retry: false });
    }
    
    throw error;
  }
}

// ===== 修改 toggleRecording 函数（保持不变）=====
async function toggleRecording() {
  await openExternalRecorder();
}

// ===== 优化的打开外部录音窗口函数 =====
async function openExternalRecorder() {
  console.log('🚀 准备录音会话');
  
  // 生成session ID
  recordingSessionId = Date.now().toString();
  
  // 获取设置
  const cycleInput = document.getElementById('cycleInput');
  const intervalMin = cycleInput ? parseInt(cycleInput.value || '5', 10) : 5;
  
  // 先保存所有配置到服务器
  const setupSuccess = await setupRecordingSession(intervalMin);
  
  if (!setupSuccess) {
    showMessage('Failed to setup recording session', 'warning');
    return;
  }
  
  // 显示用户友好的界面，让用户主动打开录音页面
  showRecordingInstructions(intervalMin);
}

async function setupRecordingSession(intervalMin) {
  try {
    console.log('📡 保存会话设置...');
    
    // 1. 保存配置
    await apiCall(API_CONFIG.endpoints.controlSignals, {
      method: 'POST',
      body: JSON.stringify({
        session_id: recordingSessionId,
        command: 'set_cycle',
        value: intervalMin
      })
    });
    console.log('✅ 间隔设置已保存');
    
    // 2. 如果有PDF，保存它
    if (formData.pdfText && formData.pdfText.trim().length > 0) {
      console.log('📄 保存PDF内容...');
      const pdfSaved = await savePdfToServer(recordingSessionId, formData.pdfText);
      if (pdfSaved) {
        console.log('✅ PDF已保存');
      } else {
        console.warn('⚠️ PDF保存失败，但继续');
      }
    }
    
    return true;
  } catch (err) {
    console.error('Setup failed:', err);
    return false;
  }
}

function showRecordingInstructions(intervalMin) {
  const recordingURL = `${API_CONFIG.BASE_URL}/record.html?session=${recordingSessionId}&start=true`;
  
  // 更新录音页面UI
  const recordingInterface = document.getElementById('recording-interface');
  if (recordingInterface) {
    recordingInterface.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div class="info-message success" style="margin-bottom: 20px;">
          <span>✅</span>
          <span>Recording session ready! Choose how to open:</span>
        </div>
        
        <div style="background: #f7f7f7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p><strong>Session ID:</strong> ${recordingSessionId}</p>
          <p><strong>Auto-save:</strong> Every ${intervalMin} minutes</p>
          ${formData.pdfText ? '<p>✅ PDF document uploaded</p>' : ''}
        </div>
        
        <!-- Option 1: Copy Link -->
        <button class="btn btn-primary" onclick="copyRecordingLink('${recordingURL}')" style="margin: 10px;">
          📋 Copy Recording Link
        </button>
        
        <!-- Option 2: Try to Open -->
        <button class="btn btn-secondary" onclick="attemptOpenRecorder('${recordingURL}')" style="margin: 10px;">
          🔗 Open Recording Page
        </button>
        
        <div style="margin-top: 30px;">
          <button class="btn btn-secondary" onclick="checkRecordingStatus()">
            Check Status
          </button>
          <button class="btn btn-secondary" onclick="stopExternalRecording()" style="margin-left: 10px;">
            Stop Recording
          </button>
        </div>
      </div>
    `;
  }
  
  // 开始轮询
  startPolling(recordingSessionId);
  
  // 更新状态
  isExternalRecording = true;
  isRecording = true;
  updateRecordingUI(true);
}
async function stopExternalRecording() {
  console.log('🛑 Stopping external recording...');
  
  // 1. 发送停止信号到服务器
  if (recordingSessionId) {
    try {
      await apiCall(API_CONFIG.endpoints.stopRecording, {
        method: 'POST',
        body: JSON.stringify({
          session_id: recordingSessionId,
          command: 'stop'
        })
      });
      console.log('✅ Stop signal sent');
    } catch (err) {
      console.error('Error sending stop signal:', err);
    }
  }
  
  // 2. 关闭录音窗口
  if (recordingWindow && !recordingWindow.closed) {
    recordingWindow.close();
  }
  
  // 3. 停止轮询
  if (pollInterval) {
    clearInterval(pollInterval);
    pollInterval = null;
  }
  
  // 4. 更新状态
  isExternalRecording = false;
  isRecording = false;
  
  // 5. 更新UI - 显示处理中
  updateRecordingUI(false, true);
  showMessage('Recording stopped. Processing results...', 'info');
  
  // 6. 获取最终结果
  setTimeout(async () => {
    try {
      const res = await apiCall(`${API_CONFIG.endpoints.sessions}?session=${recordingSessionId}`);
      const data = await res.json();
      
      if (data && data.summary) {
        // 保存结果
        formData.results = {
          transcript: data.transcript || '',
          summary: data.summary || '',
          decisions: data.decision || [],
          explicit: data.explicit || [],
          tacit: data.tacit || [],
          reasoning: data.reasoning || '',
          suggestions: data.suggestions || []
        };
        
        // 显示结果页
        currentPage = 4;
        updatePageDisplay();
        displaySummaryResults(formData.results);
      }
    } catch (err) {
      console.error('Error fetching final results:', err);
    }
    
    // 重置UI
    resetRecordingUI();
  }, 2000);
}


// ===== 新增：显示弹窗被拦截的消息和替代方案 =====
function showPopupBlockedMessage() {
  const messageHTML = `
    <div id="popupBlockedMessage" style="
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #ff9800;
      border-radius: 8px;
      padding: 20px;
      z-index: 10000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-width: 400px;
    ">
      <h3 style="margin-top: 0; color: #ff9800;">⚠️ Popup Blocked</h3>
      <p>Your browser blocked the recording window. Please choose an option:</p>
      
      <div style="margin: 15px 0;">
        <button onclick="allowPopupAndRetry()" style="
          background: #4CAF50;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 10px;
        ">
          Allow Popups & Retry
        </button>
        
        <button onclick="openInNewTab()" style="
          background: #2196F3;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
        ">
          Open in New Tab
        </button>
      </div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
        <p style="margin: 0; font-size: 14px; color: #666;">
          <strong>To enable popups:</strong><br>
          1. Click the popup blocker icon in your browser's address bar<br>
          2. Select "Always allow popups from this site"<br>
          3. Click the recording button again
        </p>
      </div>
      
      <button onclick="closePopupMessage()" style="
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #999;
      ">×</button>
    </div>
  `;
  
  // 添加到页面
  const div = document.createElement('div');
  div.innerHTML = messageHTML;
  document.body.appendChild(div);
}

// ===== 辅助函数：重试打开弹窗 =====
window.allowPopupAndRetry = function() {
  closePopupMessage();
  
  // 提示用户先允许弹窗
  alert('Please allow popups for this site in your browser settings, then click OK to retry.');
  
  // 重试打开
  setTimeout(() => {
    openExternalRecorder();
  }, 100);
};

// ===== 辅助函数：在新标签页打开 =====
window.openInNewTab = function() {
  closePopupMessage();
  
  // 生成session ID
  recordingSessionId = Date.now().toString();
  
  // 在新标签页打开
  const recordUrl = `${API_CONFIG.BASE_URL}/record.html?session=${recordingSessionId}&start=true`;
  const newTab = window.open(recordUrl, '_blank');
  
  if (newTab) {
    // 更新UI状态
    updateRecordingUI(true);
    isExternalRecording = true;
    isRecording = true;
    
    // 开始轮询
    startPolling(recordingSessionId);
    
    // 设置记录窗口引用
    recordingWindow = newTab;
    checkRecordingWindowStatus();
    
    // 保存设置
    saveRecordingSettings(recordingSessionId);
  }
};

// ===== 辅助函数：关闭弹窗消息 =====
window.closePopupMessage = function() {
  const message = document.getElementById('popupBlockedMessage');
  if (message) {
    message.parentElement.remove();
  }
};

// ===== 辅助函数：保存录音设置 =====
async function saveRecordingSettings(sessionId) {
  const cycleInput = document.getElementById('cycleInput');
  const intervalMin = cycleInput ? parseInt(cycleInput.value || '5', 10) : 5;
  
  try {
    await apiCall(API_CONFIG.endpoints.controlSignals, {
      method: 'POST',
      body: JSON.stringify({
        session_id: sessionId,
        command: 'set_cycle',
        value: intervalMin
      })
    });
    
    if (formData.pdfText) {
      await savePdfToServer(sessionId, formData.pdfText);
    }
  } catch (err) {
    console.error('Error saving settings:', err);
  }
}

// ===== 新增：监控录音窗口状态 =====
function checkRecordingWindowStatus() {
  const checkInterval = setInterval(() => {
    if (recordingWindow && recordingWindow.closed) {
      // 窗口被用户关闭
      console.log('Recording window was closed by user');
      clearInterval(checkInterval);
      
      if (isExternalRecording) {
        // 如果还在录音中，停止录音
        stopExternalRecording();
      }
    }
    
    if (!isExternalRecording) {
      // 录音已停止，停止检查
      clearInterval(checkInterval);
    }
  }, 1000);
}

// ===== 替代方案：使用内嵌iframe（如果允许）=====
function openRecorderInIframe() {
  const iframeHTML = `
    <div id="recorderIframeContainer" style="
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      background: white;
      border: 2px solid #333;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    ">
      <div style="
        background: #333;
        color: white;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <span>Recording Window</span>
        <button onclick="closeRecorderIframe()" style="
          background: #ff4444;
          color: white;
          border: none;
          padding: 5px 15px;
          border-radius: 4px;
          cursor: pointer;
        ">Close</button>
      </div>
      <iframe 
        id="recorderIframe"
        src="${API_CONFIG.BASE_URL}/record.html?session=${recordingSessionId}&start=true"
        style="width: 100%; height: calc(100% - 40px); border: none;">
      </iframe>
    </div>
  `;
  
  const div = document.createElement('div');
  div.innerHTML = iframeHTML;
  document.body.appendChild(div);
}

window.closeRecorderIframe = function() {
  const container = document.getElementById('recorderIframeContainer');
  if (container) {
    container.remove();
    if (isExternalRecording) {
      stopExternalRecording();
    }
  }
};
function startPolling(sessionId) {
  let lastShownSummary = '';
  let pollTimeoutId = null;
  
  // 设置超时
  pollTimeoutId = setTimeout(() => {
    if (pollInterval) {
      clearInterval(pollInterval);
      console.warn('Polling timeout reached');
      showError('Recording timeout. Please check your connection and try again.');
    }
  }, API_CONFIG.polling.timeout);
  
  pollInterval = setInterval(async () => {
    try {
      const res = await apiCall(`${API_CONFIG.endpoints.sessions}?session=${sessionId}`);
      const data = await res.json();
      
      if (data && data.summary && data.summary !== lastShownSummary) {
        lastShownSummary = data.summary;
        
        // 清除超时
        if (pollTimeoutId) {
          clearTimeout(pollTimeoutId);
        }
        
        // 存储结果（增加数据验证）
        formData.results = {
          transcript: data.transcript || '',
          summary: data.summary || '',
          decisions: Array.isArray(data.decision) ? data.decision : [],
          explicit: Array.isArray(data.explicit) ? data.explicit : [],
          tacit: Array.isArray(data.tacit) ? data.tacit : [],
          reasoning: data.reasoning || '',
          suggestions: Array.isArray(data.suggestions) ? data.suggestions : []
        };
        
        // 保存到本地存储
        await saveToPluginStorage('lastMeetingResults', formData.results);
        
        // 如果录音已停止，显示结果
        if (!isExternalRecording) {
          clearInterval(pollInterval);
          displaySummaryResults(formData.results);
          
          // 发送给Figma插件
          sendResultsToFigma(data);
        }
      }
    } catch (err) {
      console.error('Polling error:', err);
      // 不立即停止轮询，可能是临时网络问题
    }
  }, API_CONFIG.polling.interval);
}

// ===== 优化的PDF保存函数 =====

async function savePdfToServer(sessionId, pdfText) {
  console.log('📚 === 开始 savePdfToServer 函数 ===');
  
  // 输入验证
  if (!sessionId) {
    console.error('❌ 没有session ID');
    return false;
  }
  
  if (!pdfText || pdfText.trim().length === 0) {
    console.error('❌ PDF文本为空');
    return false;
  }
  
  // 限制大小
  const maxLength = 500000;
  let textToSave = pdfText;
  if (pdfText.length > maxLength) {
    console.warn(`⚠️ PDF太大 (${pdfText.length}字符), 截断到${maxLength}字符`);
    textToSave = pdfText.substring(0, maxLength);
  }
  
  // 显示详细信息
  console.log('📋 PDF保存参数:');
  console.log('  - API端点:', `${API_CONFIG.BASE_URL}${API_CONFIG.endpoints.savePdf}`);
  console.log('  - Session ID:', sessionId);
  console.log('  - 原始文本长度:', pdfText.length);
  console.log('  - 保存文本长度:', textToSave.length);
  console.log('  - 文件名:', formData.pdfFileName || 'context.pdf');
  console.log('  - 模块:', formData.module || 'unknown');
  console.log('  - 会议类型:', formData.meetingType || 'unknown');
  
  try {
    // 构建请求体
    const requestBody = {
      session_id: sessionId,
      pdf_text: textToSave,
      filename: formData.pdfFileName || 'context.pdf',
      metadata: {
        uploadTime: new Date().toISOString(),
        textLength: textToSave.length,
        module: formData.module || 'unknown',
        meetingType: formData.meetingType || 'unknown'
      }
    };
    
    console.log('📤 发送POST请求到:', `${API_CONFIG.BASE_URL}${API_CONFIG.endpoints.savePdf}`);
    console.log('📤 请求体大小:', JSON.stringify(requestBody).length, '字符');
    
    // 发送请求
    const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.endpoints.savePdf}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    console.log('📥 响应状态码:', response.status);
    console.log('📥 响应状态文本:', response.statusText);
    console.log('📥 响应头:', {
      'content-type': response.headers.get('content-type'),
      'content-length': response.headers.get('content-length')
    });
    
    // 获取响应文本
    const responseText = await response.text();
    console.log('📥 原始响应内容:', responseText);
    console.log('📥 响应长度:', responseText.length, '字符');
    
    // 检查HTTP状态
    if (!response.ok) {
      console.error('❌ 服务器返回错误状态:', response.status);
      console.error('❌ 错误详情:', responseText);
      
      // 尝试解析错误信息
      try {
        const errorData = JSON.parse(responseText);
        console.error('❌ 错误对象:', errorData);
      } catch (e) {
        console.error('❌ 错误响应不是JSON格式');
      }
      
      return false;
    }
    
    // 尝试解析JSON响应
    let result = null;
    try {
      result = JSON.parse(responseText);
      console.log('✅ 成功解析JSON响应:', result);
      
      // 检查响应中的成功标志
      if (result.ok || result.success || result.status === 'success') {
        console.log('✅ PDF成功保存到Supabase!');
        console.log('  - 保存时间:', new Date().toISOString());
        console.log('  - Session:', sessionId);
        return true;
      } else {
        console.warn('⚠️ 响应中没有明确的成功标志');
        console.log('  - 响应对象:', result);
      }
      
    } catch (parseError) {
      console.warn('⚠️ 响应不是有效的JSON:', parseError.message);
      
      // 如果状态码是200-299，即使不是JSON也认为成功
      if (response.status >= 200 && response.status < 300) {
        console.log('✅ 基于HTTP状态码判断PDF已保存');
        console.log('  - 状态码:', response.status);
        console.log('  - 响应内容:', responseText.substring(0, 100));
        return true;
      }
    }
    
    // 默认返回false
    console.warn('⚠️ 无法确认PDF是否保存成功');
    return false;
    
  } catch (error) {
    console.error('❌ PDF保存过程发生异常:', error);
    console.error('  - 错误类型:', error.name);
    console.error('  - 错误消息:', error.message);
    console.error('  - 错误堆栈:', error.stack);
    
    // 网络错误特殊处理
    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
      console.error('❌ 网络连接错误，请检查:');
      console.error('  1. API服务器是否运行');
      console.error('  2. 网络连接是否正常');
      console.error('  3. CORS设置是否正确');
    }
    
    return false;
    
  } finally {
    console.log('📚 === 结束 savePdfToServer 函数 ===');
  }
}

// ===== 新增辅助函数 =====
function updateRecordingUI(isRecording, isProcessing = false) {
  const recordButton = document.getElementById('recordButton');
  const recordButtonText = document.getElementById('recordButtonText');
  const recordingStatus = document.getElementById('recordingStatus');
  const stopRecordingBtn = document.getElementById('stopRecordingBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (isRecording) {
    recordButton?.classList.add('recording');
    if (recordButtonText) recordButtonText.textContent = 'Recording in Progress';
    if (recordingStatus) recordingStatus.textContent = 'Recording in external window - DO NOT CLOSE';
    if (stopRecordingBtn) stopRecordingBtn.style.display = 'block';
    if (nextBtn) nextBtn.style.display = 'none';
  } else if (isProcessing) {
    recordButton?.classList.remove('recording');
    if (recordButtonText) recordButtonText.textContent = 'Processing...';
    if (recordingStatus) recordingStatus.textContent = 'Processing your recording...';
    if (recordButton) recordButton.disabled = true;
    if (stopRecordingBtn) stopRecordingBtn.style.display = 'none';
  } else {
    resetRecordingUI();
  }
}

function resetRecordingUI() {
  const recordButton = document.getElementById('recordButton');
  const recordButtonText = document.getElementById('recordButtonText');
  const recordingStatus = document.getElementById('recordingStatus');
  const stopRecordingBtn = document.getElementById('stopRecordingBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  recordButton?.classList.remove('recording');
  if (recordButtonText) recordButtonText.textContent = 'Start Recording';
  if (recordingStatus) recordingStatus.textContent = '';
  if (recordButton) recordButton.disabled = false;
  if (stopRecordingBtn) stopRecordingBtn.style.display = 'none';
  if (nextBtn) nextBtn.style.display = 'block';
}

function sendResultsToFigma(data) {
  parent.postMessage({
    pluginMessage: {
      type: 'analyze-transcript',
      transcript: data.transcript,
      summary: data.summary,
      decision: data.decision,
      explicit: data.explicit,
      tacit: data.tacit,
      reasoning: data.reasoning,
      suggestions: data.suggestions
    }
  }, '*');
}

function showError(message) {
  // 显示错误消息的函数
  console.error(message);
  const errorDiv = document.getElementById('errorMessage');
  if (errorDiv) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }
}

// ===== 修改原有函数的兼容性包装 =====
async function startRecording() {
  await openExternalRecorder();
}

function stopRecording() {
  if (isExternalRecording) {
    stopExternalRecording();
  }
}

// ===== 初始化时检查环境 =====
(function initializeAPIConfig() {
  // 检查是否在开发环境
  if (window.location.hostname === 'localhost') {
    API_CONFIG.BASE_URL = 'http://localhost:3000';
    console.log('Using local development server');
  }
  
  // 检查是否有自定义配置
  if (window.customAPIConfig) {
    Object.assign(API_CONFIG, window.customAPIConfig);
  }
})();

// 复制链接函数
window.copyRecordingLink = async function(url) {
  try {
    await navigator.clipboard.writeText(url);
    showMessage('Link copied! Paste it in your browser.', 'success');
  } catch (err) {
    // 备用方法
    const textArea = document.createElement('textarea');
    textArea.value = url;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showMessage('Link copied!', 'success');
  }
}

// 尝试打开录音页面
window.attemptOpenRecorder = function(url) {
  console.log('用户点击打开录音页面');
  
  const newWindow = window.open(url, '_blank');
  
  if (!newWindow || newWindow.closed) {
    showMessage('Popup blocked. Please use "Copy Link" instead.', 'warning');
    // 自动复制链接
    copyRecordingLink(url);
  } else {
    showMessage('Recording page opened!', 'success');
    recordingWindow = newWindow;
    checkRecordingWindowStatus();
  }
}

// 检查录音状态
window.checkRecordingStatus = async function() {
  try {
    const res = await fetch(`${API_CONFIG.BASE_URL}/api/get?session=${recordingSessionId}`);
    const data = await res.json();
    
    if (data && data.transcript) {
      showMessage('Recording in progress...', 'info');
    } else {
      showMessage('No recording detected yet', 'warning');
    }
  } catch (err) {
    showMessage('Could not check status', 'warning');
  }
}

  </script>
</body>
</html>

<!-- <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }
    .card {
      background: #f3f3f3;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
    }
    .card button.toggle-btn {
      float: right;
      font-size: 18px;
      border: none;
      background: none;
      cursor: pointer;
    }
    .details {
      display: none;
      margin-top: 10px;
    }

    button {
      padding: 10px 18px;
      margin: 8px 8px 16px 0;
      font-weight: bold;
      margin-right: 6px;
    }
    #spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #ccc;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    // 2) 必须设置 worker 源，否则某些环境会报错/卡住
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
    }
  </script>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <label style="display:block; margin:8px 0 4px;">📄 Attach PDF (optional):</label>
  <input id="pdfInput" type="file" accept="application/pdf" />
  <small id="pdfStatus" style="display:block; color:#666; margin-bottom:12px;"></small>

  <label for="cycleInput">⏱️ Summary interval (minutes):</label>
  <input id="cycleInput" type="number" value="5" min="1" style="width: 60px; margin-left: 8px; margin-bottom: 12px;" />
  <br><br>

  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

   <div id="cardsContainer"></div>
  
  


  <script>
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    //const resultBox = document.getElementById('result');
    let sessionId = null;
    let lastShownSummary = '';

    let recorderWindow = null;
    let pdfTextCache = ""; // store extracted pdf text

 
    // 提前注册 message handler
    // window.addEventListener('message', function handler(e) {
    //   if (e.data?.type === 'ready-to-record') {
    //     console.log("✅ Recorder window is ready");
    //     console.log("🛎️ Got message from record:", e.data);

        

    //     const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);
    //     console.log("📤 Sending set-max-cycle:", intervalMin);
    //     recorderWindow?.postMessage({ type: 'set-max-cycle', value: intervalMin }, '*');

    //     window.removeEventListener('message', handler);
    //   }
    // });

    
    openBtn.onclick = async () => {
      sessionId = Date.now().toString();

  //  获取用户输入分钟数
      const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);

  //  发送 set_cycle 指令到 Supabase
  try {
    await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
      method: 'POST',
      headers: {
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        session_id: sessionId,
        command: 'set_cycle',
        value: intervalMin
      })
    });

    console.log("✅ Sent set_cycle to Supabase:", intervalMin);
  } catch (err) {
    console.error("❌ Failed to send set_cycle:", err);
  }

  //  打开 recorder 页面
  recorderWindow = window.open(
    `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
    'recorder',
    'width=500,height=400'
  );

  poll(sessionId);
};

// const pdfInput = document.getElementById('pdfInput');
// const pdfStatus = document.getElementById('pdfStatus');

// pdfInput.addEventListener('change', async (e) => {
//   const file = e.target.files?.[0];
//   if (!file) return;

//   pdfStatus.textContent = "⏳ Extracting text from PDF...";
//   try {
//     const form = new FormData();
//     form.append('file', file, file.name);
//     const res = await fetch('https://fyp-2025-kath.vercel.app/api/ingest_pdf', {
//       method: 'POST',
//       body: form
//     });
//     const data = await res.json();
//     if (!res.ok || !data?.text) {
//       pdfStatus.textContent = "❌ Failed to read PDF.";
//       return;
//     }
//     pdfTextCache = data.text;
//     pdfStatus.textContent = `✅ PDF loaded (${(data.text.length/1000).toFixed(1)}k chars)`;

//     // 如果录音窗口已打开，把 PDF 文本传给它
//     if (recorderWindow) {
//       recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, '*');
//     }
//   } catch (err) {
//     console.error("❌ PDF upload/parse error:", err);
//     pdfStatus.textContent = "❌ PDF parse error.";
//   }
// });

const pdfInput = document.getElementById('pdfInput');
    const pdfStatus = document.getElementById('pdfStatus'); // 可选的状态文本

    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      pdfStatus && (pdfStatus.textContent = "⏳ Extracting text from PDF (client-side)...");
      try {
        const arrayBuffer = await file.arrayBuffer();

        // pdf.js 前端解析
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const text = content.items.map(item => item.str).join(' ');
          fullText += text + '\n';
        }

        // 简单清洗，避免过长空白
        pdfTextCache = fullText.replace(/\n{3,}/g, '\n\n').trim();
        pdfStatus && (pdfStatus.textContent = `✅ PDF loaded (${(pdfTextCache.length/1000).toFixed(1)}k chars)`);

        // 若 recorder 窗口已打开，立刻发送
        if (recorderWindow && !recorderWindow.closed) {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }
      } catch (err) {
        console.error("❌ PDF parse error:", err);
        pdfStatus && (pdfStatus.textContent = "❌ PDF parse error.");
      }
    });

    // recorder 准备好时，补发一次 PDF 文本（防止顺序问题）
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'ready-to-record' && pdfTextCache) {
        const targetOrigin = 'https://fyp-2025-kath.vercel.app';
        recorderWindow?.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, targetOrigin);
      }
    });

    stopBtn.onclick = async () => {
      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ session_id: sessionId, command: 'stop' })
      });
    };

    function poll(sessionId) {
       const container = document.getElementById('cardsContainer');
      // container.id = 'cardsContainer';
      // document.body.appendChild(container);

      setInterval(async () => {
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}&order=created_at.desc&limit=1`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A ',
              'Content-Type': 'application/json'
            }
          });
          const data = await res.json();
          const item = data?.[0];
          if (item && item.summary && item.summary !== lastShownSummary) {
            const card = document.createElement('div');
            card.className = 'card';
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';
            const summaryHeader = document.createElement('h3');
            summaryHeader.textContent = ' Summary';
            summaryHeader.appendChild(toggleBtn);

            const summaryPara = document.createElement('p');
            summaryPara.textContent = item.summary;

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `
              <h4>📌 Decision</h4><ul>${(item.decision || []).map(d => `<li>${d}</li>`).join('')}</ul>
              <h4>💡 Explicit</h4><ul>${(item.explicit || []).map(e => `<li>${e}</li>`).join('')}</ul>
              <h4>💡 Tacit</h4><ul>${(item.tacit || []).map(t => `<li>${t}</li>`).join('')}</ul>
              <h4>🧠 Reasoning</h4><p>${item.reasoning || ''}</p>
              <h4>🔗 Suggestions</h4><ul>${(item.suggestions || []).map(s => `<li>${s}</li>`).join('')}</ul>
            `;

             toggleBtn.onclick = () => {
              const isShown = details.style.display === 'block';
              details.style.display = isShown ? 'none' : 'block';
              toggleBtn.textContent = isShown ? '+' : '−';
            };

            card.appendChild(summaryHeader);
            card.appendChild(summaryPara);
            card.appendChild(details);
            container.prepend(card);
            
            
            // card.innerHTML = `<h3>🧠 Summary</h3><p>${item.summary}</p>`;

            // container.prepend(card);
            
            
            //resultBox.prepend(card);

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary,
                decision: item.decision,
                explicit: item.explicit,
                tacit: item.tacit,
                reasoning: item.reasoning,
                suggestions: item.suggestions
              }
            }, '*');

            lastShownSummary = item.summary;
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 2000);
    }
  </script>
</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }
    .card {
      background: #f3f3f3;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
    }
    .card button.toggle-btn {
      float: right;
      font-size: 18px;
      border: none;
      background: none;
      cursor: pointer;
    }
    .details {
      display: none;
      margin-top: 10px;
    }

    button {
      padding: 10px 18px;
      margin: 8px 8px 16px 0;
      font-weight: bold;
      margin-right: 6px;
    }
    #spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #ccc;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <label style="display:block; margin:8px 0 4px;">📄 Add Context (optional):</label>
  <div style="display: flex; gap: 10px; margin-bottom: 8px;">
    <button id="pdfBtn" style="padding: 6px 12px; margin: 0;">Upload PDF</button>
    <button id="textBtn" style="padding: 6px 12px; margin: 0;">Paste Text</button>
  </div>
  <input id="pdfInput" type="file" accept="application/pdf" style="display: none;" />
  <textarea id="contextText" placeholder="Paste your project documentation or context here..." 
           style="width: 100%; height: 100px; display: none; margin-bottom: 8px;"></textarea>
  <small id="pdfStatus" style="display:block; color:#666; margin-bottom:12px;"></small>

  <label for="cycleInput">⏱️ Summary interval (minutes):</label>
  <input id="cycleInput" type="number" value="5" min="1" style="width: 60px; margin-left: 8px; margin-bottom: 12px;" />
  <br><br>

  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

   <div id="cardsContainer"></div>
  
  <script>
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    let sessionId = null;
    let lastShownSummary = '';
    let recorderWindow = null;
    let pdfTextCache = "";
    let pdfFileName = '';

    openBtn.onclick = async () => {
      sessionId = Date.now().toString();

      const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);

      try {
        await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
          method: 'POST',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            session_id: sessionId,
            command: 'set_cycle',
            value: intervalMin
          })
        });

        console.log("✅ Sent set_cycle to Supabase:", intervalMin);
      } catch (err) {
        console.error("❌ Failed to send set_cycle:", err);
      }

      // 🆕 新增：如果有PDF内容，保存到Supabase
if (pdfTextCache) {
  try {
    console.log('📚 保存PDF内容到Supabase...');
    const pdfRes = await fetch('https://fyp-2025-kath.vercel.app/api/save_pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: sessionId,
        pdf_text: pdfTextCache,
        filename: pdfFileName || 'context.pdf'
      })
    });

    console.log('📊 save_pdf响应状态:', pdfRes.status); // 添加这行

    if (pdfRes.ok) {
      console.log('✅ PDF内容已保存到Supabase');
      pdfStatus.textContent += ' (已保存到会话)';
    } else {
      const errorText = await pdfRes.text();
      console.error('❌ PDF保存失败 - 状态码:', pdfRes.status);
      console.error('❌ 错误详情:', errorText);
    }
  } catch (err) {
    console.error('❌ PDF保存异常:', err);
  }
}



      recorderWindow = window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );

      // Send PDF text if already loaded
      if (pdfTextCache && recorderWindow) {
        setTimeout(() => {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }, 1000);
      }

      poll(sessionId);
    };

    const pdfBtn = document.getElementById('pdfBtn');
    const textBtn = document.getElementById('textBtn');
    const pdfInput = document.getElementById('pdfInput');
    const contextText = document.getElementById('contextText');
    const pdfStatus = document.getElementById('pdfStatus');

    // Toggle between PDF upload and text paste
    pdfBtn.onclick = () => {
      pdfInput.style.display = 'block';
      contextText.style.display = 'none';
      pdfInput.click(); // Auto-open file picker
    };

    textBtn.onclick = () => {
      contextText.style.display = 'block';
      pdfInput.style.display = 'none';
      pdfStatus.textContent = 'Type or paste your context below';
    };

    // Handle text input
    contextText.addEventListener('input', (e) => {
      pdfTextCache = e.target.value;
      pdfStatus.textContent = `✅ Text added (${(pdfTextCache.length/1000).toFixed(1)}k chars)`;
      
      // Send to recorder window if open
      if (recorderWindow && !recorderWindow.closed) {
        recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
      }
    });

    // Use server-side PDF processing with fallback
    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      pdfFileName = file.name; // 🆕 存储文件名

      pdfStatus.textContent = "⏳ Extracting text from PDF...";
      
      try {
        // Create FormData and send to your API
        const formData = new FormData();
        formData.append('file', file, file.name);
        
        const res = await fetch('https://fyp-2025-kath.vercel.app/api/ingest_pdf', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        
        if (data?.error) {
          // If PDF extraction failed, show text input as fallback
          contextText.style.display = 'block';
          pdfStatus.textContent = "⚠️ Could not extract PDF text. Please paste the content manually.";
          return;
        }
        
        if (!data?.text) {
          throw new Error("No text extracted from PDF");
        }
        
        pdfTextCache = data.text;
        pdfStatus.textContent = `✅ PDF loaded (${(pdfTextCache.length/1000).toFixed(1)}k chars)`;

        // Send to recorder window if open
        if (recorderWindow && !recorderWindow.closed) {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }
      } catch (err) {
        console.error("❌ PDF processing error:", err);
        // Show text input as fallback
        contextText.style.display = 'block';
        pdfStatus.textContent = "❌ PDF upload failed. Please paste the text instead.";
      }
    });

    // Send PDF context when recorder is ready
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'ready-to-record' && pdfTextCache) {
        const targetOrigin = 'https://fyp-2025-kath.vercel.app';
        recorderWindow?.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, targetOrigin);
      }
    });

    stopBtn.onclick = async () => {
      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ session_id: sessionId, command: 'stop' })
      });
    };

    function poll(sessionId) {
      const container = document.getElementById('cardsContainer');

      setInterval(async () => {
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}&order=created_at.desc&limit=1`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A ',
              'Content-Type': 'application/json'
            }
          });
          const data = await res.json();
          const item = data?.[0];
          if (item && item.summary && item.summary !== lastShownSummary) {
            const card = document.createElement('div');
            card.className = 'card';
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';
            const summaryHeader = document.createElement('h3');
            summaryHeader.textContent = ' Summary';
            summaryHeader.appendChild(toggleBtn);

            const summaryPara = document.createElement('p');
            summaryPara.textContent = item.summary;

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `
              <h4>📌 Decision</h4><ul>${(item.decision || []).map(d => `<li>${d}</li>`).join('')}</ul>
              <h4>💡 Explicit</h4><ul>${(item.explicit || []).map(e => `<li>${e}</li>`).join('')}</ul>
              <h4>💡 Tacit</h4><ul>${(item.tacit || []).map(t => `<li>${t}</li>`).join('')}</ul>
              <h4>🧠 Reasoning</h4><p>${item.reasoning || ''}</p>
              <h4>🔗 Suggestions</h4><ul>${(item.suggestions || []).map(s => `<li>${s}</li>`).join('')}</ul>
            `;

            toggleBtn.onclick = () => {
              const isShown = details.style.display === 'block';
              details.style.display = isShown ? 'none' : 'block';
              toggleBtn.textContent = isShown ? '+' : '−';
            };

            card.appendChild(summaryHeader);
            card.appendChild(summaryPara);
            card.appendChild(details);
            container.prepend(card);

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary,
                decision: item.decision,
                explicit: item.explicit,
                tacit: item.tacit,
                reasoning: item.reasoning,
                suggestions: item.suggestions
              }
            }, '*');

            lastShownSummary = item.summary;
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 2000);
    }
  </script>
</body>
</html> -->


<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 300px; overflow-y: auto; margin-top: 12px; }
    button { padding: 8px 16px; font-weight: bold; margin-right: 8px; }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

  <div id="result">⏳ Waiting for result...</div>

  <script>

    
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultBox = document.getElementById('result');
    
    //let recorderWindow = null;
    let ready = false;
    let sessionId = null; 

    openBtn.onclick = () => {
      sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      ready = false;
      poll(sessionId);
    };

    stopBtn.onclick = async () => {
      console.log("🛑 stop button clicked");

      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          session_id: sessionId,
          command: 'stop'
        })
      });
      console.log("✅ stop command sent to Supabase");
    };


    window.addEventListener('message', (event) => {
      const msg = event.data;

      if (msg?.type === 'ready-to-record') {
        ready = true;
        console.log("✅ Recorder window is ready");
      }

      if (msg?.pluginMessage?.type === 'analyze-transcript') {
        const { transcript, summary } = msg.pluginMessage;
        resultBox.textContent = `📝 Transcript:\n${transcript}\n\n🧠 Summary:\n${summary}`;

        parent.postMessage({
          pluginMessage: {
            type: 'analyze-transcript',
            transcript,
            summary
          }
        }, '*');
      }
    });

    let lastFetchedTime = null;

    function poll(sessionId) {
      const interval = setInterval(async () => {
        console.log('polling summary');
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Content-Type': 'application/json'
            }
          });

          const data = await res.json();
          //console.log("📥 Got from Supabase:", data);
          const newItems = data.filter(item =>
            item.created_at && (!lastFetchedTime || new Date(item.created_at) > new Date(lastFetchedTime))
          );

          for (const item of newItems) {
            lastFetchedTime = item.created_at;

            // 👇 更新 UI 文本框
            resultBox.textContent = `📝 Transcript:\n${item.transcript}\n\n🧠 Summary:\n${item.summary}`;

            // 👇 发回 Figma 插件
           

          // if (Array.isArray(data) && data.length > 0 && data[0].summary) {
          //   clearInterval(interval);

          //   const item = data[0];
          //   resultBox.textContent = `📝 Transcript:\n${item.transcript}\n\n🧠 Summary:\n${item.summary}`;

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary
              }
            }, '*');
          }
        } catch (err) {
          console.error("❌ Supabase polling failed:", err);
        }
      }, 1000);
    }

      

    // function sendTest() {
    //   console.log("📤 Sending TEST message...");
    //   parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
    // }
  </script>
</body>
</html> -->




<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 200px; overflow-y: auto; }
    button { padding: 8px 16px; font-weight: bold; }
    
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <div id="result">⏳ Waiting for result...</div>
  <button onclick="sendTest()">Send Test Message</button>

  <script>
  //   function sendTest() {
  //   console.log("📤 Sending TEST message...");
  //   parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
  // }
    
    const openBtn = document.getElementById('openBtn');
    const resultBox = document.getElementById('result');

    openBtn.onclick = () => {
      const sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      poll(sessionId);
    };

    function poll(sessionId) {
      const interval = setInterval(async () => {
        const res = await fetch(`https://fyp-2025-kath.vercel.app/api/get?session=${sessionId}`);
        const data = await res.json();
        if (data.summary) {
          clearInterval(interval);
          console.log("📥 Got result:", data);

          resultBox.textContent = `📝 Transcript:\n${data.transcript}\n\n🧠 Summary:\n${data.summary}`;

          console.log("📤 Sending pluginMessage...", { transcript, summary });

          // 通知插件主线程插入文字
          parent.postMessage({
            pluginMessage: {
              type: 'analyze-transcript',
              transcript: data.transcript,
              summary: data.summary
            }
          }, '*');
        }
      }, 1000);
    }
  </script>
</body>
</html> -->
   