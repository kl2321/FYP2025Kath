<!-- <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }
    .card {
      background: #f3f3f3;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
    }
    .card button.toggle-btn {
      float: right;
      font-size: 18px;
      border: none;
      background: none;
      cursor: pointer;
    }
    .details {
      display: none;
      margin-top: 10px;
    }

    button {
      padding: 10px 18px;
      margin: 8px 8px 16px 0;
      font-weight: bold;
      margin-right: 6px;
    }
    #spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #ccc;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    // 2) ÂøÖÈ°ªËÆæÁΩÆ worker Ê∫êÔºåÂê¶ÂàôÊüê‰∫õÁéØÂ¢É‰ºöÊä•Èîô/Âç°‰Ωè
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
    }
  </script>
</head>
<body>
  <h2>üé§ Analyze Meeting</h2>
  <label style="display:block; margin:8px 0 4px;">üìÑ Attach PDF (optional):</label>
  <input id="pdfInput" type="file" accept="application/pdf" />
  <small id="pdfStatus" style="display:block; color:#666; margin-bottom:12px;"></small>

  <label for="cycleInput">‚è±Ô∏è Summary interval (minutes):</label>
  <input id="cycleInput" type="number" value="5" min="1" style="width: 60px; margin-left: 8px; margin-bottom: 12px;" />
  <br><br>

  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

   <div id="cardsContainer"></div>
  
  


  <script>
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    //const resultBox = document.getElementById('result');
    let sessionId = null;
    let lastShownSummary = '';

    let recorderWindow = null;
    let pdfTextCache = ""; // store extracted pdf text

 
    // ÊèêÂâçÊ≥®ÂÜå message handler
    // window.addEventListener('message', function handler(e) {
    //   if (e.data?.type === 'ready-to-record') {
    //     console.log("‚úÖ Recorder window is ready");
    //     console.log("üõéÔ∏è Got message from record:", e.data);

        

    //     const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);
    //     console.log("üì§ Sending set-max-cycle:", intervalMin);
    //     recorderWindow?.postMessage({ type: 'set-max-cycle', value: intervalMin }, '*');

    //     window.removeEventListener('message', handler);
    //   }
    // });

    
    openBtn.onclick = async () => {
      sessionId = Date.now().toString();

  //  Ëé∑ÂèñÁî®Êà∑ËæìÂÖ•ÂàÜÈíüÊï∞
      const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);

  //  ÂèëÈÄÅ set_cycle Êåá‰ª§Âà∞ Supabase
  try {
    await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
      method: 'POST',
      headers: {
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        session_id: sessionId,
        command: 'set_cycle',
        value: intervalMin
      })
    });

    console.log("‚úÖ Sent set_cycle to Supabase:", intervalMin);
  } catch (err) {
    console.error("‚ùå Failed to send set_cycle:", err);
  }

  //  ÊâìÂºÄ recorder È°µÈù¢
  recorderWindow = window.open(
    `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
    'recorder',
    'width=500,height=400'
  );

  poll(sessionId);
};

// const pdfInput = document.getElementById('pdfInput');
// const pdfStatus = document.getElementById('pdfStatus');

// pdfInput.addEventListener('change', async (e) => {
//   const file = e.target.files?.[0];
//   if (!file) return;

//   pdfStatus.textContent = "‚è≥ Extracting text from PDF...";
//   try {
//     const form = new FormData();
//     form.append('file', file, file.name);
//     const res = await fetch('https://fyp-2025-kath.vercel.app/api/ingest_pdf', {
//       method: 'POST',
//       body: form
//     });
//     const data = await res.json();
//     if (!res.ok || !data?.text) {
//       pdfStatus.textContent = "‚ùå Failed to read PDF.";
//       return;
//     }
//     pdfTextCache = data.text;
//     pdfStatus.textContent = `‚úÖ PDF loaded (${(data.text.length/1000).toFixed(1)}k chars)`;

//     // Â¶ÇÊûúÂΩïÈü≥Á™óÂè£Â∑≤ÊâìÂºÄÔºåÊää PDF ÊñáÊú¨‰º†ÁªôÂÆÉ
//     if (recorderWindow) {
//       recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, '*');
//     }
//   } catch (err) {
//     console.error("‚ùå PDF upload/parse error:", err);
//     pdfStatus.textContent = "‚ùå PDF parse error.";
//   }
// });

const pdfInput = document.getElementById('pdfInput');
    const pdfStatus = document.getElementById('pdfStatus'); // ÂèØÈÄâÁöÑÁä∂ÊÄÅÊñáÊú¨

    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      pdfStatus && (pdfStatus.textContent = "‚è≥ Extracting text from PDF (client-side)...");
      try {
        const arrayBuffer = await file.arrayBuffer();

        // pdf.js ÂâçÁ´ØËß£Êûê
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const text = content.items.map(item => item.str).join(' ');
          fullText += text + '\n';
        }

        // ÁÆÄÂçïÊ∏ÖÊ¥óÔºåÈÅøÂÖçËøáÈïøÁ©∫ÁôΩ
        pdfTextCache = fullText.replace(/\n{3,}/g, '\n\n').trim();
        pdfStatus && (pdfStatus.textContent = `‚úÖ PDF loaded (${(pdfTextCache.length/1000).toFixed(1)}k chars)`);

        // Ëã• recorder Á™óÂè£Â∑≤ÊâìÂºÄÔºåÁ´ãÂàªÂèëÈÄÅ
        if (recorderWindow && !recorderWindow.closed) {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }
      } catch (err) {
        console.error("‚ùå PDF parse error:", err);
        pdfStatus && (pdfStatus.textContent = "‚ùå PDF parse error.");
      }
    });

    // recorder ÂáÜÂ§áÂ•ΩÊó∂ÔºåË°•Âèë‰∏ÄÊ¨° PDF ÊñáÊú¨ÔºàÈò≤Ê≠¢È°∫Â∫èÈóÆÈ¢òÔºâ
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'ready-to-record' && pdfTextCache) {
        const targetOrigin = 'https://fyp-2025-kath.vercel.app';
        recorderWindow?.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, targetOrigin);
      }
    });

    stopBtn.onclick = async () => {
      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ session_id: sessionId, command: 'stop' })
      });
    };

    function poll(sessionId) {
       const container = document.getElementById('cardsContainer');
      // container.id = 'cardsContainer';
      // document.body.appendChild(container);

      setInterval(async () => {
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}&order=created_at.desc&limit=1`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A ',
              'Content-Type': 'application/json'
            }
          });
          const data = await res.json();
          const item = data?.[0];
          if (item && item.summary && item.summary !== lastShownSummary) {
            const card = document.createElement('div');
            card.className = 'card';
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';
            const summaryHeader = document.createElement('h3');
            summaryHeader.textContent = ' Summary';
            summaryHeader.appendChild(toggleBtn);

            const summaryPara = document.createElement('p');
            summaryPara.textContent = item.summary;

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `
              <h4>üìå Decision</h4><ul>${(item.decision || []).map(d => `<li>${d}</li>`).join('')}</ul>
              <h4>üí° Explicit</h4><ul>${(item.explicit || []).map(e => `<li>${e}</li>`).join('')}</ul>
              <h4>üí° Tacit</h4><ul>${(item.tacit || []).map(t => `<li>${t}</li>`).join('')}</ul>
              <h4>üß† Reasoning</h4><p>${item.reasoning || ''}</p>
              <h4>üîó Suggestions</h4><ul>${(item.suggestions || []).map(s => `<li>${s}</li>`).join('')}</ul>
            `;

             toggleBtn.onclick = () => {
              const isShown = details.style.display === 'block';
              details.style.display = isShown ? 'none' : 'block';
              toggleBtn.textContent = isShown ? '+' : '‚àí';
            };

            card.appendChild(summaryHeader);
            card.appendChild(summaryPara);
            card.appendChild(details);
            container.prepend(card);
            
            
            // card.innerHTML = `<h3>üß† Summary</h3><p>${item.summary}</p>`;

            // container.prepend(card);
            
            
            //resultBox.prepend(card);

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary,
                decision: item.decision,
                explicit: item.explicit,
                tacit: item.tacit,
                reasoning: item.reasoning,
                suggestions: item.suggestions
              }
            }, '*');

            lastShownSummary = item.summary;
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 2000);
    }
  </script>
</body>
</html> -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }
    .card {
      background: #f3f3f3;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
    }
    .card button.toggle-btn {
      float: right;
      font-size: 18px;
      border: none;
      background: none;
      cursor: pointer;
    }
    .details {
      display: none;
      margin-top: 10px;
    }

    button {
      padding: 10px 18px;
      margin: 8px 8px 16px 0;
      font-weight: bold;
      margin-right: 6px;
    }
    #spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #ccc;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  </style>
</head>
<body>
  <h2>üé§ Analyze Meeting</h2>
  <label style="display:block; margin:8px 0 4px;">üìÑ Add Context (optional):</label>
  <div style="display: flex; gap: 10px; margin-bottom: 8px;">
    <button id="pdfBtn" style="padding: 6px 12px; margin: 0;">Upload PDF</button>
    <button id="textBtn" style="padding: 6px 12px; margin: 0;">Paste Text</button>
  </div>
  <input id="pdfInput" type="file" accept="application/pdf" style="display: none;" />
  <textarea id="contextText" placeholder="Paste your project documentation or context here..." 
           style="width: 100%; height: 100px; display: none; margin-bottom: 8px;"></textarea>
  <small id="pdfStatus" style="display:block; color:#666; margin-bottom:12px;"></small>

  <label for="cycleInput">‚è±Ô∏è Summary interval (minutes):</label>
  <input id="cycleInput" type="number" value="5" min="1" style="width: 60px; margin-left: 8px; margin-bottom: 12px;" />
  <br><br>

  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

   <div id="cardsContainer"></div>
  
  <script>
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    let sessionId = null;
    let lastShownSummary = '';
    let recorderWindow = null;
    let pdfTextCache = "";
    let pdfFileName = '';

    openBtn.onclick = async () => {
      sessionId = Date.now().toString();

      const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);

      try {
        await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
          method: 'POST',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            session_id: sessionId,
            command: 'set_cycle',
            value: intervalMin
          })
        });

        console.log("‚úÖ Sent set_cycle to Supabase:", intervalMin);
      } catch (err) {
        console.error("‚ùå Failed to send set_cycle:", err);
      }

      // üÜï Êñ∞Â¢ûÔºöÂ¶ÇÊûúÊúâPDFÂÜÖÂÆπÔºå‰øùÂ≠òÂà∞Supabase
if (pdfTextCache) {
  try {
    console.log('üìö ‰øùÂ≠òPDFÂÜÖÂÆπÂà∞Supabase...');
    const pdfRes = await fetch('https://fyp-2025-kath.vercel.app/api/save_pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: sessionId,
        pdf_text: pdfTextCache,
        filename: pdfFileName || 'context.pdf'
      })
    });

    if (pdfRes.ok) {
      console.log('‚úÖ PDFÂÜÖÂÆπÂ∑≤‰øùÂ≠òÂà∞Supabase');
      pdfStatus.textContent += ' (Â∑≤‰øùÂ≠òÂà∞‰ºöËØù)';
    } else {
      console.error('‚ùå PDF‰øùÂ≠òÂ§±Ë¥•');
    }
  } catch (err) {
    console.error('‚ùå PDF‰øùÂ≠òÂºÇÂ∏∏:', err);
  }
}



      recorderWindow = window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );

      // Send PDF text if already loaded
      if (pdfTextCache && recorderWindow) {
        setTimeout(() => {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }, 1000);
      }

      poll(sessionId);
    };

    const pdfBtn = document.getElementById('pdfBtn');
    const textBtn = document.getElementById('textBtn');
    const pdfInput = document.getElementById('pdfInput');
    const contextText = document.getElementById('contextText');
    const pdfStatus = document.getElementById('pdfStatus');

    // Toggle between PDF upload and text paste
    pdfBtn.onclick = () => {
      pdfInput.style.display = 'block';
      contextText.style.display = 'none';
      pdfInput.click(); // Auto-open file picker
    };

    textBtn.onclick = () => {
      contextText.style.display = 'block';
      pdfInput.style.display = 'none';
      pdfStatus.textContent = 'Type or paste your context below';
    };

    // Handle text input
    contextText.addEventListener('input', (e) => {
      pdfTextCache = e.target.value;
      pdfStatus.textContent = `‚úÖ Text added (${(pdfTextCache.length/1000).toFixed(1)}k chars)`;
      
      // Send to recorder window if open
      if (recorderWindow && !recorderWindow.closed) {
        recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
      }
    });

    // Use server-side PDF processing with fallback
    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      pdfFileName = file.name; // üÜï Â≠òÂÇ®Êñá‰ª∂Âêç

      pdfStatus.textContent = "‚è≥ Extracting text from PDF...";
      
      try {
        // Create FormData and send to your API
        const formData = new FormData();
        formData.append('file', file, file.name);
        
        const res = await fetch('https://fyp-2025-kath.vercel.app/api/ingest_pdf', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        
        if (data?.error) {
          // If PDF extraction failed, show text input as fallback
          contextText.style.display = 'block';
          pdfStatus.textContent = "‚ö†Ô∏è Could not extract PDF text. Please paste the content manually.";
          return;
        }
        
        if (!data?.text) {
          throw new Error("No text extracted from PDF");
        }
        
        pdfTextCache = data.text;
        pdfStatus.textContent = `‚úÖ PDF loaded (${(pdfTextCache.length/1000).toFixed(1)}k chars)`;

        // Send to recorder window if open
        if (recorderWindow && !recorderWindow.closed) {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }
      } catch (err) {
        console.error("‚ùå PDF processing error:", err);
        // Show text input as fallback
        contextText.style.display = 'block';
        pdfStatus.textContent = "‚ùå PDF upload failed. Please paste the text instead.";
      }
    });

    // Send PDF context when recorder is ready
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'ready-to-record' && pdfTextCache) {
        const targetOrigin = 'https://fyp-2025-kath.vercel.app';
        recorderWindow?.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, targetOrigin);
      }
    });

    stopBtn.onclick = async () => {
      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ session_id: sessionId, command: 'stop' })
      });
    };

    function poll(sessionId) {
      const container = document.getElementById('cardsContainer');

      setInterval(async () => {
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}&order=created_at.desc&limit=1`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A ',
              'Content-Type': 'application/json'
            }
          });
          const data = await res.json();
          const item = data?.[0];
          if (item && item.summary && item.summary !== lastShownSummary) {
            const card = document.createElement('div');
            card.className = 'card';
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';
            const summaryHeader = document.createElement('h3');
            summaryHeader.textContent = ' Summary';
            summaryHeader.appendChild(toggleBtn);

            const summaryPara = document.createElement('p');
            summaryPara.textContent = item.summary;

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `
              <h4>üìå Decision</h4><ul>${(item.decision || []).map(d => `<li>${d}</li>`).join('')}</ul>
              <h4>üí° Explicit</h4><ul>${(item.explicit || []).map(e => `<li>${e}</li>`).join('')}</ul>
              <h4>üí° Tacit</h4><ul>${(item.tacit || []).map(t => `<li>${t}</li>`).join('')}</ul>
              <h4>üß† Reasoning</h4><p>${item.reasoning || ''}</p>
              <h4>üîó Suggestions</h4><ul>${(item.suggestions || []).map(s => `<li>${s}</li>`).join('')}</ul>
            `;

            toggleBtn.onclick = () => {
              const isShown = details.style.display === 'block';
              details.style.display = isShown ? 'none' : 'block';
              toggleBtn.textContent = isShown ? '+' : '‚àí';
            };

            card.appendChild(summaryHeader);
            card.appendChild(summaryPara);
            card.appendChild(details);
            container.prepend(card);

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary,
                decision: item.decision,
                explicit: item.explicit,
                tacit: item.tacit,
                reasoning: item.reasoning,
                suggestions: item.suggestions
              }
            }, '*');

            lastShownSummary = item.summary;
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 2000);
    }
  </script>
</body>
</html>



<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 300px; overflow-y: auto; margin-top: 12px; }
    button { padding: 8px 16px; font-weight: bold; margin-right: 8px; }
  </style>
</head>
<body>
  <h2>üé§ Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

  <div id="result">‚è≥ Waiting for result...</div>

  <script>

    
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultBox = document.getElementById('result');
    
    //let recorderWindow = null;
    let ready = false;
    let sessionId = null; 

    openBtn.onclick = () => {
      sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      ready = false;
      poll(sessionId);
    };

    stopBtn.onclick = async () => {
      console.log("üõë stop button clicked");

      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          session_id: sessionId,
          command: 'stop'
        })
      });
      console.log("‚úÖ stop command sent to Supabase");
    };


    window.addEventListener('message', (event) => {
      const msg = event.data;

      if (msg?.type === 'ready-to-record') {
        ready = true;
        console.log("‚úÖ Recorder window is ready");
      }

      if (msg?.pluginMessage?.type === 'analyze-transcript') {
        const { transcript, summary } = msg.pluginMessage;
        resultBox.textContent = `üìù Transcript:\n${transcript}\n\nüß† Summary:\n${summary}`;

        parent.postMessage({
          pluginMessage: {
            type: 'analyze-transcript',
            transcript,
            summary
          }
        }, '*');
      }
    });

    let lastFetchedTime = null;

    function poll(sessionId) {
      const interval = setInterval(async () => {
        console.log('polling summary');
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Content-Type': 'application/json'
            }
          });

          const data = await res.json();
          //console.log("üì• Got from Supabase:", data);
          const newItems = data.filter(item =>
            item.created_at && (!lastFetchedTime || new Date(item.created_at) > new Date(lastFetchedTime))
          );

          for (const item of newItems) {
            lastFetchedTime = item.created_at;

            // üëá Êõ¥Êñ∞ UI ÊñáÊú¨Ê°Ü
            resultBox.textContent = `üìù Transcript:\n${item.transcript}\n\nüß† Summary:\n${item.summary}`;

            // üëá ÂèëÂõû Figma Êèí‰ª∂
           

          // if (Array.isArray(data) && data.length > 0 && data[0].summary) {
          //   clearInterval(interval);

          //   const item = data[0];
          //   resultBox.textContent = `üìù Transcript:\n${item.transcript}\n\nüß† Summary:\n${item.summary}`;

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary
              }
            }, '*');
          }
        } catch (err) {
          console.error("‚ùå Supabase polling failed:", err);
        }
      }, 1000);
    }

      

    // function sendTest() {
    //   console.log("üì§ Sending TEST message...");
    //   parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
    // }
  </script>
</body>
</html> -->




<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 200px; overflow-y: auto; }
    button { padding: 8px 16px; font-weight: bold; }
    
  </style>
</head>
<body>
  <h2>üé§ Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <div id="result">‚è≥ Waiting for result...</div>
  <button onclick="sendTest()">Send Test Message</button>

  <script>
  //   function sendTest() {
  //   console.log("üì§ Sending TEST message...");
  //   parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
  // }
    
    const openBtn = document.getElementById('openBtn');
    const resultBox = document.getElementById('result');

    openBtn.onclick = () => {
      const sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      poll(sessionId);
    };

    function poll(sessionId) {
      const interval = setInterval(async () => {
        const res = await fetch(`https://fyp-2025-kath.vercel.app/api/get?session=${sessionId}`);
        const data = await res.json();
        if (data.summary) {
          clearInterval(interval);
          console.log("üì• Got result:", data);

          resultBox.textContent = `üìù Transcript:\n${data.transcript}\n\nüß† Summary:\n${data.summary}`;

          console.log("üì§ Sending pluginMessage...", { transcript, summary });

          // ÈÄöÁü•Êèí‰ª∂‰∏ªÁ∫øÁ®ãÊèíÂÖ•ÊñáÂ≠ó
          parent.postMessage({
            pluginMessage: {
              type: 'analyze-transcript',
              transcript: data.transcript,
              summary: data.summary
            }
          }, '*');
        }
      }, 1000);
    }
  </script>
</body>
</html> -->
