<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Meeting Assistant</title>
  <style>
    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #333;
      padding: 0;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Progress Indicator */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      background: #f7f7f7;
      border-bottom: 1px solid #e5e5e5;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .progress-step::after {
      content: '';
      position: absolute;
      top: 15px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e5e5e5;
      z-index: 0;
    }

    .progress-step:last-child::after {
      display: none;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e5e5e5;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .progress-step.active .step-circle {
      background: #5E5CE6;
      color: white;
    }

    .progress-step.completed .step-circle {
      background: #30D158;
      color: white;
    }

    .step-label {
      margin-top: 8px;
      font-size: 11px;
      color: #666;
      font-weight: 500;
    }

    .progress-step.active .step-label {
      color: #5E5CE6;
      font-weight: 600;
    }

    /* Page Container */
    .page-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }

    input[type="text"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d1d1;
      border-radius: 6px;
      font-size: 13px;
      transition: all 0.2s;
      background: white;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #5E5CE6;
      box-shadow: 0 0 0 3px rgba(94, 92, 230, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    /* Radio/Checkbox Groups */
    .radio-group,
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radio-item,
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .radio-item:hover,
    .checkbox-item:hover {
      background: #f7f7f7;
      border-color: #5E5CE6;
    }

    .radio-item input[type="radio"],
    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
    }

    .radio-item.selected,
    .checkbox-item.selected {
      background: #F0F0FF;
      border-color: #5E5CE6;
    }

    /* File Upload Area */
    .upload-area {
      border: 2px dashed #d1d1d1;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }

    .upload-area:hover {
      border-color: #5E5CE6;
      background: #F0F0FF;
    }

    .upload-area.dragover {
      border-color: #5E5CE6;
      background: #F0F0FF;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 48px;
      color: #999;
      margin-bottom: 10px;
    }

    .upload-text {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .upload-hint {
      color: #999;
      font-size: 12px;
    }

    .file-list {
      margin-top: 16px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f7f7f7;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-name {
      font-size: 13px;
      color: #333;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-remove {
      color: #999;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .file-remove:hover {
      background: #e5e5e5;
      color: #ff3b30;
    }

    /* Recording Interface */
    .recording-interface {
      text-align: center;
      padding: 40px 20px;
    }

    .record-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%);
      border: none;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .record-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 30px rgba(255, 59, 48, 0.4);
    }

    .record-button.recording {
      background: linear-gradient(135deg, #666 0%, #999 100%);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3); }
      50% { box-shadow: 0 4px 40px rgba(255, 59, 48, 0.6); }
      100% { box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3); }
    }

    .recording-time {
      margin-top: 20px;
      font-size: 24px;
      font-weight: 300;
      color: #333;
      font-variant-numeric: tabular-nums;
    }

    .recording-status {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    /* Navigation Buttons */
    .navigation {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      border-top: 1px solid #e5e5e5;
      background: #fafafa;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-secondary {
      background: white;
      color: #666;
      border: 1px solid #d1d1d1;
    }

    .btn-secondary:hover {
      background: #f7f7f7;
      border-color: #999;
    }

    .btn-primary {
      background: #5E5CE6;
      color: white;
    }

    .btn-primary:hover {
      background: #4B49D8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(94, 92, 230, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Success/Info Messages */
    .info-message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-message.success {
      background: #E8F5E9;
      color: #2E7D32;
      border: 1px solid #A5D6A7;
    }

    .info-message.info {
      background: #E3F2FD;
      color: #1565C0;
      border: 1px solid #90CAF9;
    }

    .info-message.warning {
      background: #FFF3E0;
      color: #EF6C00;
      border: 1px solid #FFB74D;
    }

    /* Loading State */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #5E5CE6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Summary Page */
    .summary-section {
      margin-bottom: 24px;
      padding: 16px;
      background: #f7f7f7;
      border-radius: 8px;
    }

    .summary-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .summary-content {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    /* Chip/Tag Style */
    .tag {
      display: inline-block;
      padding: 4px 8px;
      background: #e5e5e5;
      border-radius: 4px;
      font-size: 11px;
      margin-right: 6px;
      margin-bottom: 6px;
      color: #666;
    }

    .tag.primary {
      background: #E3F2FD;
      color: #1565C0;
    }
  </style>
</head>
<body>
  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Basic Info</div>
    </div>
    <div class="progress-step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Meeting Setup</div>
    </div>
    <div class="progress-step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Recording</div>
    </div>
    <div class="progress-step" data-step="4">
      <div class="step-circle">4</div>
      <div class="step-label">Summary</div>
    </div>
  </div>

  <!-- Page Container -->
  <div class="page-container">
    <!-- Page 1: Basic Information -->
    <div class="page active" id="page1">
      <h2 style="margin-bottom: 24px;">Meeting Configuration</h2>
      
      <div class="form-group">
        <label>Your Role *</label>
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" id="student" name="role" value="student" checked>
            <label for="student" style="margin: 0;">Student</label>
          </div>
          <div class="radio-item">
            <input type="radio" id="tutor" name="role" value="tutor">
            <label for="tutor" style="margin: 0;">Tutor/Instructor</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="module">Course Module *</label>
        <select id="module" required>
          <option value="">Select a module...</option>
          <option value="design-thinking">Design Thinking</option>
          <option value="technical-review">Technical Review</option>
          <option value="sprint-planning">Sprint Planning</option>
          <option value="user-research">User Research</option>
          <option value="prototyping">Prototyping Workshop</option>
        </select>
      </div>

      <div class="form-group">
        <label for="meeting-type">Meeting Type *</label>
        <select id="meeting-type" required>
          <option value="">Select meeting type...</option>
          <option value="brainstorming">Brainstorming Session</option>
          <option value="decision-making">Decision Making</option>
          <option value="progress-update">Progress Update</option>
          <option value="problem-solving">Problem Solving</option>
          <option value="retrospective">Retrospective</option>
        </select>
      </div>

      <div class="form-group">
        <label for="team-members">Team Members (optional)</label>
        <input type="text" id="team-members" placeholder="Enter names separated by commas">
        <small style="color: #999; font-size: 11px; margin-top: 4px; display: block;">
          This helps with speaker identification
        </small>
      </div>

      <div class="form-group">
        <label for="meeting-goals">Meeting Goals (optional)</label>
        <textarea id="meeting-goals" placeholder="What do you hope to achieve in this meeting?"></textarea>
      </div>
    </div>

    <!-- Page 2: File Upload & Settings -->
    <div class="page" id="page2">
      <h2 style="margin-bottom: 24px;">Upload Supporting Materials</h2>
      
      <div class="info-message info">
        <span>💡</span>
        <span>Upload any relevant documents to provide context for better AI analysis</span>
      </div>

      <div class="form-group">
        <label>Supporting Documents (optional)</label>
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">📁</div>
          <div class="upload-text">Click to upload or drag and drop</div>
          <div class="upload-hint">PDF, DOC, DOCX, TXT, Images (Max 10MB)</div>
          <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" style="display: none;">
        </div>
        <div class="file-list" id="fileList"></div>
      </div>

      <div class="form-group">
        <label>Analysis Preferences</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="key-decisions" checked>
            <label for="key-decisions" style="margin: 0;">Extract Key Decisions</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="action-items" checked>
            <label for="action-items" style="margin: 0;">Identify Action Items</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="speaker-analysis">
            <label for="speaker-analysis" style="margin: 0;">Analyze Speaker Contributions</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="sentiment-analysis">
            <label for="sentiment-analysis" style="margin: 0;">Include Sentiment Analysis</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="additional-context">Additional Context (optional)</label>
        <textarea id="additional-context" placeholder="Any specific context or instructions for the AI analysis..."></textarea>
      </div>
    </div>

    <!-- Page 3: Recording -->
    <div class="page" id="page3">
      <h2 style="margin-bottom: 24px;">Start Recording</h2>
      
      <div class="info-message success" id="readyMessage">
        <span>✅</span>
        <span>Everything is set up! Click the button below to start recording.</span>
      </div>

      <div class="recording-interface">
        <button class="record-button" id="recordButton">
          <span id="recordButtonText">Start Recording</span>
        </button>
        
        <div class="recording-time" id="recordingTime">00:00</div>
        <div class="recording-status" id="recordingStatus">Ready to record</div>

        <div style="margin-top: 40px;">
          <div class="info-message info" style="text-align: left;">
            <span>ℹ️</span>
            <div>
              <strong>Recording Tips:</strong><br>
              • Speak clearly and avoid overlapping conversations<br>
              • State your name when you first speak<br>
              • The AI will automatically detect different speakers<br>
              • You can pause and resume recording as needed
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 4: Summary & Results -->
    <div class="page" id="page4">
      <h2 style="margin-bottom: 24px;">Meeting Summary</h2>
      
      <div class="summary-section">
        <div class="summary-title">📊 Overview</div>
        <div class="summary-content" id="summaryOverview">
          Processing your meeting recording...
        </div>
      </div>

      <div class="summary-section">
        <div class="summary-title">🎯 Key Decisions</div>
        <div class="summary-content" id="summaryDecisions">
          <div class="loading"></div> Analyzing decisions...
        </div>
      </div>

      <div class="summary-section">
        <div class="summary-title">✅ Action Items</div>
        <div class="summary-content" id="summaryActions">
          <div class="loading"></div> Extracting action items...
        </div>
      </div>

      <div class="summary-section">
        <div class="summary-title">👥 Participants</div>
        <div class="summary-content" id="summaryParticipants">
          <div class="loading"></div> Identifying speakers...
        </div>
      </div>

      <div style="margin-top: 24px; text-align: center;">
        <button class="btn btn-primary" onclick="insertToFigma()">
          Insert to Figma
        </button>
        <button class="btn btn-secondary" onclick="downloadSummary()" style="margin-left: 8px;">
          Download Summary
        </button>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="navigation">
    <button class="btn btn-secondary" id="prevBtn" onclick="changePage(-1)">Previous</button>
    <button class="btn btn-primary" id="nextBtn" onclick="changePage(1)">Next</button>
  </div>

  <script>
    // State Management
    let currentPage = 1;
    const totalPages = 4;
    let formData = {
      role: 'student',
      module: '',
      meetingType: '',
      teamMembers: [],
      meetingGoals: '',
      files: [],
      preferences: {
        keyDecisions: true,
        actionItems: true,
        speakerAnalysis: false,
        sentimentAnalysis: false
      },
      additionalContext: ''
    };

    // Recording state
    let isRecording = false;
    let recordingStartTime = null;
    let recordingInterval = null;
    let mediaRecorder = null;
    let audioChunks = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updatePageDisplay();
      setupEventListeners();
      loadSavedData();
    });

    // Page Navigation
    function changePage(direction) {
      // Save current page data
      savePageData();

      // Validate before moving forward
      if (direction > 0 && !validateCurrentPage()) {
        showMessage('Please fill in all required fields', 'warning');
        return;
      }

      // Change page
      currentPage += direction;
      if (currentPage < 1) currentPage = 1;
      if (currentPage > totalPages) currentPage = totalPages;

      // Special handling for recording page
      if (currentPage === 3) {
        prepareRecordingPage();
      }

      // Update display
      updatePageDisplay();
      
      // Animate transition
      animatePageTransition();
    }

    function updatePageDisplay() {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });

      // Show current page
      document.getElementById(`page${currentPage}`).classList.add('active');

      // Update progress bar
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        if (index < currentPage - 1) {
          step.classList.add('completed');
          step.classList.remove('active');
        } else if (index === currentPage - 1) {
          step.classList.add('active');
          step.classList.remove('completed');
        } else {
          step.classList.remove('active', 'completed');
        }
      });

      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      prevBtn.style.display = currentPage === 1 ? 'none' : 'block';
      
      if (currentPage === 3) {
        nextBtn.textContent = 'Finish Recording';
        nextBtn.style.display = isRecording ? 'block' : 'none';
      } else if (currentPage === 4) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.textContent = 'Next';
        nextBtn.style.display = 'block';
      }
    }

    function animatePageTransition() {
      const activePage = document.querySelector('.page.active');
      activePage.style.animation = 'none';
      setTimeout(() => {
        activePage.style.animation = 'fadeIn 0.3s ease';
      }, 10);
    }

    // Event Listeners Setup
    function setupEventListeners() {
      // File upload
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      uploadArea?.addEventListener('click', () => fileInput.click());
      
      uploadArea?.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea?.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea?.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      fileInput?.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      // Radio buttons visual feedback
      document.querySelectorAll('.radio-item').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.radio-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          item.querySelector('input[type="radio"]').checked = true;
        });
      });

      // Checkbox visual feedback
      document.querySelectorAll('.checkbox-item').forEach(item => {
        item.addEventListener('click', () => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          item.classList.toggle('selected', checkbox.checked);
        });
      });

      // Recording button
      document.getElementById('recordButton')?.addEventListener('click', toggleRecording);
    }

    // File Handling
    function handleFiles(files) {
      const fileList = document.getElementById('fileList');
      
      Array.from(files).forEach(file => {
        // Validate file
        if (file.size > 10 * 1024 * 1024) {
          showMessage(`File ${file.name} is too large (max 10MB)`, 'warning');
          return;
        }

        // Add to formData
        formData.files.push(file);

        // Display file
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <span class="file-name">${file.name}</span>
          <span class="file-remove" onclick="removeFile('${file.name}')">✕</span>
        `;
        fileList.appendChild(fileItem);
      });
    }

    function removeFile(fileName) {
      formData.files = formData.files.filter(f => f.name !== fileName);
      // Refresh file list display
      updateFileList();
    }

    function updateFileList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      formData.files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <span class="file-name">${file.name}</span>
          <span class="file-remove" onclick="removeFile('${file.name}')">✕</span>
        `;
        fileList.appendChild(fileItem);
      });
    }

    // Recording Functions
    async function toggleRecording() {
      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    }

    async function startRecording() {
      try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          // Create audio blob
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          
          // Process recording
          await processRecording(audioBlob);
        };

        // Start recording
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();

        // Update UI
        document.getElementById('recordButton').classList.add('recording');
        document.getElementById('recordButtonText').textContent = 'Stop Recording';
        document.getElementById('recordingStatus').textContent = 'Recording in progress...';
        document.getElementById('nextBtn').style.display = 'block';

        // Start timer
        recordingInterval = setInterval(updateRecordingTime, 1000);

      } catch (error) {
        console.error('Error starting recording:', error);
        showMessage('Failed to access microphone. Please check permissions.', 'warning');
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        
        // Stop all tracks
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        isRecording = false;
        clearInterval(recordingInterval);

        // Update UI
        document.getElementById('recordButton').classList.remove('recording');
        document.getElementById('recordButtonText').textContent = 'Processing...';
        document.getElementById('recordingStatus').textContent = 'Processing your recording...';
        document.getElementById('recordButton').disabled = true;
      }
    }

    function updateRecordingTime() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
    }

    async function processRecording(audioBlob) {
      // Move to summary page
      currentPage = 4;
      updatePageDisplay();

      // Send to backend for processing
      const formDataToSend = new FormData();
      formDataToSend.append('audio', audioBlob, 'recording.webm');
      formDataToSend.append('metadata', JSON.stringify(formData));

      try {
        // Send to Figma plugin backend
        parent.postMessage({
          pluginMessage: {
            type: 'process-recording',
            formData: formData,
            // Audio will be handled separately due to size
          }
        }, '*');

        // Simulate processing (replace with actual API call)
        setTimeout(() => {
          displaySummaryResults({
            overview: "45-minute design review meeting with 4 participants discussing the new user onboarding flow.",
            decisions: [
              "Simplify the onboarding to 3 steps instead of 5",
              "Add progress indicators to each step",
              "Include skip option for experienced users"
            ],
            actions: [
              "John: Create wireframes for new 3-step flow by Friday",
              "Sarah: Conduct user testing with 5 participants",
              "Mike: Update the design system components"
            ],
            participants: ["John Smith", "Sarah Johnson", "Mike Chen", "Emily Davis"]
          });
        }, 3000);

      } catch (error) {
        console.error('Error processing recording:', error);
        showMessage('Failed to process recording. Please try again.', 'warning');
      }
    }

    // Form Validation
    function validateCurrentPage() {
      if (currentPage === 1) {
        const module = document.getElementById('module').value;
        const meetingType = document.getElementById('meeting-type').value;
        
        if (!module || !meetingType) {
          return false;
        }
      }
      return true;
    }

    // Data Persistence
    function savePageData() {
      if (currentPage === 1) {
        formData.role = document.querySelector('input[name="role"]:checked').value;
        formData.module = document.getElementById('module').value;
        formData.meetingType = document.getElementById('meeting-type').value;
        formData.teamMembers = document.getElementById('team-members').value.split(',').map(s => s.trim()).filter(Boolean);
        formData.meetingGoals = document.getElementById('meeting-goals').value;
      } else if (currentPage === 2) {
        formData.preferences.keyDecisions = document.getElementById('key-decisions').checked;
        formData.preferences.actionItems = document.getElementById('action-items').checked;
        formData.preferences.speakerAnalysis = document.getElementById('speaker-analysis').checked;
        formData.preferences.sentimentAnalysis = document.getElementById('sentiment-analysis').checked;
        formData.additionalContext = document.getElementById('additional-context').value;
      }

      // Save to localStorage
      localStorage.setItem('meetingFormData', JSON.stringify(formData));
    }

    function loadSavedData() {
      const saved = localStorage.getItem('meetingFormData');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          // Restore form fields
          // ... (implementation based on saved data)
        } catch (e) {
          console.error('Error loading saved data:', e);
        }
      }
    }

    function prepareRecordingPage() {
      // Display configuration summary
      const readyMessage = document.getElementById('readyMessage');
      readyMessage.innerHTML = `
        <span>✅</span>
        <div>
          <strong>Ready to record!</strong><br>
          Module: ${formData.module.replace('-', ' ')}<br>
          Meeting Type: ${formData.meetingType.replace('-', ' ')}<br>
          ${formData.files.length > 0 ? `${formData.files.length} supporting file(s) uploaded` : ''}
        </div>
      `;
    }

    // Summary Display
    function displaySummaryResults(results) {
      document.getElementById('summaryOverview').innerHTML = results.overview;
      
      document.getElementById('summaryDecisions').innerHTML = results.decisions
        .map(d => `<div style="margin-bottom: 8px;">• ${d}</div>`)
        .join('');
      
      document.getElementById('summaryActions').innerHTML = results.actions
        .map(a => `<div style="margin-bottom: 8px;">• ${a}</div>`)
        .join('');
      
      document.getElementById('summaryParticipants').innerHTML = results.participants
        .map(p => `<span class="tag primary">${p}</span>`)
        .join('');
    }

    // Figma Integration
    function insertToFigma() {
      parent.postMessage({
        pluginMessage: {
          type: 'insert-summary',
          data: formData,
          summary: {
            // Collect summary data from the page
          }
        }
      }, '*');
    }

    function downloadSummary() {
      // Create and download summary document
      const summaryText = `Meeting Summary\n\n...`; // Build full summary
      const blob = new Blob([summaryText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `meeting-summary-${Date.now()}.txt`;
      a.click();
    }

    // Utility Functions
    function showMessage(message, type = 'info') {
      // Create and show temporary message
      const messageDiv = document.createElement('div');
      messageDiv.className = `info-message ${type}`;
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.left = '50%';
      messageDiv.style.transform = 'translateX(-50%)';
      messageDiv.style.zIndex = '1000';
      messageDiv.innerHTML = `<span>${message}</span>`;
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    // Listen for messages from plugin
    window.onmessage = (event) => {
      const message = event.data.pluginMessage;
      if (message) {
        switch (message.type) {
          case 'processing-complete':
            displaySummaryResults(message.results);
            break;
          case 'processing-error':
            showMessage(message.error, 'warning');
            break;
        }
      }
    };
  </script>
</body>
</html>

<!-- <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }
    .card {
      background: #f3f3f3;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
    }
    .card button.toggle-btn {
      float: right;
      font-size: 18px;
      border: none;
      background: none;
      cursor: pointer;
    }
    .details {
      display: none;
      margin-top: 10px;
    }

    button {
      padding: 10px 18px;
      margin: 8px 8px 16px 0;
      font-weight: bold;
      margin-right: 6px;
    }
    #spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #ccc;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    // 2) 必须设置 worker 源，否则某些环境会报错/卡住
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
    }
  </script>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <label style="display:block; margin:8px 0 4px;">📄 Attach PDF (optional):</label>
  <input id="pdfInput" type="file" accept="application/pdf" />
  <small id="pdfStatus" style="display:block; color:#666; margin-bottom:12px;"></small>

  <label for="cycleInput">⏱️ Summary interval (minutes):</label>
  <input id="cycleInput" type="number" value="5" min="1" style="width: 60px; margin-left: 8px; margin-bottom: 12px;" />
  <br><br>

  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

   <div id="cardsContainer"></div>
  
  


  <script>
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    //const resultBox = document.getElementById('result');
    let sessionId = null;
    let lastShownSummary = '';

    let recorderWindow = null;
    let pdfTextCache = ""; // store extracted pdf text

 
    // 提前注册 message handler
    // window.addEventListener('message', function handler(e) {
    //   if (e.data?.type === 'ready-to-record') {
    //     console.log("✅ Recorder window is ready");
    //     console.log("🛎️ Got message from record:", e.data);

        

    //     const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);
    //     console.log("📤 Sending set-max-cycle:", intervalMin);
    //     recorderWindow?.postMessage({ type: 'set-max-cycle', value: intervalMin }, '*');

    //     window.removeEventListener('message', handler);
    //   }
    // });

    
    openBtn.onclick = async () => {
      sessionId = Date.now().toString();

  //  获取用户输入分钟数
      const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);

  //  发送 set_cycle 指令到 Supabase
  try {
    await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
      method: 'POST',
      headers: {
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({
        session_id: sessionId,
        command: 'set_cycle',
        value: intervalMin
      })
    });

    console.log("✅ Sent set_cycle to Supabase:", intervalMin);
  } catch (err) {
    console.error("❌ Failed to send set_cycle:", err);
  }

  //  打开 recorder 页面
  recorderWindow = window.open(
    `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
    'recorder',
    'width=500,height=400'
  );

  poll(sessionId);
};

// const pdfInput = document.getElementById('pdfInput');
// const pdfStatus = document.getElementById('pdfStatus');

// pdfInput.addEventListener('change', async (e) => {
//   const file = e.target.files?.[0];
//   if (!file) return;

//   pdfStatus.textContent = "⏳ Extracting text from PDF...";
//   try {
//     const form = new FormData();
//     form.append('file', file, file.name);
//     const res = await fetch('https://fyp-2025-kath.vercel.app/api/ingest_pdf', {
//       method: 'POST',
//       body: form
//     });
//     const data = await res.json();
//     if (!res.ok || !data?.text) {
//       pdfStatus.textContent = "❌ Failed to read PDF.";
//       return;
//     }
//     pdfTextCache = data.text;
//     pdfStatus.textContent = `✅ PDF loaded (${(data.text.length/1000).toFixed(1)}k chars)`;

//     // 如果录音窗口已打开，把 PDF 文本传给它
//     if (recorderWindow) {
//       recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, '*');
//     }
//   } catch (err) {
//     console.error("❌ PDF upload/parse error:", err);
//     pdfStatus.textContent = "❌ PDF parse error.";
//   }
// });

const pdfInput = document.getElementById('pdfInput');
    const pdfStatus = document.getElementById('pdfStatus'); // 可选的状态文本

    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      pdfStatus && (pdfStatus.textContent = "⏳ Extracting text from PDF (client-side)...");
      try {
        const arrayBuffer = await file.arrayBuffer();

        // pdf.js 前端解析
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const text = content.items.map(item => item.str).join(' ');
          fullText += text + '\n';
        }

        // 简单清洗，避免过长空白
        pdfTextCache = fullText.replace(/\n{3,}/g, '\n\n').trim();
        pdfStatus && (pdfStatus.textContent = `✅ PDF loaded (${(pdfTextCache.length/1000).toFixed(1)}k chars)`);

        // 若 recorder 窗口已打开，立刻发送
        if (recorderWindow && !recorderWindow.closed) {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }
      } catch (err) {
        console.error("❌ PDF parse error:", err);
        pdfStatus && (pdfStatus.textContent = "❌ PDF parse error.");
      }
    });

    // recorder 准备好时，补发一次 PDF 文本（防止顺序问题）
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'ready-to-record' && pdfTextCache) {
        const targetOrigin = 'https://fyp-2025-kath.vercel.app';
        recorderWindow?.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, targetOrigin);
      }
    });

    stopBtn.onclick = async () => {
      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ session_id: sessionId, command: 'stop' })
      });
    };

    function poll(sessionId) {
       const container = document.getElementById('cardsContainer');
      // container.id = 'cardsContainer';
      // document.body.appendChild(container);

      setInterval(async () => {
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}&order=created_at.desc&limit=1`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A ',
              'Content-Type': 'application/json'
            }
          });
          const data = await res.json();
          const item = data?.[0];
          if (item && item.summary && item.summary !== lastShownSummary) {
            const card = document.createElement('div');
            card.className = 'card';
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';
            const summaryHeader = document.createElement('h3');
            summaryHeader.textContent = ' Summary';
            summaryHeader.appendChild(toggleBtn);

            const summaryPara = document.createElement('p');
            summaryPara.textContent = item.summary;

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `
              <h4>📌 Decision</h4><ul>${(item.decision || []).map(d => `<li>${d}</li>`).join('')}</ul>
              <h4>💡 Explicit</h4><ul>${(item.explicit || []).map(e => `<li>${e}</li>`).join('')}</ul>
              <h4>💡 Tacit</h4><ul>${(item.tacit || []).map(t => `<li>${t}</li>`).join('')}</ul>
              <h4>🧠 Reasoning</h4><p>${item.reasoning || ''}</p>
              <h4>🔗 Suggestions</h4><ul>${(item.suggestions || []).map(s => `<li>${s}</li>`).join('')}</ul>
            `;

             toggleBtn.onclick = () => {
              const isShown = details.style.display === 'block';
              details.style.display = isShown ? 'none' : 'block';
              toggleBtn.textContent = isShown ? '+' : '−';
            };

            card.appendChild(summaryHeader);
            card.appendChild(summaryPara);
            card.appendChild(details);
            container.prepend(card);
            
            
            // card.innerHTML = `<h3>🧠 Summary</h3><p>${item.summary}</p>`;

            // container.prepend(card);
            
            
            //resultBox.prepend(card);

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary,
                decision: item.decision,
                explicit: item.explicit,
                tacit: item.tacit,
                reasoning: item.reasoning,
                suggestions: item.suggestions
              }
            }, '*');

            lastShownSummary = item.summary;
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 2000);
    }
  </script>
</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }
    .card {
      background: #f3f3f3;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
    }
    .card button.toggle-btn {
      float: right;
      font-size: 18px;
      border: none;
      background: none;
      cursor: pointer;
    }
    .details {
      display: none;
      margin-top: 10px;
    }

    button {
      padding: 10px 18px;
      margin: 8px 8px 16px 0;
      font-weight: bold;
      margin-right: 6px;
    }
    #spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid #ccc;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <label style="display:block; margin:8px 0 4px;">📄 Add Context (optional):</label>
  <div style="display: flex; gap: 10px; margin-bottom: 8px;">
    <button id="pdfBtn" style="padding: 6px 12px; margin: 0;">Upload PDF</button>
    <button id="textBtn" style="padding: 6px 12px; margin: 0;">Paste Text</button>
  </div>
  <input id="pdfInput" type="file" accept="application/pdf" style="display: none;" />
  <textarea id="contextText" placeholder="Paste your project documentation or context here..." 
           style="width: 100%; height: 100px; display: none; margin-bottom: 8px;"></textarea>
  <small id="pdfStatus" style="display:block; color:#666; margin-bottom:12px;"></small>

  <label for="cycleInput">⏱️ Summary interval (minutes):</label>
  <input id="cycleInput" type="number" value="5" min="1" style="width: 60px; margin-left: 8px; margin-bottom: 12px;" />
  <br><br>

  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

   <div id="cardsContainer"></div>
  
  <script>
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    let sessionId = null;
    let lastShownSummary = '';
    let recorderWindow = null;
    let pdfTextCache = "";
    let pdfFileName = '';

    openBtn.onclick = async () => {
      sessionId = Date.now().toString();

      const intervalMin = parseInt(document.getElementById('cycleInput').value || '5', 10);

      try {
        await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
          method: 'POST',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            session_id: sessionId,
            command: 'set_cycle',
            value: intervalMin
          })
        });

        console.log("✅ Sent set_cycle to Supabase:", intervalMin);
      } catch (err) {
        console.error("❌ Failed to send set_cycle:", err);
      }

      // 🆕 新增：如果有PDF内容，保存到Supabase
if (pdfTextCache) {
  try {
    console.log('📚 保存PDF内容到Supabase...');
    const pdfRes = await fetch('https://fyp-2025-kath.vercel.app/api/save_pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: sessionId,
        pdf_text: pdfTextCache,
        filename: pdfFileName || 'context.pdf'
      })
    });

    console.log('📊 save_pdf响应状态:', pdfRes.status); // 添加这行

    if (pdfRes.ok) {
      console.log('✅ PDF内容已保存到Supabase');
      pdfStatus.textContent += ' (已保存到会话)';
    } else {
      const errorText = await pdfRes.text();
      console.error('❌ PDF保存失败 - 状态码:', pdfRes.status);
      console.error('❌ 错误详情:', errorText);
    }
  } catch (err) {
    console.error('❌ PDF保存异常:', err);
  }
}



      recorderWindow = window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );

      // Send PDF text if already loaded
      if (pdfTextCache && recorderWindow) {
        setTimeout(() => {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }, 1000);
      }

      poll(sessionId);
    };

    const pdfBtn = document.getElementById('pdfBtn');
    const textBtn = document.getElementById('textBtn');
    const pdfInput = document.getElementById('pdfInput');
    const contextText = document.getElementById('contextText');
    const pdfStatus = document.getElementById('pdfStatus');

    // Toggle between PDF upload and text paste
    pdfBtn.onclick = () => {
      pdfInput.style.display = 'block';
      contextText.style.display = 'none';
      pdfInput.click(); // Auto-open file picker
    };

    textBtn.onclick = () => {
      contextText.style.display = 'block';
      pdfInput.style.display = 'none';
      pdfStatus.textContent = 'Type or paste your context below';
    };

    // Handle text input
    contextText.addEventListener('input', (e) => {
      pdfTextCache = e.target.value;
      pdfStatus.textContent = `✅ Text added (${(pdfTextCache.length/1000).toFixed(1)}k chars)`;
      
      // Send to recorder window if open
      if (recorderWindow && !recorderWindow.closed) {
        recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
      }
    });

    // Use server-side PDF processing with fallback
    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      pdfFileName = file.name; // 🆕 存储文件名

      pdfStatus.textContent = "⏳ Extracting text from PDF...";
      
      try {
        // Create FormData and send to your API
        const formData = new FormData();
        formData.append('file', file, file.name);
        
        const res = await fetch('https://fyp-2025-kath.vercel.app/api/ingest_pdf', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        
        if (data?.error) {
          // If PDF extraction failed, show text input as fallback
          contextText.style.display = 'block';
          pdfStatus.textContent = "⚠️ Could not extract PDF text. Please paste the content manually.";
          return;
        }
        
        if (!data?.text) {
          throw new Error("No text extracted from PDF");
        }
        
        pdfTextCache = data.text;
        pdfStatus.textContent = `✅ PDF loaded (${(pdfTextCache.length/1000).toFixed(1)}k chars)`;

        // Send to recorder window if open
        if (recorderWindow && !recorderWindow.closed) {
          recorderWindow.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, 'https://fyp-2025-kath.vercel.app');
        }
      } catch (err) {
        console.error("❌ PDF processing error:", err);
        // Show text input as fallback
        contextText.style.display = 'block';
        pdfStatus.textContent = "❌ PDF upload failed. Please paste the text instead.";
      }
    });

    // Send PDF context when recorder is ready
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'ready-to-record' && pdfTextCache) {
        const targetOrigin = 'https://fyp-2025-kath.vercel.app';
        recorderWindow?.postMessage({ type: 'set-context-pdf', text: pdfTextCache }, targetOrigin);
      }
    });

    stopBtn.onclick = async () => {
      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ session_id: sessionId, command: 'stop' })
      });
    };

    function poll(sessionId) {
      const container = document.getElementById('cardsContainer');

      setInterval(async () => {
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}&order=created_at.desc&limit=1`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A ',
              'Content-Type': 'application/json'
            }
          });
          const data = await res.json();
          const item = data?.[0];
          if (item && item.summary && item.summary !== lastShownSummary) {
            const card = document.createElement('div');
            card.className = 'card';
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';
            const summaryHeader = document.createElement('h3');
            summaryHeader.textContent = ' Summary';
            summaryHeader.appendChild(toggleBtn);

            const summaryPara = document.createElement('p');
            summaryPara.textContent = item.summary;

            const details = document.createElement('div');
            details.className = 'details';
            details.innerHTML = `
              <h4>📌 Decision</h4><ul>${(item.decision || []).map(d => `<li>${d}</li>`).join('')}</ul>
              <h4>💡 Explicit</h4><ul>${(item.explicit || []).map(e => `<li>${e}</li>`).join('')}</ul>
              <h4>💡 Tacit</h4><ul>${(item.tacit || []).map(t => `<li>${t}</li>`).join('')}</ul>
              <h4>🧠 Reasoning</h4><p>${item.reasoning || ''}</p>
              <h4>🔗 Suggestions</h4><ul>${(item.suggestions || []).map(s => `<li>${s}</li>`).join('')}</ul>
            `;

            toggleBtn.onclick = () => {
              const isShown = details.style.display === 'block';
              details.style.display = isShown ? 'none' : 'block';
              toggleBtn.textContent = isShown ? '+' : '−';
            };

            card.appendChild(summaryHeader);
            card.appendChild(summaryPara);
            card.appendChild(details);
            container.prepend(card);

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary,
                decision: item.decision,
                explicit: item.explicit,
                tacit: item.tacit,
                reasoning: item.reasoning,
                suggestions: item.suggestions
              }
            }, '*');

            lastShownSummary = item.summary;
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 2000);
    }
  </script>
</body>
</html> -->


<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 300px; overflow-y: auto; margin-top: 12px; }
    button { padding: 8px 16px; font-weight: bold; margin-right: 8px; }
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <button id="stopBtn">Stop Recording</button>

  <div id="result">⏳ Waiting for result...</div>

  <script>

    
    const openBtn = document.getElementById('openBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resultBox = document.getElementById('result');
    
    //let recorderWindow = null;
    let ready = false;
    let sessionId = null; 

    openBtn.onclick = () => {
      sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      ready = false;
      poll(sessionId);
    };

    stopBtn.onclick = async () => {
      console.log("🛑 stop button clicked");

      await fetch('https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/control_signals', {
        method: 'POST',
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          session_id: sessionId,
          command: 'stop'
        })
      });
      console.log("✅ stop command sent to Supabase");
    };


    window.addEventListener('message', (event) => {
      const msg = event.data;

      if (msg?.type === 'ready-to-record') {
        ready = true;
        console.log("✅ Recorder window is ready");
      }

      if (msg?.pluginMessage?.type === 'analyze-transcript') {
        const { transcript, summary } = msg.pluginMessage;
        resultBox.textContent = `📝 Transcript:\n${transcript}\n\n🧠 Summary:\n${summary}`;

        parent.postMessage({
          pluginMessage: {
            type: 'analyze-transcript',
            transcript,
            summary
          }
        }, '*');
      }
    });

    let lastFetchedTime = null;

    function poll(sessionId) {
      const interval = setInterval(async () => {
        console.log('polling summary');
        try {
          const res = await fetch(`https://cwhekhkphzcovivgqezd.supabase.co/rest/v1/sessions?session_id=eq.${sessionId}`, {
            headers: {
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aGVraGtwaHpjb3ZpdmdxZXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjgyNjgsImV4cCI6MjA2MzU0NDI2OH0.hmZt6bFgKSWel6HiXfEjmm85P_j8fcsUo71hVWmkF2A',
              'Content-Type': 'application/json'
            }
          });

          const data = await res.json();
          //console.log("📥 Got from Supabase:", data);
          const newItems = data.filter(item =>
            item.created_at && (!lastFetchedTime || new Date(item.created_at) > new Date(lastFetchedTime))
          );

          for (const item of newItems) {
            lastFetchedTime = item.created_at;

            // 👇 更新 UI 文本框
            resultBox.textContent = `📝 Transcript:\n${item.transcript}\n\n🧠 Summary:\n${item.summary}`;

            // 👇 发回 Figma 插件
           

          // if (Array.isArray(data) && data.length > 0 && data[0].summary) {
          //   clearInterval(interval);

          //   const item = data[0];
          //   resultBox.textContent = `📝 Transcript:\n${item.transcript}\n\n🧠 Summary:\n${item.summary}`;

            parent.postMessage({
              pluginMessage: {
                type: 'analyze-transcript',
                transcript: item.transcript,
                summary: item.summary
              }
            }, '*');
          }
        } catch (err) {
          console.error("❌ Supabase polling failed:", err);
        }
      }, 1000);
    }

      

    // function sendTest() {
    //   console.log("📤 Sending TEST message...");
    //   parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
    // }
  </script>
</body>
</html> -->




<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 12px; height: 200px; overflow-y: auto; }
    button { padding: 8px 16px; font-weight: bold; }
    
  </style>
</head>
<body>
  <h2>🎤 Analyze Meeting</h2>
  <button id="openBtn">Open Recorder</button>
  <div id="result">⏳ Waiting for result...</div>
  <button onclick="sendTest()">Send Test Message</button>

  <script>
  //   function sendTest() {
  //   console.log("📤 Sending TEST message...");
  //   parent.postMessage({ pluginMessage: { type: 'test', message: 'Hello Figma from UI!' } }, '*');
  // }
    
    const openBtn = document.getElementById('openBtn');
    const resultBox = document.getElementById('result');

    openBtn.onclick = () => {
      const sessionId = Date.now().toString();
      window.open(
        `https://fyp-2025-kath.vercel.app/record.html?session=${sessionId}&start=true`,
        'recorder',
        'width=500,height=400'
      );
      poll(sessionId);
    };

    function poll(sessionId) {
      const interval = setInterval(async () => {
        const res = await fetch(`https://fyp-2025-kath.vercel.app/api/get?session=${sessionId}`);
        const data = await res.json();
        if (data.summary) {
          clearInterval(interval);
          console.log("📥 Got result:", data);

          resultBox.textContent = `📝 Transcript:\n${data.transcript}\n\n🧠 Summary:\n${data.summary}`;

          console.log("📤 Sending pluginMessage...", { transcript, summary });

          // 通知插件主线程插入文字
          parent.postMessage({
            pluginMessage: {
              type: 'analyze-transcript',
              transcript: data.transcript,
              summary: data.summary
            }
          }, '*');
        }
      }, 1000);
    }
  </script>
</body>
</html> -->
